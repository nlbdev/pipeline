<?xml version="1.0" encoding="UTF-8"?>
<?xml-model href="http://www.daisy.org/ns/xprocspec/xprocspec.rng" type="application/xml" schematypens="http://relaxng.org/ns/structure/1.0"?>
<x:description xmlns:x="http://www.daisy.org/ns/xprocspec"
    xmlns:nlb="http://www.nlb.no/ns/pipeline/xproc"
    xmlns:pef="http://www.daisy.org/ns/2008/pef"
    script="http://www.nlb.no/pipeline/modules/braille/dtbook-to-pef.xpl">
    
    <!--
        Notes for writing tests:
        - Don't use a too low `maximum-number-of-pages` (use at least 4); you may get an error if the script tries to insert a TOC and there's not enough room for it.
        - Don't override the default `page-height` of 28, or at least don't set it too low; The NLB-stylesheet contains rules that depend on the page height (i.e. -obfl-vertical-position: 25;) which may give an error.
        - All volumes will start with a titlepage. The first volume will also contain an about page.
        - If the input contains headlines, then at least 1 toc page will be generated.
        - Using the default `page-height` of 28, a `maximum-number-of-pages` of 8, and no toc (toc-depth=0), there will be 6 braille pages with 168 rows in the first volume, and 7 braille pages with 196 rows, available for content. 
    -->
    
    <x:scenario label="_">
        <x:call step="nlb:dtbook-to-pef">
            <x:option name="show-print-page-numbers" select="'false'"/>
            <x:option name="show-braille-page-numbers" select="'false'"/>
            <x:option name="toc-depth" select="0"/>
            <x:option name="maximum-number-of-pages" select="8"/>
        </x:call>
        
        <x:scenario label="If a book consist of more than the set max page number, it must be split into volumes: seeking a balanced page number between these volumes">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook version="2005-3" xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no">
                            <book>
                                <bodymatter>
                                    <level1>
                                        <h1>big</h1>
                                        
                                        <!-- 190 paragraphs -->
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                    </level1>
                                </bodymatter>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('1/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('1/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('1/temp-dir',$temp-dir)"/>
            </x:call>
            <x:context label="result">
                <x:document type="file" base-uri="temp-dir" href="1/pef-output-dir/book.pef" />
            </x:context>
            <x:expect label="190 short paragraphs, default page height (28) and max pages 8 (1 volume = 8 pages - 1 titlepage - 1 aboutpage), should become 2 volumes" type="xpath" test="count(//pef:volume[.//pef:row[contains(text(),'⠉⠕⠝⠞⠑⠝⠞')]])" equals="2"/>
            <x:expect label="At least 20% of the content rows should be in the first bodymatter volume" type="xpath" test="count((//pef:volume[.//pef:row[contains(text(),'⠉⠕⠝⠞⠑⠝⠞')]])[1]//pef:row[contains(text(),'⠉⠕⠝⠞⠑⠝⠞')]) div count(//pef:row[contains(text(),'⠉⠕⠝⠞⠑⠝⠞')]) &gt; 0.2" equals="true()"/>
            <x:expect label="At least 20% of the content rows should be in the second bodymatter volume" type="xpath" test="count((//pef:volume[.//pef:row[contains(text(),'⠉⠕⠝⠞⠑⠝⠞')]])[2]//pef:row[contains(text(),'⠉⠕⠝⠞⠑⠝⠞')]) div count(//pef:row[contains(text(),'⠉⠕⠝⠞⠑⠝⠞')]) &gt; 0.2" equals="true()"/>
        </x:scenario>
        
        <x:scenario label="with parts: parts will be top level splitting points">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook version="2005-3" xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no">
                            <book>
                                <bodymatter>
                                    <level1 class="part">
                                        <p>content</p>
                                    </level1>
                                    <level1 class="part">
                                        <p>content</p>
                                    </level1>
                                </bodymatter>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('2/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('2/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('2/temp-dir',$temp-dir)"/>
            </x:call>
            <x:context label="result">
                <x:document type="file" base-uri="temp-dir" href="2/pef-output-dir/book.pef" />
            </x:context>
            <x:expect label="2 short paragraphs, but in different book 'parts', should become 2 volumes" type="xpath" test="count(//pef:volume[.//pef:row[contains(text(),'⠉⠕⠝⠞⠑⠝⠞')]])" equals="2"/>
        </x:scenario>
        
        <x:scenario label="with parts: don't force a volume break before the first part">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook version="2005-3" xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no">
                            <book>
                                <frontmatter>
                                    <doctitle>doctitle</doctitle>
                                    <docauthor>docauthor</docauthor>
                                </frontmatter>
                                <bodymatter>
                                    <level1 class="part">
                                        <p>content</p>
                                    </level1>
                                </bodymatter>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('3/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('3/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('3/temp-dir',$temp-dir)"/>
            </x:call>
            <x:context label="result">
                <x:document type="file" base-uri="temp-dir" href="3/pef-output-dir/book.pef" />
            </x:context>
            <x:expect label="everything should fit in a single volume" type="xpath" test="count(//pef:volume)" equals="1"/>
        </x:scenario>
        
        <x:scenario label="with parts: fit small chapters in same volume, medium chapters in separate volume, and big chapters in multiple volumes">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook version="2005-3" xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no">
                            <book>
                                <bodymatter>
                                    <level1 class="part">
                                        <!-- small chapter -->
                                        <level2>
                                            <h2>small</h2>
                                            
                                            <!-- 50 paragraphs -->
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        </level2>
                                        
                                        <!-- small chapter -->
                                        <level2>
                                            <h2>small</h2>
                                            
                                            <!-- 50 paragraphs -->
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        </level2>
                                    </level1>
                                    <level1 class="part">
                                        <!-- medium chapter -->
                                        <level2>
                                            <h2>medium</h2>
                                            
                                            <!-- 140 paragraphs -->
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        </level2>
                                        
                                        <!-- medium chapter -->
                                        <level2>
                                            <h2>medium</h2>
                                            
                                            <!-- 140 paragraphs -->
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        </level2>
                                    </level1>
                                    <level1 class="part">
                                        <!-- big chapter -->
                                        <level2>
                                            <h2>big</h2>
                                            
                                            <!-- 250 paragraphs -->
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        </level2>
                                        
                                        <!-- big chapter -->
                                        <level2>
                                            <h2>big</h2>
                                            
                                            <!-- 250 paragraphs -->
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        </level2>
                                    </level1>
                                </bodymatter>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('4/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('4/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('4/temp-dir',$temp-dir)"/>
            </x:call>
            <x:context label="result">
                <x:document type="file" base-uri="temp-dir" href="4/pef-output-dir/book.pef" />
            </x:context>
            <x:expect label="1 volume with 2 small chapters" type="xpath" test="count(//pef:volume[.//pef:row[contains(text(),'⠎⠍⠁⠇⠇')]])" equals="1"/>
            <x:expect label="2 volumes with 1 medium chapter each" type="xpath" test="count(//pef:volume[.//pef:row[contains(text(),'⠍⠑⠙⠊⠥⠍')]])" equals="2"/>
            <x:expect label="2 big chapters spread across 4 volumes" type="xpath" test="count(//pef:volume[.//pef:row[contains(text(),'⠉⠕⠝⠞⠑⠝⠞')] and not(.//pef:row[contains(text(),'⠎⠍⠁⠇⠇')]) and not(.//pef:row[contains(text(),'⠍⠑⠙⠊⠥⠍')])])" equals="4"/>
            <x:expect label="a total of 7 volumes" type="xpath" test="count(//pef:volume[.//pef:row[contains(text(),'⠉⠕⠝⠞⠑⠝⠞')]])" equals="7"/>
        </x:scenario>
        
        <x:scenario label="regression test: volume division fails with maximum-number-of-pages = 8 and 81 headlines">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook version="2005-3" xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no">
                            <book>
                                <bodymatter>
                                    <level1>
                                        <!-- 81 headlines -->
                                        <h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1>
                                        <h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1>
                                        <h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1>
                                        <h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1>
                                        <h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1>
                                        <h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1>
                                        <h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1>
                                        <h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1><h1>content</h1>
                                        <h1>content</h1>
                                    </level1>
                                </bodymatter>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('5/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('5/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('5/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="result">
                <x:document type="file" base-uri="temp-dir" href="5/pef-output-dir/book.pef"/>
            </x:context>
            <x:expect label="The PEF should be generated" type="count" min="1"/>
        </x:scenario>
        
        <x:scenario label="prefer splitting at lower level headings" pending="https://github.com/nlbdev/pipeline/issues/119">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook version="2005-3" xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no">
                            <book>
                                <bodymatter>
                                    <level1 class="part">
                                        <h1>content h1</h1>
                                        
                                        <!-- 240 paragraphs -->
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <level2>
                                            <h2>content h2</h2>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        </level2>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        
                                    </level1>
                                    <level1 class="part">
                                        <h1>content h1</h1>
                                        
                                        <!-- 240 paragraphs -->
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <level2>
                                            <h2>content h2</h2>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <level3>
                                                <h3>content h3</h3>
                                                <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                                <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                                <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            </level3>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        </level2>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        
                                    </level1>
                                    <level1 class="part">
                                        <h1>content h1</h1>
                                        
                                        <!-- 240 paragraphs -->
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <level2>
                                            <h2>content h2</h2>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <level3>
                                                <h3>content h3</h3>
                                                <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                                <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                                <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                                <level4>
                                                    <h4>content h4</h4>
                                                    <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                                    <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                                    <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                                </level4>
                                                <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            </level3>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        </level2>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        
                                    </level1>
                                    <level1 class="part">
                                        <h1>content h1</h1>
                                        
                                        <!-- 240 paragraphs -->
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <level2>
                                            <h2>content h2</h2>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <level3>
                                                <h3>content h3</h3>
                                                <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                                <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                                <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                                <level4>
                                                    <h4>content h4</h4>
                                                    <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                                    <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                                    <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                                    <level5>
                                                        <h5>content h5</h5>
                                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                                    </level5>
                                                    <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                                </level4>
                                                <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            </level3>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        </level2>
                                        
                                    </level1>
                                    <level1 class="part">
                                        <h1>content h1</h1>
                                        
                                        <!-- 240 paragraphs -->
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        <level2>
                                            <h2>content h2</h2>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <level3>
                                                <h3>content h3</h3>
                                                <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                                <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                                <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                                <level4>
                                                    <h4>content h4</h4>
                                                    <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                                    <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                                    <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                                    <level5>
                                                        <h5>content h5</h5>
                                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                                        <level6>
                                                            <h6>content h6</h6>
                                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                                        </level6>
                                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                                    </level5>
                                                    <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                                </level4>
                                                <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            </level3>
                                        </level2>
                                    </level1>
                                </bodymatter>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('6/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('6/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('6/temp-dir',$temp-dir)"/>
            </x:call>
            <x:context label="result">
                <x:document type="file" base-uri="temp-dir" href="6/pef-output-dir/book.pef" />
            </x:context>
            <x:expect label="There should be 10 volumes with bodymatter content" type="xpath" test="count(//pef:volume[.//pef:row[contains(text(),'⠉⠕⠝⠞⠑⠝⠞')]])" equals="10"/>
            <x:expect label="The first part should have a volume break right before h2" type="xpath" test="((//pef:volume[.//pef:row[contains(text(),'⠉⠕⠝⠞⠑⠝⠞')]])[2]//pef:row[contains(text(),'⠉⠕⠝⠞⠑⠝⠞')])[1]/replace(text(),'(^⠀+|⠀+$)','') = '⠉⠕⠝⠞⠑⠝⠞⠀⠓⠼⠃'" equals="true()"/>
            <x:expect label="The second part should have a volume break right before h3" type="xpath" test="((//pef:volume[.//pef:row[contains(text(),'⠉⠕⠝⠞⠑⠝⠞')]])[2]//pef:row[contains(text(),'⠉⠕⠝⠞⠑⠝⠞')])[1]/replace(text(),'(^⠀+|⠀+$)','') = '⠉⠕⠝⠞⠑⠝⠞⠀⠓⠼⠉'" equals="true()"/>
            <x:expect label="The third part should have a volume break right before h4" type="xpath" test="((//pef:volume[.//pef:row[contains(text(),'⠉⠕⠝⠞⠑⠝⠞')]])[2]//pef:row[contains(text(),'⠉⠕⠝⠞⠑⠝⠞')])[1]/replace(text(),'(^⠀+|⠀+$)','') = '⠉⠕⠝⠞⠑⠝⠞⠀⠓⠼⠙'" equals="true()"/>
            <x:expect label="The fourth part should have a volume break right before h5" type="xpath" test="((//pef:volume[.//pef:row[contains(text(),'⠉⠕⠝⠞⠑⠝⠞')]])[2]//pef:row[contains(text(),'⠉⠕⠝⠞⠑⠝⠞')])[1]/replace(text(),'(^⠀+|⠀+$)','') = '⠉⠕⠝⠞⠑⠝⠞⠀⠓⠼⠑'" equals="true()"/>
            <x:expect label="The fifth part should have a volume break right before h6" type="xpath" test="((//pef:volume[.//pef:row[contains(text(),'⠉⠕⠝⠞⠑⠝⠞')]])[2]//pef:row[contains(text(),'⠉⠕⠝⠞⠑⠝⠞')])[1]/replace(text(),'(^⠀+|⠀+$)','') = '⠉⠕⠝⠞⠑⠝⠞⠀⠓⠼⠋'" equals="true()"/>
        </x:scenario>
        
        <x:scenario label="paragraph with inline elements: don't split volumes inside a paragraph; unless necessary" pending="https://github.com/nlbdev/pipeline/issues/86">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook version="2005-3" xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no">
                            <book>
                                <bodymatter>
                                    <level1 class="part">
                                        <p>Volume with frontmatter</p>
                                    </level1>
                                    <level1 class="part">
                                        <!-- 300 occurences of "content" -->
                                        <p>
                                            <span>1</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                        </p>
                                        
                                        <!-- 300 occurences of "content" -->
                                        <p>
                                            <span>2</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                        </p>
                                    </level1>
                                    <level1 class="part">
                                        <!-- 800 occurences of "content" -->
                                        <p>
                                            <span>3</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                            <span>content content content content content content content content content content content content content content content content content content content content</span>
                                        </p>
                                    </level1>
                                </bodymatter>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('7/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('7/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('7/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="result">
                <x:document type="file" base-uri="temp-dir" href="7/pef-output-dir/book.pef"/>
            </x:context>
            <x:expect label="There should be 5 volumes" type="xpath" test="count(//pef:volume)" equals="5"/>
            <x:expect label="The second volume should have 500 occurences of 'content'" type="xpath" test="count((//pef:volume)[2]/tokenize(string-join(.//text(),' '),'⠉⠕⠝⠞⠑⠝⠞')) - 1" equals="500"/>
            <x:expect label="The third volume should have 500 occurences of 'content'" type="xpath" test="count((//pef:volume)[3]/tokenize(string-join(.//text(),' '),'⠉⠕⠝⠞⠑⠝⠞')) - 1" equals="500"/>
            <x:expect label="The fourth volume should have at least 1 occurence of 'content'" type="xpath" test="contains((//pef:volume)[4]/string-join(.//text(),' '),'⠉⠕⠝⠞⠑⠝⠞')" equals="true()"/>
            <x:expect label="The fifth volume should have at least 1 occurence of 'content'" type="xpath" test="contains((//pef:volume)[5]/string-join(.//text(),' '),'⠉⠕⠝⠞⠑⠝⠞')" equals="true()"/>
        </x:scenario>
        
        <x:scenario label="paragraph without inline elements: don't split volumes inside a paragraph; unless necessary" pending="https://github.com/nlbdev/pipeline/issues/86">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook version="2005-3" xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no">
                            <book>
                                <bodymatter>
                                    <level1 class="part">
                                        <p>Volume with frontmatter</p>
                                    </level1>
                                    <level1 class="part">
                                        <!-- 300 occurences of "content" -->
                                        <p><![CDATA[
                                            1
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                        ]]></p>
                                        
                                        <!-- 300 occurences of "content" -->
                                        <p><![CDATA[
                                            2
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                        ]]></p>
                                    </level1>
                                    <level1 class="part">
                                        <!-- 800 occurences of "content" -->
                                        <p><![CDATA[
                                            3
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                            content content content content content content content content content content content content content content content content content content content content
                                        ]]></p>
                                    </level1>
                                </bodymatter>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('8/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('8/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('8/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="result">
                <x:document type="file" base-uri="temp-dir" href="8/pef-output-dir/book.pef"/>
            </x:context>
            <x:expect label="There should be 5 volumes" type="xpath" test="count(//pef:volume)" equals="5"/>
            <x:expect label="The second volume should have 500 occurences of 'content'" type="xpath" test="count((//pef:volume)[2]/tokenize(string-join(.//text(),' '),'⠉⠕⠝⠞⠑⠝⠞')) - 1" equals="500"/>
            <x:expect label="The third volume should have 500 occurences of 'content'" type="xpath" test="count((//pef:volume)[3]/tokenize(string-join(.//text(),' '),'⠉⠕⠝⠞⠑⠝⠞')) - 1" equals="500"/>
            <x:expect label="The fourth volume should have at least 1 occurence of 'content'" type="xpath" test="contains((//pef:volume)[4]/string-join(.//text(),' '),'⠉⠕⠝⠞⠑⠝⠞')" equals="true()"/>
            <x:expect label="The fifth volume should have at least 1 occurence of 'content'" type="xpath" test="contains((//pef:volume)[5]/string-join(.//text(),' '),'⠉⠕⠝⠞⠑⠝⠞')" equals="true()"/>
        </x:scenario>
        
        <x:scenario label="Content at start of part (or chapter) should be in same volume as first descendant chapter (or subchapter)" pending="https://github.com/nlbdev/pipeline/issues/88">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook version="2005-3" xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no">
                            <book>
                                <bodymatter>
                                    <level1 class="part">
                                        <h1>content h1</h1>
                                        
                                        <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        
                                        <!-- 190 paragraphs -->
                                        <level2>
                                            <h2>content h2</h2>
                                            
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                            <p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p><p>content</p>
                                        </level2>
                                    </level1>
                                </bodymatter>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="include-obfl" select="'true'"/>
                <x:option name="pef-output-dir" select="resolve-uri('9/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('9/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('9/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="result">
                <x:document type="file" base-uri="temp-dir" href="9/pef-output-dir/book.pef"/>
            </x:context>
            <x:expect label="There should be 3 volumes" type="xpath" test="count(//pef:volume)" equals="3"/>
            <x:expect label="The part headline should be in the second volume" type="xpath" test="count(//pef:row[contains(.,'⠉⠕⠝⠞⠑⠝⠞⠀⠓⠼⠁')]/preceding::pef:volume)+1" equals="2"/>
            <x:expect label="The chapter headline should be in the second volume" type="xpath" test="count(//pef:row[contains(.,'⠉⠕⠝⠞⠑⠝⠞⠀⠓⠼⠃')]/preceding::pef:volume)+1" equals="2"/>
        </x:scenario>
        
    </x:scenario>
</x:description>
