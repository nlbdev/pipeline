<?xml version="1.0" encoding="UTF-8"?>
<?xml-model href="http://www.daisy.org/ns/xprocspec/xprocspec.rng" type="application/xml" schematypens="http://relaxng.org/ns/structure/1.0"?>
<x:description xmlns:x="http://www.daisy.org/ns/xprocspec"
    xmlns:p="http://www.w3.org/ns/xproc"
    xmlns:px="http://www.daisy.org/ns/pipeline/xproc"
    xmlns:nlb="http://www.nlb.no/ns/pipeline/xproc"
    xmlns:pef="http://www.daisy.org/ns/2008/pef"
    script="http://www.nlb.no/pipeline/modules/braille/dtbook-to-pef.xpl">
    
    <x:scenario label="toc-depth">
        <x:call step="nlb:dtbook-to-pef">
            <x:input port="source">
                <x:document type="inline" xml:base="file:/tmp/book.xml">
                    <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                        <book>
                            <bodymatter>
                                <level1>
                                    <h1>h1 a</h1>
                                    <p>blabla</p>
                                    <level2>
                                        <h2>h2 a</h2>
                                        <p>blabla</p>
                                        <level3>
                                            <h3>h3 a</h3>
                                            <p>blabla</p>
                                        </level3>
                                    </level2>
                                </level1>
                                <level1>
                                    <h1>h1 b</h1>
                                    <p>blabla</p>
                                </level1>
                            </bodymatter>
                        </book>
                    </dtbook>
                </x:document>
            </x:input>
            <x:option name="braille-standard" select="'(dots:6)(grade:0)'"/>
            <x:option name="toc-depth" select="2"/>
            <x:option name="pef-output-dir" select="resolve-uri('1/pef-output-dir',$temp-dir)"/>
            <x:option name="preview-output-dir" select="resolve-uri('1/preview-output-dir',$temp-dir)"/>
            <x:option name="temp-dir" select="resolve-uri('1/temp-dir',$temp-dir)"/>
        </x:call>
        <x:context label="result">
            <x:document type="file" base-uri="temp-dir" href="1/pef-output-dir/book.pef" select="(//pef:section)[not(position() = (1,3))]"/>
        </x:context>
        <x:expect label="result" type="compare">
            <x:document type="inline" select="/*/*">
                <_ xmlns="http://www.daisy.org/ns/2008/pef">
                        <section>
                            <page>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠓⠼⠁⠀⠁⠀⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠀⠼⠁</row>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠓⠼⠃⠀⠁⠀⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠀⠼⠁</row>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠓⠼⠁⠀⠃⠀⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠀⠼⠉</row>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                            </page>
                        </section>
                        <section>
                            <page>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠓⠼⠁⠀⠁</row>
                                <row>⠀⠀⠀⠀⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row/>
                                <row>⠀⠀⠀⠀⠃⠇⠁⠃⠇⠁</row>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠓⠼⠃⠀⠁</row>
                                <row/>
                                <row>⠀⠀⠀⠀⠃⠇⠁⠃⠇⠁</row>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠓⠼⠉⠀⠁</row>
                                <row>⠀⠀⠀⠀⠃⠇⠁⠃⠇⠁</row>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                            </page>
                        </section>
                        <section>
                            <page>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠓⠼⠁⠀⠃</row>
                                <row>⠀⠀⠀⠀⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row/>
                                <row>⠀⠀⠀⠀⠃⠇⠁⠃⠇⠁</row>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                            </page>
                        </section>
                </_>
            </x:document>
        </x:expect>
    </x:scenario>
        
    <x:scenario label="test for contraction grade in generated content"
                pending="capsnocont was added to Liblouis table
                         (see https://github.com/nlbdev/pipeline/issues/74)">
        <x:call step="nlb:dtbook-to-pef">
            <x:input port="source">
                <x:document type="inline" xml:base="file:/tmp/book.xml">
                    <dtbook version="2005-3" xml:lang="no" xmlns="http://www.daisy.org/z3986/2005/dtbook/">
                        <head>
                            <meta name="dtb:uid" content="557901"/>
                            <meta name="dc:Title" content="ULVEGUTTEN TAL - BOK 1"/>
                            <meta name="dc:Creator" content="aa ll"/>
                            <meta name="dc:Contributor" content="ll"/>
                        </head>
                        <book>
                            <frontmatter>
                                <doctitle>aaa</doctitle>
                                <docauthor>bbb</docauthor>
                                <level1  class="titlepage">
                                    <pagenum id="page-1" page="normal">1</pagenum>
                                    <h1 id="h1_1" class="title fulltitle">ULVEGUTTEN TAL </h1>
                                    <p class="docauthor author">Tor </p>
                                    <p>Illustrert av Haakon Lie</p>
                                    <p>CAPPELEN DAMM</p>
                                </level1>
                            </frontmatter>
                            <bodymatter>
                                <level1>
                                    <h1>aaa</h1>
                                    <p>lll ble at </p>
                                </level1>
                            </bodymatter>
                        </book>
                    </dtbook>
                </x:document>
            </x:input>
            <x:option name="braille-standard" select="'(dots:6)(grade:1)'"/>
            <x:option name="show-print-page-numbers" select="'true'"/>
            <x:option name="pef-output-dir" select="resolve-uri('2/pef-output-dir',$temp-dir)"/>
            <x:option name="preview-output-dir" select="resolve-uri('2/preview-output-dir',$temp-dir)"/>
            <x:option name="temp-dir" select="resolve-uri('2/temp-dir',$temp-dir)"/>
        </x:call>
        
        <x:context label="result">
            <x:document type="file" base-uri="temp-dir" href="2/pef-output-dir/book.pef"  select="/*/*[local-name()='body']"  />
        </x:context>
        <x:expect label="result" type="compare">
            <x:document type="inline">
                <body xmlns="http://www.daisy.org/ns/2008/pef">
                    <volume cols="32" rows="28" rowgap="0" duplex="true">
                        <section>
                            <page>
                                <row/>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠁⠁⠀⠇⠇</row>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠠⠠⠥⠇⠧⠑⠛⠥⠞⠞⠣⠀⠠⠠⠞⠁⠇⠀⠤</row>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠠⠃⠕⠅⠀⠼⠁</row>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠭⠎⠁⠞⠞⠀⠁⠧</row>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠇⠇</row>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠠⠝⠇⠃</row>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠝⠕⠗⠛⠑⠀⠼⠃⠚⠁⠛</row>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠃⠊⠝⠙⠀⠼⠁⠀⠁⠧⠀⠼⠁</row>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                            </page>
                        </section>
                        <section>
                            <page>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠕⠍⠀⠃⠕⠅⠁</row>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row/>
                                <row>⠀⠀⠀⠀⠠⠅⠕⠗⠞⠎⠅⠗⠊⠋⠞⠀⠝⠊⠧⠡⠀⠼⠁</row>
                                <row>⠀⠀⠀⠀⠠⠁⠝⠞⠁⠇⠇⠀⠠⠎⠊⠙⠱⠒⠀⠼⠉</row>
                                <row>⠀⠀⠀⠀⠠⠃⠕⠅⠁⠀⠎⠅⠁⠇⠀⠊⠅⠀⠗⠑⠤</row>
                                <row>⠀⠀⠞⠥⠗⠝⠑⠗⠑⠎⠄</row>
                                <row>⠀⠀⠀⠀⠠⠋⠑⠊⠇⠀⠑⠀⠍⠁⠝⠛⠇⠱⠀⠅⠀⠍⠑⠇⠙⠑⠎</row>
                                <row>⠀⠀⠞⠀⠣⠏⠥⠝⠅⠞⠈⠝⠇⠃⠄⠝⠕⠄⠜</row>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                            </page>
                            <page>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠙⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                            </page>
                        </section>
                        <section>
                            <page>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠁⠁⠁</row>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row/>
                                <row>⠀⠀⠀⠀⠇⠇⠇⠀⠃⠀⠁</row>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠚⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                            </page>
                        </section>
                    </volume>
                </body>
            </x:document>
        </x:expect>
    </x:scenario>
    
    <x:scenario label="generated-content">
        <x:call step="nlb:dtbook-to-pef">
            <x:input port="source">
                <x:document type="inline" xml:base="file:/tmp/book.xml">
                    <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                        <head>
                            <meta name="dtb:uid" content="557901"/>
                            <meta name="dc:Title" content="ULVEGUTTEN TAL - BOK 1"/>
                            <meta name="dc:Identifier" content="557901"/>
                            <meta name="track:Guidelines" content="2015-1"/>
                            <meta name="track:Supplier" content="AEL Data"/>
                            <meta name="dc:Language" content="no"/>
                            <meta name="dc:Format" content="DTBook"/>
                            <meta name="dc:Creator" content="aa ll"/>
                            <meta name="dc:Creator" content="bb"/>
                            <meta name="dc:Creator" content="ll"/>
                            <meta name="dc:Creator" content="rr"/>
                            <meta name="dc:Creator" content="zz"/>
                            <meta name="dc:Contributor" content="ll"/>
                            <meta name="dc:Contributor" content="cc"/>
                            <meta name="dc:Contributor" content="gg"/>
                            <meta name="dc:Contributor" content="xx"/>
                            <meta name="dc:Date" content="2015-11-07"/>
                            <meta name="dc:Publisher" content="NLB"/>
                            <meta name="dc:Source" content="urn:isbn:9788202459543"/>
                            <meta name="dcterms:modified" content="2015-11-09T09:06:58+00:00"/>
                        </head>
                        <book>
                            <frontmatter>
                                <doctitle>aaa</doctitle>
                                <docauthor>bbb</docauthor>
                                <level1  class="titlepage">
                                    <pagenum id="page-1" page="normal">1</pagenum>
                                    <h1 id="h1_1" class="title fulltitle">ULVEGUTTEN TAL</h1>
                                    <p class="docauthor author">Tor </p>
                                    <p>Illustrert av Haakon Lie</p>
                                    <p>CAPPELEN DAMM</p>
                                </level1>
                                <level1  class="colophon">
                                    <pagenum id="page-2" page="normal">2</pagenum>
                                    <p>Originaltittel: <em>The Kill List</em></p>
                                    <p>Copyright © Frederick Forsyth 2013</p>
                                    <p>Norsk utgave © Gyldendal Norsk Forlag AS 2014</p>
                                </level1>
                            </frontmatter>
                            <bodymatter>
                                <level1 class="chapter">
                                    <pagenum id="page-3" page="normal">3</pagenum>
                                    <h1 id="h1_2">ULVESTAMMEN</h1>
                                    <p>Tal er &#xe5;tte vintere gammel.</p>
                                    <pagenum id="page-4" page="normal">4</pagenum>
                                    <p>aaa.</p>
                                    <p>bbb.</p>
                                    <p>lll.</p>
                                </level1>
                            </bodymatter>
                        </book>
                    </dtbook>
                </x:document>
            </x:input>
            <x:option name="toc-depth" select="1"/>
            <x:option name="braille-standard" select="'(dots:6)(grade:0)'"/>
            <x:option name="pef-output-dir" select="resolve-uri('3/pef-output-dir',$temp-dir)"/>
            <x:option name="preview-output-dir" select="resolve-uri('3/preview-output-dir',$temp-dir)"/>
            <x:option name="temp-dir" select="resolve-uri('3/temp-dir',$temp-dir)"/>
        </x:call>
        
        <x:context label="pef">
            <x:document type="file" base-uri="temp-dir" href="3/pef-output-dir/book.pef"/>
        </x:context>
        
        <x:expect label="result" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
            <x:document type="inline">
                <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
                    <head>
                        <meta xmlns:dc="http://purl.org/dc/elements/1.1/">
                            <dc:format>application/x-pef+xml</dc:format>
                            <dc:identifier>identifier?</dc:identifier>
                            <dc:date>date?</dc:date>
                            <dc:title>ULVEGUTTEN TAL - BOK 1</dc:title>
                            <dc:creator>aa ll</dc:creator>
                            <dc:language>no</dc:language>
                            <dc:publisher>NLB</dc:publisher>
                            <dc:contributor>ll</dc:contributor>
                        </meta>
                    </head>
                    <body>
                        <volume cols="32" rows="28" rowgap="0" duplex="true">
                            <section>
                                <page>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠁⠁⠀⠇⠇</row>
                                    <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠃⠃</row>
                                    <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠉⠀⠋⠇⠑⠗⠑</row>
                                    <row/>
                                    <row>⠀⠀⠀⠀⠠⠠⠥⠇⠧⠑⠛⠥⠞⠞⠑⠝⠀⠠⠠⠞⠁⠇⠀⠤⠀⠠⠠⠃⠕⠅</row>
                                    <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠁</row>
                                    <row/>
                                    <row/>
                                    <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠕⠧⠑⠗⠎⠁⠞⠞⠀⠁⠧</row>
                                    <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠇⠇</row>
                                    <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠉</row>
                                    <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠃⠀⠋⠇⠑⠗⠑</row>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠠⠝⠇⠃</row>
                                    <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠝⠕⠗⠛⠑⠀⠼⠃⠚⠁⠛</row>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠃⠊⠝⠙⠀⠼⠁⠀⠁⠧⠀⠼⠁</row>
                                </page>
                            </section>
                            <section>
                                <page>
                                    <row/>
                                    <row/>
                                    <row>⠀⠀⠀⠀⠠⠠⠥⠇⠧⠑⠎⠞⠁⠍⠍⠑⠝⠀⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠀⠼⠁</row>
                                    <row/>
                                    <row/>
                                    <row>⠀⠀⠀⠀⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                    <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠉⠕⠇⠕⠏⠓⠕⠝</row>
                                    <row>⠀⠀⠀⠀⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                    <row/>
                                    <row>⠀⠀⠀⠀⠠⠕⠗⠊⠛⠊⠝⠁⠇⠞⠊⠞⠞⠑⠇⠒⠀⠆⠠⠞⠓⠑</row>
                                    <row>⠀⠀⠠⠅⠊⠇⠇⠀⠠⠇⠊⠎⠞⠰</row>
                                    <row>⠀⠀⠀⠀⠠⠉⠕⠏⠽⠗⠊⠛⠓⠞⠀⠦⠉⠴⠀⠠⠋⠗⠑⠙⠑⠗⠊⠉⠅</row>
                                    <row>⠀⠀⠠⠋⠕⠗⠎⠽⠞⠓⠀⠼⠃⠚⠁⠉</row>
                                    <row>⠀⠀⠀⠀⠠⠝⠕⠗⠎⠅⠀⠥⠞⠛⠁⠧⠑⠀⠦⠉⠴</row>
                                    <row>⠀⠀⠠⠛⠽⠇⠙⠑⠝⠙⠁⠇⠀⠠⠝⠕⠗⠎⠅⠀⠠⠋⠕⠗⠇⠁⠛</row>
                                    <row>⠀⠀⠠⠠⠁⠎⠀⠼⠃⠚⠁⠙</row>
                                </page>
                            </section>
                            <section>
                                <page>
                                    <row/>
                                    <row/>
                                    <row>⠀⠀⠀⠀⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                    <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠕⠍⠀⠃⠕⠅⠁</row>
                                    <row>⠀⠀⠀⠀⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                    <row/>
                                    <row>⠀⠀⠀⠀⠠⠋⠥⠇⠇⠎⠅⠗⠊⠋⠞</row>
                                    <row>⠀⠀⠀⠀⠠⠁⠝⠞⠁⠇⠇⠀⠠⠎⠊⠙⠑⠗⠒⠀⠼⠑</row>
                                    <row>⠀⠀⠀⠀⠠⠃⠕⠅⠁⠀⠎⠅⠁⠇⠀⠊⠅⠅⠑⠀⠗⠑⠞⠥⠗⠝⠑⠗⠑⠎⠄</row>
                                    <row>⠀⠀⠀⠀⠠⠋⠑⠊⠇⠀⠑⠇⠇⠑⠗⠀⠍⠁⠝⠛⠇⠑⠗⠀⠅⠁⠝</row>
                                    <row>⠀⠀⠍⠑⠇⠙⠑⠎⠀⠞⠊⠇⠀⠣⠏⠥⠝⠅⠞⠈⠝⠇⠃⠄⠝⠕⠄⠜</row>
                                </page>
                                <page></page>
                            </section>
                            <section>
                                <page></page>
                            </section>
                            <section>
                                <page>
                                    <row/>
                                    <row/>
                                    <row>⠀⠀⠀⠀⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                    <row>⠿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠠⠥⠇⠧⠑⠎⠞⠁⠍⠍⠑⠝</row>
                                    <row>⠀⠀⠀⠀⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                    <row/>
                                    <row>⠀⠀⠀⠀⠠⠞⠁⠇⠀⠑⠗⠀⠡⠞⠞⠑⠀⠧⠊⠝⠞⠑⠗⠑</row>
                                    <row>⠀⠀⠛⠁⠍⠍⠑⠇⠄</row>
                                    <row>⠿⠀⠀⠀⠁⠁⠁⠄</row>
                                    <row>⠀⠀⠀⠀⠃⠃⠃⠄</row>
                                    <row>⠀⠀⠀⠀⠇⠇⠇⠄</row>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠿⠼⠙</row>
                                </page>
                            </section>
                        </volume>
                    </body>
                </pef>
            </x:document>
        </x:expect>
    </x:scenario>
    
    <x:scenario label="DTBook frontmatter should not be duplicated (issue 93)">
        <x:call step="nlb:dtbook-to-pef">
            <x:input port="source">
                <x:document type="inline" xml:base="file:/tmp/book.xml">
                    <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                        <head>
                            <meta name="dtb:uid" content="tests"/>
                        </head>
                        <book>
                            <frontmatter>
                                <doctitle>tests</doctitle>
                                <level1>
                                    <p>Forordet skal ikke være annerledes en det som kommer etterpå; margene skal være de samme - og det skal være økt linjeavstand</p>
                                </level1>
                            </frontmatter>
                            <bodymatter>
                                <level1>
                                    <p>Boka har ingen overskrifter, men det betyr ikke at det ikke skal være toppmarg ved begynnelsen. Den har økt linjeavstand.</p>
                                    <imggroup>
                                        <img src="xxx.jpg" alt="Bildet viser konturene av ingenting mot en lysabsorberende flate av tomhet. Kontrastene er ikke akkurat til å ta og føle på."/> 
                                    </imggroup>
                                </level1>
                            </bodymatter>
                        </book>
                    </dtbook>
                </x:document>
            </x:input>
            <x:option name="pef-output-dir" select="resolve-uri('4/pef-output-dir',$temp-dir)"/>
            <x:option name="preview-output-dir" select="resolve-uri('4/preview-output-dir',$temp-dir)"/>
            <x:option name="temp-dir" select="resolve-uri('4/temp-dir',$temp-dir)"/>
        </x:call>
        <x:context label="result">
            <x:document type="file" base-uri="temp-dir" href="4/pef-output-dir/book.pef"/>
        </x:context>
        <x:expect label="The text 'Forordet skal' should only occur once" type="xpath" test="count(//pef:row[contains(text(),'⠠⠋⠕⠗⠕⠗⠙⠑⠞⠀⠎⠅⠁⠇')])" equals="1"/>
    </x:scenario>
    
    <x:scenario label="double linespacing should work inside the DTBook (see comment on issue 93)">
        <x:call step="nlb:dtbook-to-pef">
            <x:input port="source">
                <x:document type="inline" xml:base="file:/tmp/book.xml">
                    <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                        <head>
                            <meta name="dtb:uid" content="tests"/>
                        </head>
                        <book>
                            <frontmatter>
                                <doctitle>tests</doctitle>
                                <level1>
                                    <p>Forordet skal ikke være annerledes en det som kommer etterpå; margene skal være de samme - og det skal være økt linjeavstand</p>
                                </level1>
                            </frontmatter>
                            <bodymatter>
                                <level1>
                                    <p>Boka har ingen overskrifter, men det betyr ikke at det ikke skal være toppmarg ved begynnelsen. Den har økt linjeavstand.</p>
                                    <imggroup>
                                        <img src="xxx.jpg" alt="Bildet viser konturene av ingenting mot en lysabsorberende flate av tomhet. Kontrastene er ikke akkurat til å ta og føle på."/> 
                                    </imggroup>
                                </level1>
                            </bodymatter>
                        </book>
                    </dtbook>
                </x:document>
            </x:input>
        </x:call>
        
        <x:scenario label="single line spacing">
            <x:call>
                <x:option name="line-spacing" select="'single'"/>
                <x:option name="pef-output-dir" select="resolve-uri('5/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('5/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('5/temp-dir',$temp-dir)"/>
            </x:call>
            <x:context label="result">
                <x:document type="file" base-uri="temp-dir" href="5/pef-output-dir/book.pef"/>
            </x:context>
            <x:expect label="The row after the row containing 'Forordet skal', should not be empty and there should be no rowgap" type="xpath" test="(//pef:row[contains(text(),'⠠⠋⠕⠗⠕⠗⠙⠑⠞⠀⠎⠅⠁⠇')])[1]/((not(@rowgap) or @rowgap = '0') and following-sibling::pef:row[1]/replace(text(),'[\s⠀]','') != '')"/>
        </x:scenario>
        
        <x:scenario label="double line spacing">
            <x:call>
                <x:option name="line-spacing" select="'double'"/>
                <x:option name="pef-output-dir" select="resolve-uri('6/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('6/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('6/temp-dir',$temp-dir)"/>
            </x:call>
            <x:context label="result">
                <x:document type="file" base-uri="temp-dir" href="6/pef-output-dir/book.pef"/>
            </x:context>
            <x:expect label="Either rowgap should be 4, or the row after the row containing 'Forordet skal', should be empty" type="xpath" test="(//pef:row[contains(text(),'⠠⠋⠕⠗⠕⠗⠙⠑⠞⠀⠎⠅⠁⠇')])[1]/(@rowgap = '4' or following-sibling::pef:row[1]/replace(text(),'[\s⠀]','') = '')"/>
        </x:scenario>
    </x:scenario>
    
    <x:scenario label="margins in frontmatter should be the same as in bodymatter (see comment on issue 93)" pending="https://github.com/nlbdev/pipeline/issues/93#issuecomment-324914293">
        <x:call step="nlb:dtbook-to-pef">
            <x:input port="source">
                <x:document type="inline" xml:base="file:/tmp/book.xml">
                    <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                        <head>
                            <meta name="dtb:uid" content="test"/>
                        </head>
                        <book>
                            <frontmatter>
                                <doctitle>test</doctitle>
                                <level1>
                                    <p>frontmatter xxxxxx</p>
                                    <p>frontmatter xxxxxxx</p>
                                    <p>frontmatter xxxxxxxx</p>
                                    <p>frontmatter xxxxxxxxx</p>
                                    <p>frontmatter xxxxxxxxxx</p>
                                    <p>frontmatter xxxxxxxxxxx</p>
                                    <p>frontmatter xxxxxxxxxxxx</p>
                                    <p>frontmatter xxxxxxxxxxxxx</p>
                                    <p>frontmatter xxxxxxxxxxxxxx</p>
                                    <p>frontmatter xxxxxxxxxxxxxxx</p>
                                    <p>frontmatter xxxxxxxxxxxxxxxx</p>
                                    <p>frontmatter xxxxxxxxxxxxxxxxx</p>
                                    <p>frontmatter xxxxxxxxxxxxxxxxxx</p>
                                    <p>frontmatter xxxxxxxxxxxxxxxxxxx</p>
                                </level1>
                            </frontmatter>
                            <bodymatter>
                                <level1>
                                    <p>bodymatter xxxxxxxx</p>
                                    <p>bodymatter xxxxxxxxx</p>
                                    <p>bodymatter xxxxxxxxxx</p>
                                    <p>bodymatter xxxxxxxxxxx</p>
                                    <p>bodymatter xxxxxxxxxxxx</p>
                                    <p>bodymatter xxxxxxxxxxxxx</p>
                                    <p>bodymatter xxxxxxxxxxxxxx</p>
                                    <p>bodymatter xxxxxxxxxxxxxxx</p>
                                    <p>bodymatter xxxxxxxxxxxxxxxx</p>
                                    <p>bodymatter xxxxxxxxxxxxxxxxx</p>
                                    <p>bodymatter xxxxxxxxxxxxxxxxxx</p>
                                    <p>bodymatter xxxxxxxxxxxxxxxxxxx</p>
                                    <p>bodymatter xxxxxxxxxxxxxxxxxxxx</p>
                                    <p>bodymatter xxxxxxxxxxxxxxxxxxxxx</p>
                                </level1>
                            </bodymatter>
                        </book>
                    </dtbook>
                </x:document>
            </x:input>
            <x:option name="page-width" select="32"/>
            <x:option name="pef-output-dir" select="resolve-uri('7/pef-output-dir',$temp-dir)"/>
            <x:option name="preview-output-dir" select="resolve-uri('7/preview-output-dir',$temp-dir)"/>
            <x:option name="temp-dir" select="resolve-uri('7/temp-dir',$temp-dir)"/>
        </x:call>
        
        <x:context label="result">
            <x:document type="file" base-uri="temp-dir" href="7/pef-output-dir/book.pef"/>
        </x:context>
        <x:expect label="The left margins should be the same in frontmatter and bodymatter" type="xpath"
            test="min(//pef:row[contains(text(),'⠋⠗⠕⠝⠞⠍⠁⠞⠞⠑⠗')]/string-length(replace(text(),'^(⠀*).+?$','$1','s')))"
            equals="min(//pef:row[contains(text(),'⠃⠕⠙⠽⠍⠁⠞⠞⠑⠗')]/string-length(replace(text(),'^(⠀*).+?$','$1','s')))"/>
        <x:expect label="The right margins should be the same in frontmatter and bodymatter" type="xpath"
            test="min(//pef:row[contains(text(),'⠋⠗⠕⠝⠞⠍⠁⠞⠞⠑⠗')]/(string-length(replace(text(),'^.+?(⠀*)$','$1','s')) + (32 - string-length(text()))))"
            equals="min(//pef:row[contains(text(),'⠃⠕⠙⠽⠍⠁⠞⠞⠑⠗')]/(string-length(replace(text(),'^.+?(⠀*)$','$1','s')) + (32 - string-length(text()))))"/>
    </x:scenario>
    
</x:description>