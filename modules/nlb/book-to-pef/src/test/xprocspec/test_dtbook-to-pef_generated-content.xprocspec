<?xml version="1.0" encoding="UTF-8"?>
<?xml-model href="http://www.daisy.org/ns/xprocspec/xprocspec.rng" type="application/xml" schematypens="http://relaxng.org/ns/structure/1.0"?>
<x:description xmlns:x="http://www.daisy.org/ns/xprocspec"
    xmlns:p="http://www.w3.org/ns/xproc"
    xmlns:px="http://www.daisy.org/ns/pipeline/xproc"
    xmlns:nlb="http://www.nlb.no/ns/pipeline/xproc"
    xmlns:pef="http://www.daisy.org/ns/2008/pef"
    script="http://www.nlb.no/pipeline/modules/braille/dtbook-to-pef.xpl">
    
    <x:scenario label="titlepage">
        <x:call step="nlb:dtbook-to-pef"/>
        
        <x:scenario label="basic test of complete titlepage">
            <x:call step="nlb:dtbook-to-pef">
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                            <head>
                                <meta name="dtb:uid" content="uid"/>
                                <meta name="dc:Creator" content="author"/>
                                <meta name="dc:Title" content="title"/>
                            </head>
                            <book>
                                <bodymatter>
                                    <level1>
                                        <h1>bodymatter</h1>
                                    </level1>
                                </bodymatter>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('titlepage/1/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('titlepage/1/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('titlepage/1/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="the pef">
                <x:document type="file" base-uri="temp-dir" href="titlepage/1/pef-output-dir/book.pef"/>
            </x:context>
            <x:expect label="the PEF should be 28 rows high" type="xpath" test="(//pef:volume)[1]/@rows" equals="28"/>
            <x:expect label="the PEF should be 32 columns wide" type="xpath" test="(//pef:volume)[1]/@cols" equals="32"/>
            
            <x:context label="the rows on the first page of the pef">
                <x:document type="file" base-uri="temp-dir" href="titlepage/1/pef-output-dir/book.pef" select="(//pef:page)[1]/pef:row"/>
            </x:context>
            <x:expect label="the titlepage should be as expected" type="compare">
                <x:document type="inline" select="/*/*">
                    <page xmlns="http://www.daisy.org/ns/2008/pef">
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠁⠥⠞⠓⠕⠗</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠞⠊⠞⠇⠑</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠠⠝⠇⠃⠀⠤⠀⠼⠃⠚⠁⠛</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠋⠥⠇⠇⠎⠅⠗⠊⠋⠞</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠓⠑⠋⠞⠑⠀⠼⠁⠀⠁⠧⠀⠼⠁</row>
                    </page>
                </x:document>
            </x:expect>
        </x:scenario>
        
        <x:scenario label="with existing titlepage">
            <x:call step="nlb:dtbook-to-pef">
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                            <head>
                                <meta name="dtb:uid" content="uid"/>
                                <meta name="dc:Creator" content="author"/>
                                <meta name="dc:Title" content="title"/>
                            </head>
                            <book>
                                <frontmatter>
                                    <level1 class="titlepage">
                                        <h1>existing titlepage</h1>
                                    </level1>
                                </frontmatter>
                                <bodymatter>
                                    <level1>
                                        <h1>bodymatter</h1>
                                    </level1>
                                </bodymatter>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('titlepage/2/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('titlepage/2/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('titlepage/2/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="the PEF">
                <x:document type="file" base-uri="temp-dir" href="titlepage/2/pef-output-dir/book.pef"/>
            </x:context>
            <x:expect label="the existing titlepage should be deleted" type="xpath" test="not(contains(replace(string-join(.//pef:row/text(),'⠀'),'⠀+','⠀'),'⠑⠭⠊⠎⠞⠊⠝⠛⠀⠞⠊⠞⠇⠑⠏⠁⠛⠑'))"/>
        </x:scenario>
    </x:scenario>
    
    <x:scenario label="author">
        <x:call step="nlb:dtbook-to-pef"/>
        
        <x:scenario label="1 author">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                            <head>
                                <meta name="dtb:uid" content="uid"/>
                                <meta name="dc:Creator" content="author"/>
                                <meta name="dc:Title" content="title"/>
                            </head>
                            <book>
                                <bodymatter/>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('author/1/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('author/1/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('author/1/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="rows 4 to 6">
                <x:document type="file" base-uri="temp-dir" href="author/1/pef-output-dir/book.pef" select="(//pef:page)[1]/pef:row[position() = 4 to 6]"/>
            </x:context>
            <x:expect label="should contain the author and two empty lines" type="compare">
                <x:document type="inline" select="/*/*">
                    <page xmlns="http://www.daisy.org/ns/2008/pef">
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠁⠥⠞⠓⠕⠗</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                    </page>
                </x:document>
            </x:expect>
        </x:scenario>
        
        <x:scenario label="2 authors">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                            <head>
                                <meta name="dtb:uid" content="uid"/>
                                <meta name="dc:Creator" content="author 1"/>
                                <meta name="dc:Creator" content="author 2"/>
                                <meta name="dc:Title" content="title"/>
                            </head>
                            <book>
                                <bodymatter/>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('author/2/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('author/2/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('author/2/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="rows 4 to 7">
                <x:document type="file" base-uri="temp-dir" href="author/2/pef-output-dir/book.pef" select="(//pef:page)[1]/pef:row[position() = 4 to 7]"/>
            </x:context>
            <x:expect label="should contain the authors and two empty lines" type="compare">
                <x:document type="inline" select="/*/*">
                    <page xmlns="http://www.daisy.org/ns/2008/pef">
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠁⠥⠞⠓⠕⠗⠀⠼⠁</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠁⠥⠞⠓⠕⠗⠀⠼⠃</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                    </page>
                </x:document>
            </x:expect>
        </x:scenario>
        
        <x:scenario label="3 authors">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                            <head>
                                <meta name="dtb:uid" content="uid"/>
                                <meta name="dc:Creator" content="author 1"/>
                                <meta name="dc:Creator" content="author 2"/>
                                <meta name="dc:Creator" content="author 3"/>
                                <meta name="dc:Title" content="title"/>
                            </head>
                            <book>
                                <bodymatter/>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('author/3/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('author/3/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('author/3/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="rows 4 to 8">
                <x:document type="file" base-uri="temp-dir" href="author/3/pef-output-dir/book.pef" select="(//pef:page)[1]/pef:row[position() = 4 to 8]"/>
            </x:context>
            <x:expect label="should contain the authors and two empty lines" type="compare">
                <x:document type="inline" select="/*/*">
                    <page xmlns="http://www.daisy.org/ns/2008/pef">
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠁⠥⠞⠓⠕⠗⠀⠼⠁</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠁⠥⠞⠓⠕⠗⠀⠼⠃</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠍⠋⠇⠄</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                    </page>
                </x:document>
            </x:expect>
        </x:scenario>
        
        <x:scenario label="4 authors">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                            <head>
                                <meta name="dtb:uid" content="uid"/>
                                <meta name="dc:Creator" content="author 1"/>
                                <meta name="dc:Creator" content="author 2"/>
                                <meta name="dc:Creator" content="author 3"/>
                                <meta name="dc:Creator" content="author 4"/>
                                <meta name="dc:Title" content="title"/>
                            </head>
                            <book>
                                <bodymatter/>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('author/4/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('author/4/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('author/4/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="rows 4 to 8">
                <x:document type="file" base-uri="temp-dir" href="author/4/pef-output-dir/book.pef" select="(//pef:page)[1]/pef:row[position() = 4 to 8]"/>
            </x:context>
            <x:expect label="should contain the first two authors, 'mfl.' on the third line, and then two empty lines" type="compare">
                <x:document type="inline" select="/*/*">
                    <page xmlns="http://www.daisy.org/ns/2008/pef">
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠁⠥⠞⠓⠕⠗⠀⠼⠁</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠁⠥⠞⠓⠕⠗⠀⠼⠃</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠍⠋⠇⠄</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                    </page>
                </x:document>
            </x:expect>
        </x:scenario>
    </x:scenario>
    
    <x:scenario label="title">
        <x:call step="nlb:dtbook-to-pef"/>
        
        <x:scenario label="long title that fits">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                            <head>
                                <meta name="dtb:uid" content="uid"/>
                                <meta name="dc:Creator" content="author"/>
                                <meta name="dc:Title" content="So Long, and Thanks for All the Fish (Hitchhiker's Guide to the Galaxy #4)"/>
                            </head>
                            <book>
                                <bodymatter/>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('title/1/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('title/1/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('title/1/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="rows 7 to 13">
                <x:document type="file" base-uri="temp-dir" href="title/1/pef-output-dir/book.pef" select="(//pef:page)[1]/pef:row[position() = 7 to 13]"/>
            </x:context>
            <x:expect label="should contain the author and two empty lines" type="compare">
                <x:document type="inline" select="/*/*">
                    <page xmlns="http://www.daisy.org/ns/2008/pef">
                        <row>⠀⠀⠀⠠⠎⠕⠀⠠⠇⠕⠝⠛⠂⠀⠁⠝⠙⠀⠠⠞⠓⠁⠝⠅⠎⠀⠋⠕⠗</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠁⠇⠇⠀⠞⠓⠑⠀⠠⠋⠊⠎⠓</row>
                        <row>⠀⠀⠀⠀⠦⠠⠓⠊⠞⠉⠓⠓⠊⠅⠑⠗⠐⠎⠀⠠⠛⠥⠊⠙⠑⠀⠞⠕</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠞⠓⠑⠀⠠⠛⠁⠇⠁⠭⠽⠀⠼⠼⠙⠴</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                    </page>
                </x:document>
            </x:expect>
        </x:scenario>
        <x:scenario label="long title that does not fit">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                            <head>
                                <meta name="dtb:uid" content="uid"/>
                                <meta name="dc:Creator" content="author"/>
                                <meta name="dc:Title" content="No Matter How Much You Promise to Cook or Pay the Rent You Blew It Cauze Bill Bailey Ain't Never Coming Home Again"/>
                            </head>
                            <book>
                                <bodymatter/>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('title/2/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('title/2/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('title/2/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="rows 7 to 13">
                <x:document type="file" base-uri="temp-dir" href="title/2/pef-output-dir/book.pef" select="(//pef:page)[1]/pef:row[position() = 7 to 13]"/>
            </x:context>
            <x:expect label="should contain the author and two empty lines" type="compare">
                <x:document type="inline" select="/*/*">
                    <page xmlns="http://www.daisy.org/ns/2008/pef">
                        <row>⠀⠀⠀⠀⠀⠠⠝⠕⠀⠠⠍⠁⠞⠞⠑⠗⠀⠠⠓⠕⠺⠀⠠⠍⠥⠉⠓</row>
                        <row>⠀⠀⠀⠀⠠⠽⠕⠥⠀⠠⠏⠗⠕⠍⠊⠎⠑⠀⠞⠕⠀⠠⠉⠕⠕⠅⠀⠕⠗</row>
                        <row>⠀⠀⠀⠀⠠⠏⠁⠽⠀⠞⠓⠑⠀⠠⠗⠑⠝⠞⠀⠠⠽⠕⠥⠀⠠⠃⠇⠑⠺</row>
                        <row>⠀⠀⠀⠀⠠⠊⠞⠀⠠⠉⠁⠥⠵⠑⠀⠠⠃⠊⠇⠇⠀⠠⠃⠁⠊⠇⠑⠽</row>
                        <row>⠀⠀⠀⠀⠠⠁⠊⠝⠐⠞⠀⠠⠝⠑⠧⠑⠗⠀⠠⠉⠕⠍⠊⠝⠛⠄⠄⠄</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                    </page>
                </x:document>
            </x:expect>
        </x:scenario>
        <x:scenario label="long title that fits but words have to be broken">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                            <head>
                                <meta name="dtb:uid" content="uid"/>
                                <meta name="dc:Creator" content="author"/>
                                <meta name="dc:Title" content="Floccinaucinihilipilification of supercalifragilisticexpialidocious expressions"/>
                            </head>
                            <book>
                                <bodymatter/>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('title/3/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('title/3/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('title/3/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="rows 7 to 13">
                <x:document type="file" base-uri="temp-dir" href="title/3/pef-output-dir/book.pef" select="(//pef:page)[1]/pef:row[position() = 7 to 13]"/>
            </x:context>
            <x:expect label="should contain the author and two empty lines" type="compare">
                <x:document type="inline" select="/*/*">
                    <page xmlns="http://www.daisy.org/ns/2008/pef">
                        <row>⠀⠀⠀⠀⠀⠀⠀⠠⠋⠇⠕⠉⠉⠊⠝⠁⠥⠉⠊⠝⠊⠓⠊⠇⠊⠏</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠊⠇⠊⠋⠊⠉⠁⠞⠊⠕⠝⠀⠕⠋</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠎⠥⠏⠑⠗⠉⠁⠇⠊⠋⠗⠁⠛⠊⠇⠊⠎⠞</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠊⠉⠑⠭⠏⠊⠁⠇⠊⠙⠕⠉⠊⠕⠥⠎</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠑⠭⠏⠗⠑⠎⠎⠊⠕⠝⠎</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                    </page>
                </x:document>
            </x:expect>
        </x:scenario>
        <x:scenario label="long title that does not fit with words that have to be broken">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                            <head>
                                <meta name="dtb:uid" content="uid"/>
                                <meta name="dc:Creator" content="author"/>
                                <meta name="dc:Title" content="Floccinaucinihilipilification of supercalifragilisticexpialidocious expressions and its strenghts with regards to incomprehensibilities"/>
                            </head>
                            <book>
                                <bodymatter/>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('title/4/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('title/4/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('title/4/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="rows 7 to 13">
                <x:document type="file" base-uri="temp-dir" href="title/4/pef-output-dir/book.pef" select="(//pef:page)[1]/pef:row[position() = 7 to 13]"/>
            </x:context>
            <x:expect label="should contain the author and two empty lines" type="compare">
                <x:document type="inline" select="/*/*">
                    <page xmlns="http://www.daisy.org/ns/2008/pef">
                        <row>⠀⠀⠀⠀⠀⠀⠀⠠⠋⠇⠕⠉⠉⠊⠝⠁⠥⠉⠊⠝⠊⠓⠊⠇⠊⠏</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠊⠇⠊⠋⠊⠉⠁⠞⠊⠕⠝⠀⠕⠋</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠎⠥⠏⠑⠗⠉⠁⠇⠊⠋⠗⠁⠛⠊⠇⠊⠎⠞</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠊⠉⠑⠭⠏⠊⠁⠇⠊⠙⠕⠉⠊⠕⠥⠎</row>
                        <row>⠀⠀⠀⠀⠀⠑⠭⠏⠗⠑⠎⠎⠊⠕⠝⠎⠀⠁⠝⠙⠀⠊⠞⠎⠄⠄⠄</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                    </page>
                </x:document>
            </x:expect>
        </x:scenario>
    </x:scenario>
    
    <x:scenario label="translator">
        <x:call step="nlb:dtbook-to-pef"/>
        
        <x:scenario label="1 translator">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                            <head>
                                <meta name="dtb:uid" content="uid"/>
                                <meta name="dc:Creator" content="author"/>
                                <meta name="dc:Title" content="title"/>
                                <meta name="dc:Contributor" role="translator" content="translator"/>
                            </head>
                            <book>
                                <bodymatter/>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('translator/1/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('translator/1/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('translator/1/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="rows 10 to 14">
                <x:document type="file" base-uri="temp-dir" href="translator/1/pef-output-dir/book.pef" select="(//pef:page)[1]/pef:row[position() = 10 to 14]"/>
            </x:context>
            <x:expect label="should start with 'Oversatt av:', and then list the translator(s), and have two empty lines at the end" type="compare">
                <x:document type="inline" select="/*/*">
                    <page xmlns="http://www.daisy.org/ns/2008/pef">
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠕⠧⠑⠗⠎⠁⠞⠞⠀⠁⠧⠒</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠞⠗⠁⠝⠎⠇⠁⠞⠕⠗</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                    </page>
                </x:document>
            </x:expect>
        </x:scenario>
        
        <x:scenario label="2 translators">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                            <head>
                                <meta name="dtb:uid" content="uid"/>
                                <meta name="dc:Creator" content="author"/>
                                <meta name="dc:Title" content="title"/>
                                <meta name="dc:Contributor" role="translator" content="translator 1"/>
                                <meta name="dc:Contributor" role="translator" content="translator 2"/>
                            </head>
                            <book>
                                <bodymatter/>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('translator/2/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('translator/2/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('translator/2/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="rows 10 to 14">
                <x:document type="file" base-uri="temp-dir" href="translator/2/pef-output-dir/book.pef" select="(//pef:page)[1]/pef:row[position() = 10 to 14]"/>
            </x:context>
            <x:expect label="should start with 'Oversatt av:', and then list the translator(s), and have two empty lines at the end" type="compare">
                <x:document type="inline" select="/*/*">
                    <page xmlns="http://www.daisy.org/ns/2008/pef">
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠕⠧⠑⠗⠎⠁⠞⠞⠀⠁⠧⠒</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠞⠗⠁⠝⠎⠇⠁⠞⠕⠗⠀⠼⠁</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠞⠗⠁⠝⠎⠇⠁⠞⠕⠗⠀⠼⠃</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                    </page>
                </x:document>
            </x:expect>
        </x:scenario>
        
        <x:scenario label="3 translators">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                            <head>
                                <meta name="dtb:uid" content="uid"/>
                                <meta name="dc:Creator" content="author"/>
                                <meta name="dc:Title" content="title"/>
                                <meta name="dc:Contributor" role="translator" content="translator 1"/>
                                <meta name="dc:Contributor" role="translator" content="translator 2"/>
                                <meta name="dc:Contributor" role="translator" content="translator 3"/>
                            </head>
                            <book>
                                <bodymatter/>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('translator/3/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('translator/3/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('translator/3/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="rows 10 to 14">
                <x:document type="file" base-uri="temp-dir" href="translator/3/pef-output-dir/book.pef" select="(//pef:page)[1]/pef:row[position() = 10 to 14]"/>
            </x:context>
            <x:expect label="should start with 'Oversatt av:', and then list the translator(s), and have two empty lines at the end" type="compare">
                <x:document type="inline" select="/*/*">
                    <page xmlns="http://www.daisy.org/ns/2008/pef">
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠕⠧⠑⠗⠎⠁⠞⠞⠀⠁⠧⠒</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠞⠗⠁⠝⠎⠇⠁⠞⠕⠗⠀⠼⠁</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠍⠋⠇⠄</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                    </page>
                </x:document>
            </x:expect>
        </x:scenario>
        
        <x:scenario label="1 translator with a long name">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                            <head>
                                <meta name="dtb:uid" content="uid"/>
                                <meta name="dc:Creator" content="author"/>
                                <meta name="dc:Title" content="title"/>
                                <meta name="dc:Contributor" role="translator" content="Translator Translator Translator Translator Translator Translator"/>
                            </head>
                            <book>
                                <bodymatter/>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('translator/4/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('translator/4/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('translator/4/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="rows 10 to 14">
                <x:document type="file" base-uri="temp-dir" href="translator/4/pef-output-dir/book.pef" select="(//pef:page)[1]/pef:row[position() = 10 to 14]"/>
            </x:context>
            <x:expect label="should start with 'Oversatt av:', and then list the translator(s), and have two empty lines at the end" type="compare">
                <x:document type="inline" select="/*/*">
                    <page xmlns="http://www.daisy.org/ns/2008/pef">
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠕⠧⠑⠗⠎⠁⠞⠞⠀⠁⠧⠒</row>
                        <row>⠀⠀⠀⠀⠀⠠⠞⠗⠁⠝⠎⠇⠁⠞⠕⠗⠀⠠⠞⠄⠀⠠⠞⠄⠀⠠⠞⠄</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠞⠄⠀⠠⠞⠗⠁⠝⠎⠇⠁⠞⠕⠗</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                    </page>
                </x:document>
            </x:expect>
        </x:scenario>
        
        <x:scenario label="2 translators with long names">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                            <head>
                                <meta name="dtb:uid" content="uid"/>
                                <meta name="dc:Creator" content="author"/>
                                <meta name="dc:Title" content="title"/>
                                <meta name="dc:Contributor" role="translator" content="Translator Translator Translator Translator"/>
                                <meta name="dc:Contributor" role="translator" content="Translateur Translateur Translateur Translateur"/>
                            </head>
                            <book>
                                <bodymatter/>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('translator/5/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('translator/5/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('translator/5/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="rows 10 to 14">
                <x:document type="file" base-uri="temp-dir" href="translator/5/pef-output-dir/book.pef" select="(//pef:page)[1]/pef:row[position() = 10 to 14]"/>
            </x:context>
            <x:expect label="should start with 'Oversatt av:', and then list the translator(s), and have two empty lines at the end" type="compare">
                <x:document type="inline" select="/*/*">
                    <page xmlns="http://www.daisy.org/ns/2008/pef">
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠕⠧⠑⠗⠎⠁⠞⠞⠀⠁⠧⠒</row>
                        <row>⠀⠀⠀⠀⠀⠠⠞⠄⠀⠠⠞⠄⠀⠠⠞⠄⠀⠠⠞⠗⠁⠝⠎⠇⠁⠞⠕⠗</row>
                        <row>⠀⠀⠀⠀⠠⠞⠄⠀⠠⠞⠄⠀⠠⠞⠄⠀⠠⠞⠗⠁⠝⠎⠇⠁⠞⠑⠥⠗</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                    </page>
                </x:document>
            </x:expect>
        </x:scenario>
    </x:scenario>
    
    <x:scenario label="nlb / year / contraction grade">
        <x:call step="nlb:dtbook-to-pef"/>
        
        <x:scenario label="grade:0">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                            <head>
                                <meta name="dtb:uid" content="uid"/>
                                <meta name="dc:Creator" content="author"/>
                                <meta name="dc:Title" content="title"/>
                            </head>
                            <book>
                                <bodymatter/>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('nlb-year-grade/1/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('nlb-year-grade/1/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('nlb-year-grade/1/temp-dir',$temp-dir)"/>
                <x:option name="braille-standard" select="'(dots:6)(grade:0)'"/>
            </x:call>
            
            <x:context label="the first page in the PEF">
                <x:document type="file" base-uri="temp-dir" href="nlb-year-grade/1/pef-output-dir/book.pef" select="(//pef:page)[1]"/>
            </x:context>
            <x:expect label="line 23 should contain 'NLB - {year}'"
                      type="xpath"
                      test="/*/pef:row[position() = 23]/replace(text(),'^⠀*([^⠀].*?) *$','$1')"
                      equals="concat('⠠⠠⠝⠇⠃⠀⠤⠀⠼', replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(
                                                     format-dateTime(current-dateTime(),'[Y]')
                                                     ,'0','⠚'),'1','⠁'),'2','⠃'),'3','⠉'),'4','⠙'),'5','⠑'),'6','⠋'),'7','⠛'),'8','⠓'),'9','⠊'))"/>
            <x:expect label="line 24 should contain 'Fullskrift'" type="xpath" test="/*/pef:row[position() = 24]/replace(text(),'^⠀*([^⠀].*?) *$','$1')" equals="'⠠⠋⠥⠇⠇⠎⠅⠗⠊⠋⠞'"/>
            <x:expect label="line 25 should be empty" type="xpath" test="/*/pef:row[position() = 25]/replace(text(),'⠀','')" equals="''"/>
            <x:expect label="line 26 should be empty" type="xpath" test="/*/pef:row[position() = 26]/replace(text(),'⠀','')" equals="''"/>
        </x:scenario>
        
        <x:scenario label="grade:1">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                            <head>
                                <meta name="dtb:uid" content="uid"/>
                                <meta name="dc:Creator" content="author"/>
                                <meta name="dc:Title" content="title"/>
                            </head>
                            <book>
                                <bodymatter/>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('nlb-year-grade/2/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('nlb-year-grade/2/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('nlb-year-grade/2/temp-dir',$temp-dir)"/>
                <x:option name="braille-standard" select="'(dots:6)(grade:1)'"/>
            </x:call>
            
            <x:context label="the first page in the PEF">
                <x:document type="file" base-uri="temp-dir" href="nlb-year-grade/2/pef-output-dir/book.pef" select="(//pef:page)[1]"/>
            </x:context>
            <x:expect label="line 23 should contain 'NLB - {year}'"
                      type="xpath"
                      test="/*/pef:row[position() = 23]/replace(text(),'^⠀*([^⠀].*?) *$','$1')"
                      equals="concat('⠠⠠⠝⠇⠃⠀⠤⠀⠼', replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(
                                                     format-dateTime(current-dateTime(),'[Y]')
                                                     ,'0','⠚'),'1','⠁'),'2','⠃'),'3','⠉'),'4','⠙'),'5','⠑'),'6','⠋'),'7','⠛'),'8','⠓'),'9','⠊'))"/>
            <x:expect label="line 24 should contain 'Kortskrift 1'" type="xpath" test="/*/pef:row[position() = 24]/replace(text(),'^⠀*([^⠀].*?) *$','$1')" equals="'⠠⠅⠕⠗⠞⠎⠅⠗⠊⠋⠞⠀⠼⠁'"/>
            <x:expect label="line 25 should be empty" type="xpath" test="/*/pef:row[position() = 25]/replace(text(),'⠀','')" equals="''"/>
            <x:expect label="line 26 should be empty" type="xpath" test="/*/pef:row[position() = 26]/replace(text(),'⠀','')" equals="''"/>
        </x:scenario>
        
        <x:scenario label="grade:2">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                            <head>
                                <meta name="dtb:uid" content="uid"/>
                                <meta name="dc:Creator" content="author"/>
                                <meta name="dc:Title" content="title"/>
                            </head>
                            <book>
                                <bodymatter/>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('nlb-year-grade/3/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('nlb-year-grade/3/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('nlb-year-grade/3/temp-dir',$temp-dir)"/>
                <x:option name="braille-standard" select="'(dots:6)(grade:2)'"/>
            </x:call>
            
            <x:context label="the first page in the PEF">
                <x:document type="file" base-uri="temp-dir" href="nlb-year-grade/3/pef-output-dir/book.pef" select="(//pef:page)[1]"/>
            </x:context>
            <x:expect label="line 23 should contain 'NLB - {year}'"
                      type="xpath"
                      test="/*/pef:row[position() = 23]/replace(text(),'^⠀*([^⠀].*?) *$','$1')"
                      equals="concat('⠠⠠⠝⠇⠃⠀⠤⠀⠼', replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(
                                                     format-dateTime(current-dateTime(),'[Y]')
                                                     ,'0','⠚'),'1','⠁'),'2','⠃'),'3','⠉'),'4','⠙'),'5','⠑'),'6','⠋'),'7','⠛'),'8','⠓'),'9','⠊'))"/>
            <x:expect label="line 24 should contain 'Kortskrift 2'" type="xpath" test="/*/pef:row[position() = 24]/replace(text(),'^⠀*([^⠀].*?) *$','$1')" equals="'⠠⠅⠕⠗⠞⠎⠅⠗⠊⠋⠞⠀⠼⠃'"/>
            <x:expect label="line 25 should be empty" type="xpath" test="/*/pef:row[position() = 25]/replace(text(),'⠀','')" equals="''"/>
            <x:expect label="line 26 should be empty" type="xpath" test="/*/pef:row[position() = 26]/replace(text(),'⠀','')" equals="''"/>
        </x:scenario>
        
        <x:scenario label="grade:3">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                            <head>
                                <meta name="dtb:uid" content="uid"/>
                                <meta name="dc:Creator" content="author"/>
                                <meta name="dc:Title" content="title"/>
                            </head>
                            <book>
                                <bodymatter/>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('nlb-year-grade/4/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('nlb-year-grade/4/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('nlb-year-grade/4/temp-dir',$temp-dir)"/>
                <x:option name="braille-standard" select="'(dots:6)(grade:3)'"/>
            </x:call>
            
            <x:context label="the first page in the PEF">
                <x:document type="file" base-uri="temp-dir" href="nlb-year-grade/4/pef-output-dir/book.pef" select="(//pef:page)[1]"/>
            </x:context>
            <x:expect label="line 23 should contain 'NLB - {year}'"
                      type="xpath"
                      test="/*/pef:row[position() = 23]/replace(text(),'^⠀*([^⠀].*?) *$','$1')"
                      equals="concat('⠠⠠⠝⠇⠃⠀⠤⠀⠼', replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(
                                                     format-dateTime(current-dateTime(),'[Y]')
                                                     ,'0','⠚'),'1','⠁'),'2','⠃'),'3','⠉'),'4','⠙'),'5','⠑'),'6','⠋'),'7','⠛'),'8','⠓'),'9','⠊'))"/>
            <x:expect label="line 24 should contain 'Kortskrift 3'" type="xpath" test="/*/pef:row[position() = 24]/replace(text(),'^⠀*([^⠀].*?) *$','$1')" equals="'⠠⠅⠕⠗⠞⠎⠅⠗⠊⠋⠞⠀⠼⠉'"/>
            <x:expect label="line 25 should be empty" type="xpath" test="/*/pef:row[position() = 25]/replace(text(),'⠀','')" equals="''"/>
            <x:expect label="line 26 should be empty" type="xpath" test="/*/pef:row[position() = 26]/replace(text(),'⠀','')" equals="''"/>
        </x:scenario>
    </x:scenario>
    
    <x:scenario label="volume">
        <x:call step="nlb:dtbook-to-pef"/>
        
        <x:scenario label="1 volume">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                            <head>
                                <meta name="dtb:uid" content="uid"/>
                                <meta name="dc:Creator" content="author"/>
                                <meta name="dc:Title" content="title"/>
                            </head>
                            <book>
                                <bodymatter/>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('volume/1/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('volume/1/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('volume/1/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="row 27 on first page of first volume">
                <x:document type="file" base-uri="temp-dir" href="volume/1/pef-output-dir/book.pef" select="(//pef:page)[1]/pef:row[27]"/>
            </x:context>
            <x:expect label="should contain 'Hefte 1 av 1'" type="compare">
                <x:document type="inline" select="/*/*">
                    <page xmlns="http://www.daisy.org/ns/2008/pef">
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠓⠑⠋⠞⠑⠀⠼⠁⠀⠁⠧⠀⠼⠁</row>
                    </page>
                </x:document>
            </x:expect>
        </x:scenario>
        
        <x:scenario label="2 volumes">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                            <head>
                                <meta name="dtb:uid" content="uid"/>
                                <meta name="dc:Creator" content="author"/>
                                <meta name="dc:Title" content="title"/>
                            </head>
                            <book>
                                <bodymatter>
                                    <level1 class="part"/>
                                    <level1 class="part"/>
                                </bodymatter>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('volume/2/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('volume/2/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('volume/2/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="row 27 on first page of first volume">
                <x:document type="file" base-uri="temp-dir" href="volume/2/pef-output-dir/book.pef" select="((//pef:volume)[1]//pef:page)[1]/pef:row[27]"/>
            </x:context>
            <x:expect label="should contain 'Hefte 1 av 2'" type="compare">
                <x:document type="inline" select="/*/*">
                    <page xmlns="http://www.daisy.org/ns/2008/pef">
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠓⠑⠋⠞⠑⠀⠼⠁⠀⠁⠧⠀⠼⠃</row>
                    </page>
                </x:document>
            </x:expect>
            
            <x:context label="row 27 on first page of second volume">
                <x:document type="file" base-uri="temp-dir" href="volume/2/pef-output-dir/book.pef" select="((//pef:volume)[2]//pef:page)[1]/pef:row[27]"/>
            </x:context>
            <x:expect label="should contain 'Hefte 1 av 2'" type="compare">
                <x:document type="inline" select="/*/*">
                    <page xmlns="http://www.daisy.org/ns/2008/pef">
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠓⠑⠋⠞⠑⠀⠼⠃⠀⠁⠧⠀⠼⠃</row>
                    </page>
                </x:document>
            </x:expect>
            
            <x:context label="rows 1-26 on first page of first volume">
                <x:document type="file" base-uri="temp-dir" href="volume/2/pef-output-dir/book.pef" select="(//pef:volume)[1]/(.//pef:page)[1]/pef:row[position() &lt;= 26]"/>
            </x:context>
            <x:expect label="should equal rows 1-26 of the second volume" type="compare">
                <x:document type="file" base-uri="temp-dir" href="volume/2/pef-output-dir/book.pef" select="(//pef:volume)[2]/(.//pef:page)[1]/pef:row[position() &lt;= 26]"/>
            </x:expect>
        </x:scenario>
    </x:scenario>
    
    <x:scenario label="about">
        <x:call step="nlb:dtbook-to-pef"/>
        
        <x:scenario label="about page content">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                            <head>
                                <meta name="dtb:uid" content="uid"/>
                                <meta name="dc:Creator" content="author"/>
                                <meta name="dc:Title" content="title"/>
                            </head>
                            <book>
                                <bodymatter/>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('about/1/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('about/1/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('about/1/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="page 2">
                <x:document type="file" base-uri="temp-dir" href="about/1/pef-output-dir/book.pef" select="(//pef:page)[2]"/>
            </x:context>
            <x:expect label="should contain 'Om boka'" type="xpath" test="contains(replace(string-join(.//pef:row/text(),'⠀'),'⠀+','⠀'), '⠠⠕⠍⠀⠃⠕⠅⠁')"/>
            <x:expect label="should contain 'Antall sider'" type="xpath" test="contains(replace(string-join(.//pef:row/text(),'⠀'),'⠀+','⠀'), '⠠⠁⠝⠞⠁⠇⠇⠀⠎⠊⠙⠑⠗⠒⠀⠼')"/>
            <x:expect label="should contain 'Boka skal ikke returneres.'" type="xpath" test="contains(replace(string-join(.//pef:row/text(),'⠀'),'⠀+','⠀'), '⠠⠃⠕⠅⠁⠀⠎⠅⠁⠇⠀⠊⠅⠅⠑⠀⠗⠑⠞⠥⠗⠝⠑⠗⠑⠎⠄')"/>
            <x:expect label="should contain 'Feil eller mangler kan meldes til punkt@nlb.no.'" type="xpath" test="contains(replace(string-join(.//pef:row/text(),'⠀'),'⠀+','⠀'), '⠠⠋⠑⠊⠇⠀⠑⠇⠇⠑⠗⠀⠍⠁⠝⠛⠇⠑⠗⠀⠅⠁⠝⠀⠍⠑⠇⠙⠑⠎⠀⠞⠊⠇⠀⠣⠏⠥⠝⠅⠞⠈⠝⠇⠃⠄⠝⠕⠄⠜')"/>
        </x:scenario>
    </x:scenario>
    
    <x:scenario label="toc">
        <x:call step="nlb:dtbook-to-pef">
            <x:input port="source">
                <x:document type="inline" xml:base="file:/tmp/book.xml">
                    <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                        <head>
                            <meta name="dtb:uid" content="uid"/>
                            <meta name="dc:Creator" content="author"/>
                            <meta name="dc:Title" content="title"/>
                        </head>
                        <book>
                            <bodymatter>
                                <level1>
                                    <h1>h1-1 short</h1>
                                    <level2>
                                        <h2>h2-1</h2>
                                        <level3>
                                            <h3>h3-1</h3>
                                        </level3>
                                        <level3>
                                            <h3>h3-2</h3>
                                        </level3>
                                    </level2>
                                    <level2>
                                        <h2>h2-2</h2>
                                    </level2>
                                </level1>
                                <level1>
                                    <h1>h1-2 long headline</h1>
                                </level1>
                            </bodymatter>
                        </book>
                    </dtbook>
                </x:document>
            </x:input>
        </x:call>
        
        <x:scenario label="toc-depth=0">
            <x:call>
                <x:option name="toc-depth" select="0"/>
                <x:option name="pef-output-dir" select="resolve-uri('toc/1/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('toc/1/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('toc/1/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="the first page containing 'Innhold'">
                <x:document type="file" base-uri="temp-dir" href="toc/1/pef-output-dir/book.pef" select="(//pef:page[contains(string-join(.//text(),''),'⠠⠊⠝⠝⠓⠕⠇⠙')])[1]"/>
            </x:context>
            <x:expect label="there should not be a TOC" type="count" max="0"/>
        </x:scenario>
        
        <x:scenario label="toc-depth=1">
            <x:call>
                <x:option name="toc-depth" select="1"/>
                <x:option name="pef-output-dir" select="resolve-uri('toc/2/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('toc/2/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('toc/2/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="the first page containing 'Innhold'">
                <x:document type="file" base-uri="temp-dir" href="toc/2/pef-output-dir/book.pef" select="(//pef:page[contains(string-join(.//text(),''),'⠠⠊⠝⠝⠓⠕⠇⠙')])[1]"/>
            </x:context>
            <x:expect label="there should be a TOC" type="count" min="1" max="1"/>
            <x:expect label="the TOC depth should be 1" type="xpath" test="count(distinct-values(.//text()[contains(.,'⠄⠄')]/string-length(replace(.,'[^⠀].*$',''))))" equals="1"/>
        </x:scenario>
        
        <x:scenario label="toc-depth=2">
            <x:call>
                <x:option name="toc-depth" select="2"/>
                <x:option name="pef-output-dir" select="resolve-uri('toc/3/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('toc/3/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('toc/3/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="the first page containing 'Innhold'">
                <x:document type="file" base-uri="temp-dir" href="toc/3/pef-output-dir/book.pef" select="(//pef:page[contains(string-join(.//text(),''),'⠠⠊⠝⠝⠓⠕⠇⠙')])[1]"/>
            </x:context>
            <x:expect label="there should be a TOC" type="count" min="1" max="1"/>
            <x:expect label="the TOC depth should be 2" type="xpath" test="count(distinct-values(.//text()[contains(.,'⠄⠄')]/string-length(replace(.,'[^⠀].*$',''))))" equals="2"/>
        </x:scenario>
        
        <x:scenario label="toc-depth=3">
            <x:call>
                <x:option name="toc-depth" select="3"/>
                <x:option name="pef-output-dir" select="resolve-uri('toc/4/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('toc/4/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('toc/4/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="the first page containing 'Innhold'">
                <x:document type="file" base-uri="temp-dir" href="toc/4/pef-output-dir/book.pef" select="(//pef:page[contains(string-join(.//text(),''),'⠠⠊⠝⠝⠓⠕⠇⠙')])[1]"/>
            </x:context>
            <x:expect label="there should be a TOC" type="count" min="1" max="1"/>
            <x:expect label="the TOC depth should be 3" type="xpath" test="count(distinct-values(.//text()[contains(.,'⠄⠄')]/string-length(replace(.,'[^⠀].*$',''))))" equals="3"/>
        </x:scenario>
        
        <x:scenario label="toc-depth=4">
            <x:call>
                <x:option name="toc-depth" select="4"/>
                <x:option name="pef-output-dir" select="resolve-uri('toc/5/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('toc/5/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('toc/5/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="the first page containing 'Innhold'">
                <x:document type="file" base-uri="temp-dir" href="toc/5/pef-output-dir/book.pef" select="(//pef:page[contains(string-join(.//text(),''),'⠠⠊⠝⠝⠓⠕⠇⠙')])[1]"/>
            </x:context>
            <x:expect label="there should be a TOC" type="count" min="1" max="1"/>
            <x:expect label="the TOC depth should be 3" type="xpath" test="count(distinct-values(.//text()[contains(.,'⠄⠄')]/string-length(replace(.,'[^⠀].*$',''))))" equals="3"/>
        </x:scenario>
    </x:scenario>
    
    <x:scenario label="pef-sections">
        <x:call step="nlb:dtbook-to-pef">
            <x:input port="source">
                <x:document type="inline" xml:base="file:/tmp/book.xml">
                    <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                        <head>
                            <meta name="dtb:uid" content="tests"/>
                        </head>
                        <book>
                            <frontmatter>
                                <level1>
                                    <h1>frontmatter</h1>
                                </level1>
                            </frontmatter>
                            <bodymatter>
                                <level1>
                                    <h1>bodymatter</h1>
                                </level1>
                            </bodymatter>
                        </book>
                    </dtbook>
                </x:document>
            </x:input>
        </x:call>
        
        <x:scenario label="duplex=true">
            <x:call step="nlb:dtbook-to-pef">
                <x:option name="duplex" select="'true'"/>
                <x:option name="pef-output-dir" select="resolve-uri('pef-sections/1/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('pef-sections/1/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('pef-sections/1/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="the sections containing the titlepage and about page">
                <x:document type="file" base-uri="temp-dir" href="pef-sections/1/pef-output-dir/book.pef" select="//pef:section[contains(string-join(.//pef:row/text(),''),'⠠⠠⠝⠇⠃⠀⠤⠀⠼') or contains(string-join(.//pef:row/text(),''),'⠠⠕⠍⠀⠃⠕⠅⠁')]"/>
            </x:context>
            <x:expect label="the titlepage and the about page should be in the same section" type="count" min="1" max="1"/>
            
            <x:context label="the pages in the section of the toc">
                <x:document type="file" base-uri="temp-dir" href="pef-sections/1/pef-output-dir/book.pef" select="//pef:section[contains(string-join(.//pef:row/text(),''),'⠠⠊⠝⠝⠓⠕⠇⠙')]//pef:page"/>
            </x:context>
            <x:expect label="there should not be other pages in the same section as the toc" type="count" min="1" max="1"/>
            
            <x:context label="the PEF">
                <x:document type="file" base-uri="temp-dir" href="pef-sections/1/pef-output-dir/book.pef"/>
            </x:context>
            <x:expect label="the titlepage should be in the first section" type="xpath" test="count(//pef:section[contains(string-join(.//pef:row/text(),''),'⠠⠠⠝⠇⠃⠀⠤⠀⠼')]/preceding::pef:section) + 1" equals="1"/>
            <x:expect label="the about page should be in the first section" type="xpath" test="count(//pef:section[contains(string-join(.//pef:row/text(),''),'⠠⠕⠍⠀⠃⠕⠅⠁')]/preceding::pef:section) + 1" equals="1"/>
            <x:expect label="the toc should be in the second section" type="xpath" test="count(//pef:section[contains(string-join(.//pef:row/text(),''),'⠠⠊⠝⠝⠓⠕⠇⠙')]/preceding::pef:section) + 1" equals="2"/>
            <x:expect label="the non-generated content should start in the third section" type="xpath" test="count(//pef:section[contains(string-join(.//pef:row/text(),''),'⠋⠗⠕⠝⠞⠍⠁⠞⠞⠑⠗')]/preceding::pef:section) + 1" equals="3"/>
        </x:scenario>
        
        <x:scenario label="duplex=false">
            <x:call step="nlb:dtbook-to-pef">
                <x:option name="duplex" select="'false'"/>
                <x:option name="pef-output-dir" select="resolve-uri('pef-sections/2/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('pef-sections/2/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('pef-sections/2/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="the sections containing the titlepage and about page">
                <x:document type="file" base-uri="temp-dir" href="pef-sections/2/pef-output-dir/book.pef" select="//pef:section[contains(string-join(.//pef:row/text(),''),'⠠⠠⠝⠇⠃⠀⠤⠀⠼') or contains(string-join(.//pef:row/text(),''),'⠠⠕⠍⠀⠃⠕⠅⠁')]"/>
            </x:context>
            <x:expect label="the titlepage and the about page should be in the same section" type="count" min="1" max="1"/>
            
            <x:context label="the pages in the section of the toc">
                <x:document type="file" base-uri="temp-dir" href="pef-sections/2/pef-output-dir/book.pef" select="//pef:section[contains(string-join(.//pef:row/text(),''),'⠠⠊⠝⠝⠓⠕⠇⠙')]//pef:page"/>
            </x:context>
            <x:expect label="there should not be other pages in the same section as the toc" type="count" min="1" max="1"/>
            
            <x:context label="the PEF">
                <x:document type="file" base-uri="temp-dir" href="pef-sections/2/pef-output-dir/book.pef"/>
            </x:context>
            <x:expect label="the titlepage should be in the first section" type="xpath" test="count(//pef:section[contains(string-join(.//pef:row/text(),''),'⠠⠠⠝⠇⠃⠀⠤⠀⠼')]/preceding::pef:section) + 1" equals="1"/>
            <x:expect label="the about page should be in the first section" type="xpath" test="count(//pef:section[contains(string-join(.//pef:row/text(),''),'⠠⠕⠍⠀⠃⠕⠅⠁')]/preceding::pef:section) + 1" equals="1"/>
            <x:expect label="the toc should be in the second section" type="xpath" test="count(//pef:section[contains(string-join(.//pef:row/text(),''),'⠠⠊⠝⠝⠓⠕⠇⠙')]/preceding::pef:section) + 1" equals="2"/>
            <x:expect label="the non-generated content should start in the third section" type="xpath" test="count(//pef:section[contains(string-join(.//pef:row/text(),''),'⠋⠗⠕⠝⠞⠍⠁⠞⠞⠑⠗')]/preceding::pef:section) + 1" equals="3"/>
        </x:scenario>
    </x:scenario>
    
    <x:scenario label="DTBook frontmatter should not be duplicated (issue 93)">
        <x:call step="nlb:dtbook-to-pef">
            <x:input port="source">
                <x:document type="inline" xml:base="file:/tmp/book.xml">
                    <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                        <head>
                            <meta name="dtb:uid" content="tests"/>
                        </head>
                        <book>
                            <frontmatter>
                                <doctitle>tests</doctitle>
                                <level1>
                                    <p>Forordet skal ikke være annerledes en det som kommer etterpå; margene skal være de samme - og det skal være økt linjeavstand</p>
                                </level1>
                            </frontmatter>
                            <bodymatter>
                                <level1>
                                    <p>Boka har ingen overskrifter, men det betyr ikke at det ikke skal være toppmarg ved begynnelsen. Den har økt linjeavstand.</p>
                                    <imggroup>
                                        <img src="xxx.jpg" alt="Bildet viser konturene av ingenting mot en lysabsorberende flate av tomhet. Kontrastene er ikke akkurat til å ta og føle på."/> 
                                    </imggroup>
                                </level1>
                            </bodymatter>
                        </book>
                    </dtbook>
                </x:document>
            </x:input>
            <x:option name="pef-output-dir" select="resolve-uri('4/pef-output-dir',$temp-dir)"/>
            <x:option name="preview-output-dir" select="resolve-uri('4/preview-output-dir',$temp-dir)"/>
            <x:option name="temp-dir" select="resolve-uri('4/temp-dir',$temp-dir)"/>
        </x:call>
        <x:context label="result">
            <x:document type="file" base-uri="temp-dir" href="4/pef-output-dir/book.pef"/>
        </x:context>
        <x:expect label="The text 'Forordet skal' should only occur once" type="xpath" test="count(//pef:row[contains(text(),'⠠⠋⠕⠗⠕⠗⠙⠑⠞⠀⠎⠅⠁⠇')])" equals="1"/>
    </x:scenario>
    
    <x:scenario label="double linespacing should work inside the DTBook frontmatter (see comment on issue 93)">
        <x:call step="nlb:dtbook-to-pef">
            <x:input port="source">
                <x:document type="inline" xml:base="file:/tmp/book.xml">
                    <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                        <head>
                            <meta name="dtb:uid" content="tests"/>
                        </head>
                        <book>
                            <frontmatter>
                                <doctitle>tests</doctitle>
                                <level1>
                                    <p>Forordet skal ikke være annerledes en det som kommer etterpå; margene skal være de samme - og det skal være økt linjeavstand</p>
                                </level1>
                            </frontmatter>
                            <bodymatter>
                                <level1>
                                    <p>Boka har ingen overskrifter, men det betyr ikke at det ikke skal være toppmarg ved begynnelsen. Den har økt linjeavstand.</p>
                                    <imggroup>
                                        <img src="xxx.jpg" alt="Bildet viser konturene av ingenting mot en lysabsorberende flate av tomhet. Kontrastene er ikke akkurat til å ta og føle på."/> 
                                    </imggroup>
                                </level1>
                            </bodymatter>
                        </book>
                    </dtbook>
                </x:document>
            </x:input>
        </x:call>
        
        <x:scenario label="single line spacing">
            <x:call>
                <x:option name="line-spacing" select="'single'"/>
                <x:option name="pef-output-dir" select="resolve-uri('5/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('5/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('5/temp-dir',$temp-dir)"/>
            </x:call>
            <x:context label="result">
                <x:document type="file" base-uri="temp-dir" href="5/pef-output-dir/book.pef"/>
            </x:context>
            <x:expect label="The row after the row containing 'Forordet skal', should not be empty and there should be no rowgap" type="xpath" test="(//pef:row[contains(text(),'⠠⠋⠕⠗⠕⠗⠙⠑⠞⠀⠎⠅⠁⠇')])[1]/((not(@rowgap) or @rowgap = '0') and following-sibling::pef:row[1]/replace(text(),'[\s⠀]','') != '')"/>
        </x:scenario>
        
        <x:scenario label="double line spacing">
            <x:call>
                <x:option name="line-spacing" select="'double'"/>
                <x:option name="pef-output-dir" select="resolve-uri('6/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('6/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('6/temp-dir',$temp-dir)"/>
            </x:call>
            <x:context label="result">
                <x:document type="file" base-uri="temp-dir" href="6/pef-output-dir/book.pef"/>
            </x:context>
            <x:expect label="Either rowgap should be 4, or the row after the row containing 'Forordet skal', should be empty" type="xpath" test="(//pef:row[contains(text(),'⠠⠋⠕⠗⠕⠗⠙⠑⠞⠀⠎⠅⠁⠇')])[1]/(@rowgap = '4' or following-sibling::pef:row[1]/replace(text(),'[\s⠀]','') = '')"/>
        </x:scenario>
    </x:scenario>
    
    <x:scenario label="margins in frontmatter should be the same as in bodymatter (see comment on issue 93)">
        <x:call step="nlb:dtbook-to-pef">
            <x:input port="source">
                <x:document type="inline" xml:base="file:/tmp/book.xml">
                    <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                        <head>
                            <meta name="dtb:uid" content="test"/>
                        </head>
                        <book>
                            <frontmatter>
                                <doctitle>test</doctitle>
                                <level1>
                                    <p>frontmatter xxxxxx</p>
                                    <p>frontmatter xxxxxxx</p>
                                    <p>frontmatter xxxxxxxx</p>
                                    <p>frontmatter xxxxxxxxx</p>
                                    <p>frontmatter xxxxxxxxxx</p>
                                    <p>frontmatter xxxxxxxxxxx</p>
                                    <p>frontmatter xxxxxxxxxxxx</p>
                                    <p>frontmatter xxxxxxxxxxxxx</p>
                                    <p>frontmatter xxxxxxxxxxxxxx</p>
                                    <p>frontmatter xxxxxxxxxxxxxxx</p>
                                    <p>frontmatter xxxxxxxxxxxxxxxx</p>
                                    <p>frontmatter xxxxxxxxxxxxxxxxx</p>
                                    <p>frontmatter xxxxxxxxxxxxxxxxxx</p>
                                    <p>frontmatter xxxxxxxxxxxxxxxxxxx</p>
                                </level1>
                            </frontmatter>
                            <bodymatter>
                                <level1>
                                    <p>bodymatter xxxxxxxx</p>
                                    <p>bodymatter xxxxxxxxx</p>
                                    <p>bodymatter xxxxxxxxxx</p>
                                    <p>bodymatter xxxxxxxxxxx</p>
                                    <p>bodymatter xxxxxxxxxxxx</p>
                                    <p>bodymatter xxxxxxxxxxxxx</p>
                                    <p>bodymatter xxxxxxxxxxxxxx</p>
                                    <p>bodymatter xxxxxxxxxxxxxxx</p>
                                    <p>bodymatter xxxxxxxxxxxxxxxx</p>
                                    <p>bodymatter xxxxxxxxxxxxxxxxx</p>
                                    <p>bodymatter xxxxxxxxxxxxxxxxxx</p>
                                    <p>bodymatter xxxxxxxxxxxxxxxxxxx</p>
                                    <p>bodymatter xxxxxxxxxxxxxxxxxxxx</p>
                                    <p>bodymatter xxxxxxxxxxxxxxxxxxxxx</p>
                                </level1>
                            </bodymatter>
                        </book>
                    </dtbook>
                </x:document>
            </x:input>
            <x:option name="page-width" select="32"/>
            <x:option name="pef-output-dir" select="resolve-uri('7/pef-output-dir',$temp-dir)"/>
            <x:option name="preview-output-dir" select="resolve-uri('7/preview-output-dir',$temp-dir)"/>
            <x:option name="temp-dir" select="resolve-uri('7/temp-dir',$temp-dir)"/>
        </x:call>
        
        <x:context label="result">
            <x:document type="file" base-uri="temp-dir" href="7/pef-output-dir/book.pef"/>
        </x:context>
        <x:expect label="The left margins should be the same in frontmatter and bodymatter" type="xpath"
            test="min(//pef:row[contains(text(),'⠋⠗⠕⠝⠞⠍⠁⠞⠞⠑⠗')]/string-length(replace(text(),'^(⠀*).+?$','$1','s')))"
            equals="min(//pef:row[contains(text(),'⠃⠕⠙⠽⠍⠁⠞⠞⠑⠗')]/string-length(replace(text(),'^(⠀*).+?$','$1','s')))"/>
        <x:expect label="The right margins should be the same in frontmatter and bodymatter" type="xpath"
            test="min(//pef:row[contains(text(),'⠋⠗⠕⠝⠞⠍⠁⠞⠞⠑⠗')]/(string-length(replace(text(),'^.+?(⠀*)$','$1','s')) + (32 - string-length(text()))))"
            equals="min(//pef:row[contains(text(),'⠃⠕⠙⠽⠍⠁⠞⠞⠑⠗')]/(string-length(replace(text(),'^.+?(⠀*)$','$1','s')) + (32 - string-length(text()))))"/>
    </x:scenario>
    
</x:description>