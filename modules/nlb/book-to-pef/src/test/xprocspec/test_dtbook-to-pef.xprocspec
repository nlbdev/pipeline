<?xml version="1.0" encoding="UTF-8"?>
<?xml-model href="http://www.daisy.org/ns/xprocspec/xprocspec.rng" type="application/xml" schematypens="http://relaxng.org/ns/structure/1.0"?>
<x:description xmlns:x="http://www.daisy.org/ns/xprocspec"
    xmlns:p="http://www.w3.org/ns/xproc"
    xmlns:px="http://www.daisy.org/ns/pipeline/xproc"
    xmlns:nlb="http://www.nlb.no/ns/pipeline/xproc"
    xmlns:pef="http://www.daisy.org/ns/2008/pef"
    script="http://www.nlb.no/pipeline/modules/braille/dtbook-to-pef.xpl">
    
    <x:scenario label="_">
        <x:call step="nlb:dtbook-to-pef">
            <x:option name="toc-depth" select="0"/>
        </x:call>
        
        <x:scenario label="basic test">
            <x:call>
                <x:input port="source">
                    <x:document type="file" href="../resources/DTBook/book.xml"/>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('1/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('1/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('1/temp-dir',$temp-dir)"/>
            </x:call>
            <x:context label="the output directory contents">
                <x:document type="directory" base-uri="temp-dir" href="1/pef-output-dir/"/>
            </x:context>
            <x:expect label="Exactly one PEF file should be present in the output directory" type="xpath"
                test="count(/*/*[ends-with(@name,'.pef')])" equals="1"/>
        </x:scenario>
        
        <x:scenario label="ability to override css rules - with a link element">
            <x:call>
                <x:input port="source">
                    <x:document type="file" href="../resources/DTBook-override-css/book-with-link.xml"/>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('2/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('2/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('2/temp-dir',$temp-dir)"/>
            </x:call>
            <x:context label="the output directory contents">
                <x:document type="file" base-uri="temp-dir" href="2/pef-output-dir/book-with-link.pef" select="(//pef:row[contains(text(),'⠠⠞⠑⠎⠞⠁⠧⠎⠝⠊⠞⠞⠄')])[1]"/>
            </x:context>
            <x:expect label="The paragraph should be indented by 6 (2 page margin-left, 4 p text-indent)" type="compare">
                <x:document type="inline">
                    <row xmlns="http://www.daisy.org/ns/2008/pef">⠀⠀⠀⠀⠀⠀⠠⠞⠑⠎⠞⠁⠧⠎⠝⠊⠞⠞⠄</row>
                </x:document>
            </x:expect>
        </x:scenario>
        
        <x:scenario label="ability to override css rules - by passing a css file into the script">
            <x:call>
                <x:input port="source">
                    <x:document type="file" href="../resources/DTBook-override-css/book.xml"/>
                </x:input>
                <x:option name="stylesheet" select="resolve-uri('../resources/DTBook-override-css/indent-p.css')"/>
                <x:option name="pef-output-dir" select="resolve-uri('3/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('3/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('3/temp-dir',$temp-dir)"/>
            </x:call>
            <x:context label="the output directory contents">
                <x:document type="file" base-uri="temp-dir" href="3/pef-output-dir/book.pef" select="(//pef:row[contains(text(),'⠠⠞⠑⠎⠞⠁⠧⠎⠝⠊⠞⠞⠄')])[1]"/>
            </x:context>
            <x:expect label="The paragraph should be indented by 6 (2 page margin-left, 4 p text-indent)" type="compare">
                <x:document type="inline">
                    <row xmlns="http://www.daisy.org/ns/2008/pef">⠀⠀⠀⠀⠀⠀⠠⠞⠑⠎⠞⠁⠧⠎⠝⠊⠞⠞⠄</row>
                </x:document>
            </x:expect>
        </x:scenario>
        
        <x:scenario label="ability to convert non-norwegian books">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook version="2005-3" xml:lang="en" xmlns="http://www.daisy.org/z3986/2005/dtbook/">
                            <head>
                                <meta name="dtb:uid" content="123456"/>
                                <meta name="dc:Title" content="Testbok"/>
                                <meta name="dc:Creator" content="Norsk lyd- og blindeskriftbibliotek"/>
                                <meta name="dc:Date" content="2016-03-01"/>
                                <meta name="dc:Publisher" content="NLB"/>
                                <meta name="dc:Language" content="en"/>
                            </head>
                            <book>
                                <frontmatter>
                                    <doctitle>Test book</doctitle>
                                    <docauthor>Norwegian library for talking books and braille</docauthor>
                                </frontmatter>
                                <bodymatter>
                                    <level1>
                                        <h1>This is a test headline</h1>
                                        <p>This is a test paragraph.</p>
                                    </level1>
                                </bodymatter>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('4/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('4/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('4/temp-dir',$temp-dir)"/>
            </x:call>
            <x:context label="the output directory contents">
                <x:document type="directory" base-uri="temp-dir" href="4/pef-output-dir/"/>
            </x:context>
            <x:expect label="Exactly one PEF file should be present in the output directory" type="xpath" test="count(/*/*[ends-with(@name,'.pef')])" equals="1"/>
        </x:scenario>
        
        <x:scenario label="test for other languages">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook version="2005-3" xml:lang="no" xmlns="http://www.daisy.org/z3986/2005/dtbook/">
                            <head>
                                <meta name="dtb:uid" content="123456"/>
                                <meta name="dc:Title" content="Testbok"/>
                                <meta name="dc:Creator" content="Norsk lyd- og blindeskriftbibliotek"/>
                                <meta name="dc:Date" content="2016-03-01"/>
                                <meta name="dc:Publisher" content="NLB"/>
                                <meta name="dc:Language" content="no"/>
                                <style media="embossed" type="text/css">
                                    @page {
                                        size: 35 28;
                                        margin-top: 0;
                                        margin-left: 0;
                                        @left {
                                            content: none;
                                        }
                                    }
                                    h1, h2, h3, p {
                                        text-indent: 0;
                                        text-align: left;
                                        margin-left: 0;
                                        border: none;
                                        text-transform: auto;
                                    }
                                </style>
                            </head>
                            <book>
                                <frontmatter>
                                    <doctitle>Test</doctitle>
                                    <docauthor>Test</docauthor>
                                </frontmatter>
                                <bodymatter>
                                    <level1 xml:lang="no">
                                        <h1>aa ll bb cc</h1>
                                        <p xml:lang="no">aaa bb cc</p>
                                        <p xml:lang="en">aaa bb cc</p>
                                        <p xml:lang="no">aaa bb cc</p>
                                        <p xml:lang="fr">aaa bb cc</p>
                                        <level2 xml:lang="en">
                                            <h2>aa ll bb cc</h2>
                                            <p xml:lang="no">aaa bb cc</p>
                                            <p xml:lang="en">aaa bb cc</p>
                                            <p xml:lang="no">aaa bb cc</p>
                                            <p xml:lang="fr">aaa bb cc</p>
                                            <level3 xml:lang="no">
                                                <h3>aa ll bb cc</h3>
                                                <p xml:lang="no">aaa bb cc</p>
                                                <p xml:lang="en">aaa bb cc</p>
                                                <p xml:lang="no">aaa bb cc</p>
                                                <p xml:lang="fr">aaa bb cc</p>
                                            </level3>
                                        </level2>
                                    </level1>
                                </bodymatter>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="braille-standard" select="'(dots:6)(grade:0)'"/>
                <x:option name="show-print-page-numbers" select="'false'"/>
                <x:option name="pef-output-dir" select="resolve-uri('5/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('5/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('5/temp-dir',$temp-dir)"/>
            </x:call>
            <x:context label="result">
                <x:document type="file" base-uri="temp-dir" href="5/pef-output-dir/book.pef" select="//pef:page[pef:row[contains(text(),'⠁⠁⠀⠇⠇⠀⠃⠃⠀⠉⠉')]]/pef:row[text() and following-sibling::pef:row]"/>
            </x:context>
            <x:expect label="result" type="compare">
                <x:document type="inline" select="//pef:row">
                    <_ xmlns="http://www.daisy.org/ns/2008/pef">
                        <row>⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                        <row>⠁⠁⠀⠇⠇⠀⠃⠃⠀⠉⠉</row>
                        <row>⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                        <row>⠁⠁⠁⠀⠃⠃⠀⠉⠉</row>
                        <row>⠁⠁⠁⠀⠃⠃⠀⠉⠉</row>
                        <row>⠁⠁⠁⠀⠃⠃⠀⠉⠉</row>
                        <row>⠁⠁⠁⠀⠃⠃⠀⠉⠉</row>
                        <row>⠁⠁⠀⠇⠇⠀⠃⠃⠀⠉⠉</row>
                        <row>⠁⠁⠁⠀⠃⠃⠀⠉⠉</row>
                        <row>⠁⠁⠁⠀⠃⠃⠀⠉⠉</row>
                        <row>⠁⠁⠁⠀⠃⠃⠀⠉⠉</row>
                        <row>⠁⠁⠁⠀⠃⠃⠀⠉⠉</row>
                        <row>⠁⠁⠀⠇⠇⠀⠃⠃⠀⠉⠉</row>
                        <row>⠁⠁⠁⠀⠃⠃⠀⠉⠉</row>
                        <row>⠁⠁⠁⠀⠃⠃⠀⠉⠉</row>
                        <row>⠁⠁⠁⠀⠃⠃⠀⠉⠉</row>
                        <row>⠁⠁⠁⠀⠃⠃⠀⠉⠉</row>
                    </_>
                </x:document>
            </x:expect>
        </x:scenario>
        
        <x:scenario label="test for text-transform:uncontracted other languages">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook version="2005-3" xml:lang="no" xmlns="http://www.daisy.org/z3986/2005/dtbook/">
                            <head>
                                <meta name="dtb:uid" content="123456"/>
                                <meta name="dc:Title" content="Testbok"/>
                                <meta name="dc:Creator" content="Norsk lyd- og blindeskriftbibliotek"/>
                                <meta name="dc:Date" content="2016-03-01"/>
                                <meta name="dc:Publisher" content="NLB"/>
                                <meta name="dc:Language" content="no"/>
                                <style media="embossed" type="text/css">
                                    @page {
                                      size: 35 28;
                                      margin-top: 0;
                                      margin-left: 0;
                                      @left {
                                        content: none;
                                      }
                                    }
                                    h1, h2, h3, p {
                                      text-indent: 0;
                                      text-align: left;
                                      margin-left: 0;
                                      border: none;
                                    }
                                </style>
                            </head>
                            <book>
                                <frontmatter>
                                    <doctitle>l</doctitle>
                                    <docauthor>a</docauthor>
                                </frontmatter>
                                <bodymatter>
                                    <level1>
                                        <p>a ble at ll</p>
                                        <p xml:lang="en">a ble at ll</p>
                                        <level2 xml:lang="en">
                                            <p>a ble at ll</p>
                                        </level2>
                                    </level1>
                                </bodymatter>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="braille-standard" select="'(dots:6)(grade:1)'"/>
                <x:option name="show-print-page-numbers" select="'false'"/>
                <x:option name="pef-output-dir" select="resolve-uri('6/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('6/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('6/temp-dir',$temp-dir)"/>
            </x:call>
            <x:context label="result">
                <x:document type="file" base-uri="temp-dir" href="6/pef-output-dir/book.pef" select="(//pef:page)[last()]//pef:row[text() != '' and not(contains(text(),'⠼'))]"/>
            </x:context>
            <x:expect label="result" type="compare">
                <x:document type="inline" select="//pef:row">
                    <_ xmlns="http://www.daisy.org/ns/2008/pef">
                        <row>⠰⠁⠀⠃⠀⠁⠀⠇⠇</row>
                        <row>⠁⠀⠃⠇⠑⠀⠁⠞⠀⠇⠇</row>
                        <row>⠁⠀⠃⠇⠑⠀⠁⠞⠀⠇⠇</row>
                    </_>
                </x:document>
            </x:expect>
        </x:scenario>
        
        <x:scenario label="test for contracted norwegian inside other languages" pending="https://github.com/nlbdev/pipeline/issues/73">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook version="2005-3" xml:lang="no" xmlns="http://www.daisy.org/z3986/2005/dtbook/">
                            <head>
                                <meta name="dtb:uid" content="123456"/>
                                <meta name="dc:Title" content="Testbok"/>
                                <meta name="dc:Creator" content="Norsk lyd- og blindeskriftbibliotek"/>
                                <meta name="dc:Date" content="2016-03-01"/>
                                <meta name="dc:Publisher" content="NLB"/>
                                <meta name="dc:Language" content="no"/>
                                <style media="embossed" type="text/css">
                                    @page {
                                      size: 35 28;
                                      margin-top: 0;
                                      margin-left: 0;
                                      @left {
                                        content: none;
                                      }
                                    }
                                    h1, h2, h3, p {
                                      text-indent: 0;
                                      text-align: left;
                                      margin-left: 0;
                                      border: none;
                                    }
                                </style>
                            </head>
                            <book>
                                <frontmatter>
                                    <doctitle>l</doctitle>
                                    <docauthor>a</docauthor>
                                </frontmatter>
                                <bodymatter>
                                    <level1>
                                        <p>a ble at ll</p>
                                        <level2 xml:lang="en">
                                            <p>a ble at ll</p>
                                            <p xml:lang="no">a ble at ll</p>
                                            <div xml:lang="no">
                                                <p>a ble at ll</p>
                                            </div>
                                            <p>a ble at ll</p>
                                        </level2>
                                    </level1>
                                </bodymatter>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="braille-standard" select="'(dots:6)(grade:1)'"/>
                <x:option name="show-print-page-numbers" select="'false'"/>
                <x:option name="pef-output-dir" select="resolve-uri('7/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('7/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('7/temp-dir',$temp-dir)"/>
            </x:call>
            <x:context label="result">
                <x:document type="file" base-uri="temp-dir" href="7/pef-output-dir/book.pef" select="(//pef:page)[last()]//pef:row[text() != '' and not(contains(text(),'⠼'))]"/>
            </x:context>
            <x:expect label="result" type="compare">
                <x:document type="inline" select="//pef:row">
                    <_ xmlns="http://www.daisy.org/ns/2008/pef">
                        <row>⠰⠁⠀⠃⠀⠁⠀⠇⠇</row>
                        <row>⠁⠀⠃⠇⠑⠀⠁⠞⠀⠇⠇</row>
                        <row>⠰⠁⠀⠃⠀⠁⠀⠇⠇</row>
                        <row>⠰⠁⠀⠃⠀⠁⠀⠇⠇</row>
                        <row>⠁⠀⠃⠇⠑⠀⠁⠞⠀⠇⠇</row>
                    </_>
                </x:document>
            </x:expect>
        </x:scenario>
        
        <x:scenario label="regression test for issue where dot 56 is sometimes missing in contraction (issue nlbdev/pipeline#70)">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook version="2005-3" xml:lang="no" xmlns="http://www.daisy.org/z3986/2005/dtbook/">
                            <head>
                                <meta name="dtb:uid" content="123456"/>
                                <meta name="dc:Creator" content="a ble at l"/>
                                <meta name="dc:Title" content="Testbok"/>
                                <meta name="dc:Date" content="2016-03-01"/>
                                <meta name="dc:Publisher" content="NLB"/>
                                <meta name="dc:Language" content="no"/>
                                <style media="embossed" type="text/css">
                                    @page {
                                       size: 35 28;
                                       margin-top: 0;
                                       margin-left: 0;
                                       @left {
                                           content: none;
                                        }
                                    }
                                    h1, h2, h3, p {
                                        text-indent: 0;
                                        text-align: left;
                                        margin-left: 0;
                                        border: none;
                                    }
                                    .first-page p {
                                        text-align: left;
                                    }
                                </style>
                            </head>
                            <book>
                                <frontmatter>
                                    <doctitle>l</doctitle>
                                    <docauthor>a</docauthor>
                                </frontmatter>
                                <bodymatter>
                                    <level1>
                                        <p>a ble at l</p>
                                    </level1>
                                </bodymatter>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="braille-standard" select="'(dots:6)(grade:1)'"/>
                <x:option name="show-print-page-numbers" select="'false'"/>
                <x:option name="pef-output-dir" select="resolve-uri('8/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('8/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('8/temp-dir',$temp-dir)"/>
            </x:call>
            <x:context label="result">
                <x:document type="file" base-uri="temp-dir" href="8/pef-output-dir/book.pef" select="//pef:row[contains(text(),'⠃⠀⠁')]"/>
            </x:context>
            <x:expect label="result" type="compare">
                <x:document type="inline" select="//pef:row">
                    <_ xmlns="http://www.daisy.org/ns/2008/pef">
                        <row>⠰⠁⠀⠃⠀⠁⠀⠰⠇</row>
                    </_>
                </x:document>
            </x:expect>
        </x:scenario>
        
        <x:scenario label="List test">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook version="2005-3" xml:lang="no" xmlns="http://www.daisy.org/z3986/2005/dtbook/">
                            <head>
                                <meta name="dtb:uid" content="557901"/>
                                <meta name="dc:Title" content="ULVEGUTTEN TAL - BOK 1"/>
                                <meta name="dc:Identifier" content="557901"/>
                                <meta name="track:Guidelines" content="2015-1"/>
                                <meta name="track:Supplier" content="AEL Data"/>
                                <meta name="dc:Language" content="no"/>
                                <meta name="dc:Format" content="DTBook"/>
                                <meta name="dc:Creator" content="aa ll"/>
                                <meta name="dc:Creator" content="bb"/>
                                <meta name="dc:Creator" content="ll"/>
                                <meta name="dc:Creator" content="rr"/>
                                <meta name="dc:Creator" content="zz"/>
                                <meta name="dc:Contributor" content="ll"/>
                                <meta name="dc:Contributor" content="cc"/>
                                <meta name="dc:Contributor" content="gg"/>
                                <meta name="dc:Contributor" content="xx"/>
                                <meta name="dc:Date" content="2015-11-07"/>
                                <meta name="dc:Publisher" content="NLB"/>
                                <meta name="dc:Source" content="urn:isbn:9788202459543"/>
                                <meta name="dcterms:modified" content="2015-11-09T09:06:58+00:00"/>
                            </head>
                            <book>
                                <body>
                                    <level1>
                                        <p>aaa.</p>
                                        <list type="ul">
                                            <li>aaa aaa</li>
                                            <li>bbb bbb
                                                <list type="ul">
                                                    <li>lll lll</li>
                                                    <li>rrr rrr</li>
                                                    <li>aaa aaa </li>
                                                </list>
                                            </li>
                                            <li>ccc ccc</li>
                                        </list>
                                        <p>bbb</p>
                                        <list type="ol">
                                            <li>aaa aaa</li>
                                            <li>bbb bbb
                                                <list type="ol">
                                                    <li>lll lll</li>
                                                    <li>rrr rrr</li>
                                                    <li>aaa aaa </li>
                                                </list>
                                            </li>
                                            <li>ccc ccc</li>
                                        </list>
                                    </level1>
                                </body>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="braille-standard" select="'(dots:6)(grade:0)'"/>
                <x:option name="show-print-page-numbers" select="'true'"/>
                <x:option name="pef-output-dir" select="resolve-uri('9/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('9/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('9/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="result">
                <x:document type="file" base-uri="temp-dir" href="9/pef-output-dir/book.pef"  select="(//pef:page)[last()]"/>
            </x:context>
            <x:expect label="result" type="compare">
                <x:document type="inline">
                                <page xmlns="http://www.daisy.org/ns/2008/pef">
                                    <row>⠀⠀⠀⠀⠁⠁⠁⠄</row>
                                    <row>⠀⠀⠀⠀⠀⠀⠤⠀⠁⠁⠁⠀⠁⠁⠁</row>
                                    <row>⠀⠀⠀⠀⠀⠀⠤⠀⠃⠃⠃⠀⠃⠃⠃</row>
                                    <row>⠀⠀⠀⠀⠀⠀⠀⠀⠤⠀⠇⠇⠇⠀⠇⠇⠇</row>
                                    <row>⠀⠀⠀⠀⠀⠀⠀⠀⠤⠀⠗⠗⠗⠀⠗⠗⠗</row>
                                    <row>⠀⠀⠀⠀⠀⠀⠀⠀⠤⠀⠁⠁⠁⠀⠁⠁⠁</row>
                                    <row/>
                                    <row>⠀⠀⠀⠀⠀⠀⠤⠀⠉⠉⠉⠀⠉⠉⠉</row>
                                    <row/>
                                    <row>⠀⠀⠀⠀⠃⠃⠃</row>
                                    <row>⠀⠀⠀⠀⠀⠀⠼⠁⠀⠁⠁⠁⠀⠁⠁⠁</row>
                                    <row>⠀⠀⠀⠀⠀⠀⠼⠃⠀⠃⠃⠃⠀⠃⠃⠃</row>
                                    <row>⠀⠀⠀⠀⠀⠀⠀⠀⠼⠁⠀⠇⠇⠇⠀⠇⠇⠇</row>
                                    <row>⠀⠀⠀⠀⠀⠀⠀⠀⠼⠃⠀⠗⠗⠗⠀⠗⠗⠗</row>
                                    <row>⠀⠀⠀⠀⠀⠀⠀⠀⠼⠉⠀⠁⠁⠁⠀⠁⠁⠁</row>
                                    <row/>
                                    <row>⠀⠀⠀⠀⠀⠀⠼⠉⠀⠉⠉⠉⠀⠉⠉⠉</row>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                                </page>
                </x:document>
            </x:expect>
        </x:scenario>
        
        <x:scenario label="Test for requirements/#4.7:102 volume x av y">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook version="2005-3" xml:lang="no" xmlns="http://www.daisy.org/z3986/2005/dtbook/">
                            <head>
                                <style type="text/css" media="embossed">
                                    @volume {
                                        max-length: 5;
                                    }
                                </style>
                                <meta name="dtb:uid" content="557901"/>
                                <meta name="dc:Title" content="ULVEGUTTEN TAL - BOK 1"/>
                                <meta name="dc:Identifier" content="557901"/>
                                <meta name="dc:Creator" content="aa ll"/>
                            </head>
                            <book>
                                <frontmatter>
                                    <doctitle>doctitle</doctitle>
                                </frontmatter>
                                <bodymatter>
                                    <level1 class="part">
                                        <p>volume 1</p>
                                    </level1>
                                    <level1 class="part">
                                        <p>volume 2</p>
                                    </level1>
                                    <level1 class="part">
                                        <p>volume 3</p>
                                    </level1>
                                    <level1 class="part">
                                        <p>volume 4</p>
                                    </level1>
                                </bodymatter>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="braille-standard" select="'(dots:6)(grade:0)'"/>
                <x:option name="show-print-page-numbers" select="'true'"/>
                <x:option name="pef-output-dir" select="resolve-uri('10/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('10/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('10/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="result">
                <x:document type="file" base-uri="temp-dir" href="10/pef-output-dir/book.pef" select="//pef:volume//pef:row[matches(text(),'.*⠠⠓⠑⠋⠞⠑⠀⠼.*⠀⠁⠧⠀⠼.*') or matches(text(),'.*⠧⠕⠇⠥⠍⠑⠀⠼*')]"/>
            </x:context>
            <x:expect label="result" type="compare">
                <x:document type="inline" select="/*/*">
                    <_ xmlns="http://www.daisy.org/ns/2008/pef">
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠓⠑⠋⠞⠑⠀⠼⠁⠀⠁⠧⠀⠼⠙</row>
                        <row>⠀⠀⠀⠀⠧⠕⠇⠥⠍⠑⠀⠼⠁</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠓⠑⠋⠞⠑⠀⠼⠃⠀⠁⠧⠀⠼⠙</row>
                        <row>⠀⠀⠀⠀⠧⠕⠇⠥⠍⠑⠀⠼⠃</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠓⠑⠋⠞⠑⠀⠼⠉⠀⠁⠧⠀⠼⠙</row>
                        <row>⠀⠀⠀⠀⠧⠕⠇⠥⠍⠑⠀⠼⠉</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠓⠑⠋⠞⠑⠀⠼⠙⠀⠁⠧⠀⠼⠙</row>
                        <row>⠀⠀⠀⠀⠧⠕⠇⠥⠍⠑⠀⠼⠙</row>
                    </_>
                </x:document>
            </x:expect>
        </x:scenario>
        
        <x:scenario label="test for character">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook version="2005-3" xml:lang="no" xmlns="http://www.daisy.org/z3986/2005/dtbook/">
                            <head>
                                <meta name="dtb:uid" content="557901"/>
                            </head>
                            <book>
                                <body>
                                    <level1>
                                        <p>á Š š </p>
                                        <p>kort-  lang—</p>  <!-- short and long dash after word -->
                                        <p>-kort  —lang</p>  <!-- short and long dash before word -->
                                        <p>aa-bb  aa—bb</p>  <!-- short and long dash between word -->
                                        <p>aa — bb</p>  <!--  long dash alone -->
                                        <p>aa - bb</p>  <!--  short dash alone -->
                                    </level1>
                                </body>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="braille-standard" select="'(dots:6)(grade:0)'"/>
                <x:option name="show-print-page-numbers" select="'true'"/>
                <x:option name="pef-output-dir" select="resolve-uri('11/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('11/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('11/temp-dir',$temp-dir)"/>
            </x:call>
            <x:context label="result">
                <x:document type="file" base-uri="temp-dir" href="11/pef-output-dir/book.pef"  select="(//pef:page)[last()]"/>
            </x:context>
            <x:expect label="result" type="compare">
                <x:document type="inline">
                                <page xmlns="http://www.daisy.org/ns/2008/pef">
                                    <row>⠀⠀⠀⠀⠷⠀⠠⠱⠀⠱</row>
                                    <row>⠀⠀⠀⠀⠅⠕⠗⠞⠤⠀⠇⠁⠝⠛⠤⠤</row>
                                    <row>⠀⠀⠀⠀⠤⠅⠕⠗⠞⠀⠤⠤⠇⠁⠝⠛</row>
                                    <row>⠀⠀⠀⠀⠁⠁⠤⠃⠃⠀⠁⠁⠤⠤⠃⠃</row>
                                    <row>⠀⠀⠀⠀⠁⠁⠀⠤⠤⠀⠃⠃</row>
                                    <row>⠀⠀⠀⠀⠁⠁⠀⠤⠀⠃⠃</row>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                                </page>
                </x:document>
            </x:expect>
        </x:scenario>
    
    <x:scenario label="table_caption">
        <x:call step="nlb:dtbook-to-pef">
            <x:input port="source">
                <x:document type="inline" xml:base="file:/tmp/book.xml">
                    <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                        <head>
                            <meta name="dtb:uid" content="123456"/>
                            <meta name="dc:Title" content="Title"/>
                            <meta name="dc:Identifier" content="123456"/>
                            <meta name="dc:Language" content="no"/>
                            <meta name="dc:Format" content="DTBook"/>
                            <meta name="dc:Creator" content="Creator"/>
                            <meta name="dc:Contributor" content="Contributor"/>
                            <meta name="dc:Date" content="2017-06-30"/>
                            <meta name="dc:Publisher" content="NLB"/>
                            <meta name="dc:Source" content="urn:isbn:9781111111111"/>
                            <meta name="dcterms:modified" content="2017-06-30T10:14:30+02:00"/>
                        </head>
                        <book>
                            <frontmatter>
                                <doctitle>doctitle</doctitle>
                                <docauthor>docauthor</docauthor>
                            </frontmatter>
                            <bodymatter>
                                <level1>
                                    <p>other content</p>
                                    <table>
                                        <!--Table with caption-->
                                        <caption>caption</caption>
                                        <tr>
                                            <td>a</td>
                                            <td>b</td>
                                        </tr>
                                        <tr>
                                            <td>c</td>
                                            <td>d</td>
                                        </tr>
                                    </table>
                                    <p>other content</p>
                                    <table>
                                        <!--Table without caption-->
                                        <tr>
                                            <td>a</td>
                                            <td>b</td>
                                        </tr>
                                        <tr>
                                            <td>c</td>
                                            <td>d</td>
                                        </tr>
                                    </table>
                                    <p>other content</p>
                                </level1>
                            </bodymatter>
                        </book>
                    </dtbook>
                </x:document>
            </x:input>
            <x:option name="braille-standard" select="'(dots:6)(grade:0)'"/>
            <x:option name="show-braille-page-numbers" select="'false'"/>
            <x:option name="pef-output-dir" select="resolve-uri('12/pef-output-dir',$temp-dir)"/>
            <x:option name="preview-output-dir" select="resolve-uri('12/preview-output-dir',$temp-dir)"/>
            <x:option name="temp-dir" select="resolve-uri('12/temp-dir',$temp-dir)"/>
        </x:call>
        
        <x:context label="result">
            <x:document type="file" base-uri="temp-dir" href="12/pef-output-dir/book.pef" select="(//pef:page)[last()]"/>
        </x:context>
        <x:expect label="result" type="compare">
            <x:document type="inline">
                <page xmlns="http://www.daisy.org/ns/2008/pef">
                    <row>⠀⠀⠀⠀⠕⠞⠓⠑⠗⠀⠉⠕⠝⠞⠑⠝⠞</row>
                    <row/>
                    <row>⠀⠀⠀⠀⠉⠁⠏⠞⠊⠕⠝</row>
                    <row/>
                    <row>⠀⠀⠀⠀⠠⠞⠁⠃⠑⠇⠇⠀⠎⠞⠁⠗⠞⠑⠗</row>
                    <row/>
                    <row>⠀⠀⠁⠀⠀⠃</row>
                    <row>⠀⠀⠉⠀⠀⠙</row>
                    <row/>
                    <row>⠀⠀⠀⠀⠠⠞⠁⠃⠑⠇⠇⠀⠎⠇⠥⠞⠞⠑⠗</row>
                    <row/>
                    <row>⠀⠀⠀⠀⠕⠞⠓⠑⠗⠀⠉⠕⠝⠞⠑⠝⠞</row>
                    <row/>
                    <row>⠀⠀⠀⠀⠠⠞⠁⠃⠑⠇⠇⠀⠎⠞⠁⠗⠞⠑⠗</row>
                    <row/>
                    <row>⠀⠀⠁⠀⠀⠃</row>
                    <row>⠀⠀⠉⠀⠀⠙</row>
                    <row/>
                    <row>⠀⠀⠀⠀⠠⠞⠁⠃⠑⠇⠇⠀⠎⠇⠥⠞⠞⠑⠗</row>
                    <row/>
                    <row>⠀⠀⠀⠀⠕⠞⠓⠑⠗⠀⠉⠕⠝⠞⠑⠝⠞</row>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                </page>
            </x:document>
        </x:expect>
    </x:scenario>
    
    <x:scenario label="print page numbers enabled (marks in left margin and page footer)">
        <x:call step="nlb:dtbook-to-pef">
            <x:input port="source">
                <x:document type="inline" xml:base="file:/tmp/book.xml">
                    <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                        <head/>
                        <book>
                            <frontmatter>
                                <doctitle>doctitle</doctitle>
                                <docauthor>docauthor</docauthor>
                            </frontmatter>
                            <bodymatter>
                                <level1>
                                    <p>På perrongen viste skiltet førti minutter til neste tog, det var toget
                                       nordover. Jeg gikk rundt bygningen, luften var sur og kald. Ekspeditøren kom
                                       nedover fortauet med den <pagenum id="p11" page="normal">11</pagenum>lille
                                       hunden, nå iført dekken. Hun lot den snuse på noe under en benk, hun sto og
                                       studerte håndflaten sin imens.</p>
                                </level1>
                            </bodymatter>
                        </book>
                    </dtbook>
                </x:document>
            </x:input>
            <x:option name="braille-standard" select="'(dots:6)(grade:0)'"/>
            <x:option name="show-braille-page-numbers" select="'false'"/>
            <x:option name="show-print-page-numbers" select="'true'"/>
            <x:option name="pef-output-dir" select="resolve-uri('13/pef-output-dir',$temp-dir)"/>
            <x:option name="preview-output-dir" select="resolve-uri('13/preview-output-dir',$temp-dir)"/>
            <x:option name="temp-dir" select="resolve-uri('13/temp-dir',$temp-dir)"/>
        </x:call>
        
        <x:context label="result">
            <x:document type="file" base-uri="temp-dir" href="13/pef-output-dir/book.pef" select="(//pef:page)[last()]"/>
        </x:context>
        <x:expect label="result" type="compare">
            <x:document type="inline">
                <page xmlns="http://www.daisy.org/ns/2008/pef">
                    <row>⠀⠀⠀⠀⠠⠏⠡⠀⠏⠑⠗⠗⠕⠝⠛⠑⠝⠀⠧⠊⠎⠞⠑⠀⠎⠅⠊⠇⠞⠑⠞</row>
                    <row>⠀⠀⠋⠪⠗⠞⠊⠀⠍⠊⠝⠥⠞⠞⠑⠗⠀⠞⠊⠇⠀⠝⠑⠎⠞⠑⠀⠞⠕⠛⠂</row>
                    <row>⠀⠀⠙⠑⠞⠀⠧⠁⠗⠀⠞⠕⠛⠑⠞⠀⠝⠕⠗⠙⠕⠧⠑⠗⠄⠀⠠⠚⠑⠛</row>
                    <row>⠀⠀⠛⠊⠅⠅⠀⠗⠥⠝⠙⠞⠀⠃⠽⠛⠝⠊⠝⠛⠑⠝⠂⠀⠇⠥⠋⠞⠑⠝</row>
                    <row>⠀⠀⠧⠁⠗⠀⠎⠥⠗⠀⠕⠛⠀⠅⠁⠇⠙⠄</row>
                    <row>⠀⠀⠠⠑⠅⠎⠏⠑⠙⠊⠞⠪⠗⠑⠝⠀⠅⠕⠍⠀⠝⠑⠙⠕⠧⠑⠗</row>
                    <row>⠿⠀⠋⠕⠗⠞⠁⠥⠑⠞⠀⠍⠑⠙⠀⠙⠑⠝⠀⠇⠊⠇⠇⠑</row>
                    <row>⠀⠀⠓⠥⠝⠙⠑⠝⠂⠀⠝⠡⠀⠊⠋⠪⠗⠞⠀⠙⠑⠅⠅⠑⠝⠄⠀⠠⠓⠥⠝</row>
                    <row>⠀⠀⠇⠕⠞⠀⠙⠑⠝⠀⠎⠝⠥⠎⠑⠀⠏⠡⠀⠝⠕⠑⠀⠥⠝⠙⠑⠗⠀⠑⠝</row>
                    <row>⠀⠀⠃⠑⠝⠅⠂⠀⠓⠥⠝⠀⠎⠞⠕⠀⠕⠛⠀⠎⠞⠥⠙⠑⠗⠞⠑</row>
                    <row>⠀⠀⠓⠡⠝⠙⠋⠇⠁⠞⠑⠝⠀⠎⠊⠝⠀⠊⠍⠑⠝⠎⠄</row>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠿⠼⠁⠁</row>
                </page>
            </x:document>
        </x:expect>
    </x:scenario>
    
    <x:scenario label="print page numbers enabled; some braille pages without marks">
        <x:call step="nlb:dtbook-to-pef">
            <x:input port="source">
                <x:document type="inline" xml:base="file:/tmp/book.xml">
                    <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                        <head/>
                        <book>
                            <frontmatter>
                                <doctitle>doctitle</doctitle>
                                <docauthor>docauthor</docauthor>
                            </frontmatter>
                            <bodymatter>
                                <level1>
                                    <p>På perrongen viste skiltet førti minutter til neste tog, det var toget
                                        nordover. Jeg gikk rundt bygningen, luften var sur og kald. Ekspeditøren kom
                                        nedover fortauet med den <pagenum id="p11" page="normal">11</pagenum>lille
                                        hunden, nå iført dekken. Hun lot den snuse på noe under en benk, hun sto og
                                        studerte håndflaten sin imens.</p>
                                </level1>
                                <level1 style="page-break-before: always;">
                                    <p>På perrongen viste skiltet førti minutter til neste tog, det var toget
                                        nordover. Jeg gikk rundt bygningen, luften var sur og kald. Ekspeditøren kom
                                        nedover fortauet med den lille
                                        hunden, nå iført dekken. Hun lot den snuse på noe under en benk, hun sto og
                                        studerte håndflaten sin imens.</p>
                                </level1>
                            </bodymatter>
                        </book>
                    </dtbook>
                </x:document>
            </x:input>
            <x:option name="braille-standard" select="'(dots:6)(grade:0)'"/>
            <x:option name="show-braille-page-numbers" select="'false'"/>
            <x:option name="show-print-page-numbers" select="'true'"/>
            <x:option name="pef-output-dir" select="resolve-uri('14/pef-output-dir',$temp-dir)"/>
            <x:option name="preview-output-dir" select="resolve-uri('14/preview-output-dir',$temp-dir)"/>
            <x:option name="temp-dir" select="resolve-uri('14/temp-dir',$temp-dir)"/>
        </x:call>
        
        <x:context label="result">
            <x:document type="file" base-uri="temp-dir" href="14/pef-output-dir/book.pef" select="(//pef:page)[position() &gt;= last()-1]"/>
        </x:context>
        <x:expect label="result" type="compare">
            <x:document type="inline">
                <page xmlns="http://www.daisy.org/ns/2008/pef">
                    <row>⠀⠀⠀⠀⠠⠏⠡⠀⠏⠑⠗⠗⠕⠝⠛⠑⠝⠀⠧⠊⠎⠞⠑⠀⠎⠅⠊⠇⠞⠑⠞</row>
                    <row>⠀⠀⠋⠪⠗⠞⠊⠀⠍⠊⠝⠥⠞⠞⠑⠗⠀⠞⠊⠇⠀⠝⠑⠎⠞⠑⠀⠞⠕⠛⠂</row>
                    <row>⠀⠀⠙⠑⠞⠀⠧⠁⠗⠀⠞⠕⠛⠑⠞⠀⠝⠕⠗⠙⠕⠧⠑⠗⠄⠀⠠⠚⠑⠛</row>
                    <row>⠀⠀⠛⠊⠅⠅⠀⠗⠥⠝⠙⠞⠀⠃⠽⠛⠝⠊⠝⠛⠑⠝⠂⠀⠇⠥⠋⠞⠑⠝</row>
                    <row>⠀⠀⠧⠁⠗⠀⠎⠥⠗⠀⠕⠛⠀⠅⠁⠇⠙⠄</row>
                    <row>⠀⠀⠠⠑⠅⠎⠏⠑⠙⠊⠞⠪⠗⠑⠝⠀⠅⠕⠍⠀⠝⠑⠙⠕⠧⠑⠗</row>
                    <row>⠿⠀⠋⠕⠗⠞⠁⠥⠑⠞⠀⠍⠑⠙⠀⠙⠑⠝⠀⠇⠊⠇⠇⠑</row>
                    <row>⠀⠀⠓⠥⠝⠙⠑⠝⠂⠀⠝⠡⠀⠊⠋⠪⠗⠞⠀⠙⠑⠅⠅⠑⠝⠄⠀⠠⠓⠥⠝</row>
                    <row>⠀⠀⠇⠕⠞⠀⠙⠑⠝⠀⠎⠝⠥⠎⠑⠀⠏⠡⠀⠝⠕⠑⠀⠥⠝⠙⠑⠗⠀⠑⠝</row>
                    <row>⠀⠀⠃⠑⠝⠅⠂⠀⠓⠥⠝⠀⠎⠞⠕⠀⠕⠛⠀⠎⠞⠥⠙⠑⠗⠞⠑</row>
                    <row>⠀⠀⠓⠡⠝⠙⠋⠇⠁⠞⠑⠝⠀⠎⠊⠝⠀⠊⠍⠑⠝⠎⠄</row>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠿⠼⠁⠁</row>
                </page>
            </x:document>
            <x:document type="inline">
                <page xmlns="http://www.daisy.org/ns/2008/pef">
                    <row>⠀⠀⠀⠀⠠⠏⠡⠀⠏⠑⠗⠗⠕⠝⠛⠑⠝⠀⠧⠊⠎⠞⠑⠀⠎⠅⠊⠇⠞⠑⠞</row>
                    <row>⠀⠀⠋⠪⠗⠞⠊⠀⠍⠊⠝⠥⠞⠞⠑⠗⠀⠞⠊⠇⠀⠝⠑⠎⠞⠑⠀⠞⠕⠛⠂</row>
                    <row>⠀⠀⠙⠑⠞⠀⠧⠁⠗⠀⠞⠕⠛⠑⠞⠀⠝⠕⠗⠙⠕⠧⠑⠗⠄⠀⠠⠚⠑⠛</row>
                    <row>⠀⠀⠛⠊⠅⠅⠀⠗⠥⠝⠙⠞⠀⠃⠽⠛⠝⠊⠝⠛⠑⠝⠂⠀⠇⠥⠋⠞⠑⠝</row>
                    <row>⠀⠀⠧⠁⠗⠀⠎⠥⠗⠀⠕⠛⠀⠅⠁⠇⠙⠄</row>
                    <row>⠀⠀⠠⠑⠅⠎⠏⠑⠙⠊⠞⠪⠗⠑⠝⠀⠅⠕⠍⠀⠝⠑⠙⠕⠧⠑⠗</row>
                    <row>⠀⠀⠋⠕⠗⠞⠁⠥⠑⠞⠀⠍⠑⠙⠀⠙⠑⠝⠀⠇⠊⠇⠇⠑</row>
                    <row>⠀⠀⠓⠥⠝⠙⠑⠝⠂⠀⠝⠡⠀⠊⠋⠪⠗⠞⠀⠙⠑⠅⠅⠑⠝⠄⠀⠠⠓⠥⠝</row>
                    <row>⠀⠀⠇⠕⠞⠀⠙⠑⠝⠀⠎⠝⠥⠎⠑⠀⠏⠡⠀⠝⠕⠑⠀⠥⠝⠙⠑⠗⠀⠑⠝</row>
                    <row>⠀⠀⠃⠑⠝⠅⠂⠀⠓⠥⠝⠀⠎⠞⠕⠀⠕⠛⠀⠎⠞⠥⠙⠑⠗⠞⠑</row>
                    <row>⠀⠀⠓⠡⠝⠙⠋⠇⠁⠞⠑⠝⠀⠎⠊⠝⠀⠊⠍⠑⠝⠎⠄</row>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠿⠼⠁⠁</row>
                </page>
            </x:document>
        </x:expect>
    </x:scenario>
    
    <x:scenario label="print page numbers enabled, but no print page numbers in the book" pending="https://github.com/nlbdev/pipeline/issues/76">
        <x:call step="nlb:dtbook-to-pef">
            <x:input port="source">
                <x:document type="inline" xml:base="file:/tmp/book.xml">
                    <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                        <head/>
                        <book>
                            <frontmatter>
                                <doctitle>doctitle</doctitle>
                                <docauthor>docauthor</docauthor>
                            </frontmatter>
                            <bodymatter>
                                <level1>
                                    <p>På perrongen viste skiltet førti minutter til neste tog, det var toget
                                        nordover. Jeg gikk rundt bygningen, luften var sur og kald. Ekspeditøren kom
                                        nedover fortauet med den lille
                                        hunden, nå iført dekken. Hun lot den snuse på noe under en benk, hun sto og
                                        studerte håndflaten sin imens.</p>
                                </level1>
                            </bodymatter>
                        </book>
                    </dtbook>
                </x:document>
            </x:input>
            <x:option name="braille-standard" select="'(dots:6)(grade:0)'"/>
            <x:option name="show-braille-page-numbers" select="'false'"/>
            <x:option name="show-print-page-numbers" select="'true'"/>
            <x:option name="pef-output-dir" select="resolve-uri('15/pef-output-dir',$temp-dir)"/>
            <x:option name="preview-output-dir" select="resolve-uri('15/preview-output-dir',$temp-dir)"/>
            <x:option name="temp-dir" select="resolve-uri('15/temp-dir',$temp-dir)"/>
        </x:call>
        
        <x:context label="result">
            <x:document type="file" base-uri="temp-dir" href="15/pef-output-dir/book.pef" select="(//pef:page)[last()]"/>
        </x:context>
        <x:expect label="result" type="compare">
            <x:document type="inline">
                <page xmlns="http://www.daisy.org/ns/2008/pef">
                    <row>⠀⠀⠠⠏⠡⠀⠏⠑⠗⠗⠕⠝⠛⠑⠝⠀⠧⠊⠎⠞⠑</row>
                    <row>⠎⠅⠊⠇⠞⠑⠞⠀⠋⠪⠗⠞⠊⠀⠍⠊⠝⠥⠞⠞⠑⠗⠀⠞⠊⠇</row>
                    <row>⠝⠑⠎⠞⠑⠀⠞⠕⠛⠂⠀⠙⠑⠞⠀⠧⠁⠗⠀⠞⠕⠛⠑⠞</row>
                    <row>⠝⠕⠗⠙⠕⠧⠑⠗⠄⠀⠠⠚⠑⠛⠀⠛⠊⠅⠅⠀⠗⠥⠝⠙⠞</row>
                    <row>⠃⠽⠛⠝⠊⠝⠛⠑⠝⠂⠀⠇⠥⠋⠞⠑⠝⠀⠧⠁⠗⠀⠎⠥⠗</row>
                    <row>⠕⠛⠀⠅⠁⠇⠙⠄⠀⠠⠑⠅⠎⠏⠑⠙⠊⠞⠪⠗⠑⠝⠀⠅⠕⠍</row>
                    <row>⠝⠑⠙⠕⠧⠑⠗⠀⠋⠕⠗⠞⠁⠥⠑⠞⠀⠍⠑⠙⠀⠙⠑⠝</row>
                    <row>⠇⠊⠇⠇⠑⠀⠓⠥⠝⠙⠑⠝⠂⠀⠝⠡⠀⠊⠋⠪⠗⠞</row>
                    <row>⠙⠑⠅⠅⠑⠝⠄⠀⠠⠓⠥⠝⠀⠇⠕⠞⠀⠙⠑⠝⠀⠎⠝⠥⠎⠑</row>
                    <row>⠏⠡⠀⠝⠕⠑⠀⠥⠝⠙⠑⠗⠀⠑⠝⠀⠃⠑⠝⠅⠂⠀⠓⠥⠝</row>
                    <row>⠎⠞⠕⠀⠕⠛⠀⠎⠞⠥⠙⠑⠗⠞⠑⠀⠓⠡⠝⠙⠋⠇⠁⠞⠑⠝</row>
                    <row>⠎⠊⠝⠀⠊⠍⠑⠝⠎⠄</row>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row/>
                    <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                </page>
            </x:document>
        </x:expect>
    </x:scenario>
    
    <x:scenario label="print page numbers disabled (no marks in left margin or page footer)">
        <x:call step="nlb:dtbook-to-pef">
            <x:input port="source">
                <x:document type="inline" xml:base="file:/tmp/book.xml">
                    <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                        <head/>
                        <book>
                            <frontmatter>
                                <doctitle>doctitle</doctitle>
                                <docauthor>docauthor</docauthor>
                            </frontmatter>
                            <bodymatter>
                                <level1>
                                    <p>På perrongen viste skiltet førti minutter til neste tog, det var toget
                                       nordover. Jeg gikk rundt bygningen, luften var sur og kald. Ekspeditøren kom
                                       nedover fortauet med den <pagenum id="p11" page="normal">11</pagenum>lille
                                       hunden, nå iført dekken. Hun lot den snuse på noe under en benk, hun sto og
                                       studerte håndflaten sin imens.</p>
                                </level1>
                            </bodymatter>
                        </book>
                    </dtbook>
                </x:document>
            </x:input>
            <x:option name="braille-standard" select="'(dots:6)(grade:0)'"/>
            <x:option name="show-braille-page-numbers" select="'false'"/>
            <x:option name="show-print-page-numbers" select="'false'"/>
            <x:option name="pef-output-dir" select="resolve-uri('16/pef-output-dir',$temp-dir)"/>
            <x:option name="preview-output-dir" select="resolve-uri('16/preview-output-dir',$temp-dir)"/>
            <x:option name="temp-dir" select="resolve-uri('16/temp-dir',$temp-dir)"/>
        </x:call>
        
        <x:context label="result">
            <x:document type="file" base-uri="temp-dir" href="16/pef-output-dir/book.pef" select="(//pef:page)[last()]"/>
        </x:context>
        <x:expect label="result" type="compare">
            <x:document type="inline">
                <page xmlns="http://www.daisy.org/ns/2008/pef">
                    <row>⠀⠀⠀⠠⠏⠡⠀⠏⠑⠗⠗⠕⠝⠛⠑⠝⠀⠧⠊⠎⠞⠑⠀⠎⠅⠊⠇⠞⠑⠞</row>
                    <row>⠀⠋⠪⠗⠞⠊⠀⠍⠊⠝⠥⠞⠞⠑⠗⠀⠞⠊⠇⠀⠝⠑⠎⠞⠑⠀⠞⠕⠛⠂</row>
                    <row>⠀⠙⠑⠞⠀⠧⠁⠗⠀⠞⠕⠛⠑⠞⠀⠝⠕⠗⠙⠕⠧⠑⠗⠄⠀⠠⠚⠑⠛</row>
                    <row>⠀⠛⠊⠅⠅⠀⠗⠥⠝⠙⠞⠀⠃⠽⠛⠝⠊⠝⠛⠑⠝⠂⠀⠇⠥⠋⠞⠑⠝</row>
                    <row>⠀⠧⠁⠗⠀⠎⠥⠗⠀⠕⠛⠀⠅⠁⠇⠙⠄⠀⠠⠑⠅⠎⠏⠑⠙⠊⠞⠪⠗⠑⠝</row>
                    <row>⠀⠅⠕⠍⠀⠝⠑⠙⠕⠧⠑⠗⠀⠋⠕⠗⠞⠁⠥⠑⠞⠀⠍⠑⠙⠀⠙⠑⠝⠀</row>
                    <row>⠀⠇⠊⠇⠇⠑⠀⠓⠥⠝⠙⠑⠝⠂⠀⠝⠡⠀⠊⠋⠪⠗⠞⠀⠙⠑⠅⠅⠑⠝⠄</row>
                    <row>⠀⠠⠓⠥⠝⠀⠇⠕⠞⠀⠙⠑⠝⠀⠎⠝⠥⠎⠑⠀⠏⠡⠀⠝⠕⠑</row>
                    <row>⠀⠥⠝⠙⠑⠗⠀⠑⠝⠀⠃⠑⠝⠅⠂⠀⠓⠥⠝⠀⠎⠞⠕⠀⠕⠛</row>
                    <row>⠀⠎⠞⠥⠙⠑⠗⠞⠑⠀⠓⠡⠝⠙⠋⠇⠁⠞⠑⠝⠀⠎⠊⠝⠀⠊⠍⠑⠝⠎⠄</row>
                </page>
            </x:document>
        </x:expect>
    </x:scenario>
        
        <x:scenario label="Normal text content (without page markers) should have as margins 1 cell on the left and 1 cell on the right">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                            <head/>
                            <book>
                                <bodymatter>
                                    <level1>
                                        <p>xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</p>
                                    </level1>
                                </bodymatter>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="braille-standard" select="'(dots:6)(grade:0)'"/>
                <x:option name="show-braille-page-numbers" select="'false'"/>
                <x:option name="show-print-page-numbers" select="'false'"/>
                <x:option name="page-width" select="32"/>
                <x:option name="pef-output-dir" select="resolve-uri('17/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('17/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('17/temp-dir',$temp-dir)"/>
            </x:call>
            <x:context label="the output directory contents">
                <x:document type="file" base-uri="temp-dir" href="17/pef-output-dir/book.pef" select="(//pef:page)[last()]//pef:row[contains(text(),'⠭')]"/>
            </x:context>
            <x:expect label="There should not be any text in column #1 or column #page-width" type="compare">
                <x:document type="inline" select="/*/*">
                    <_ xmlns="http://www.daisy.org/ns/2008/pef">
                        <row>⠀⠀⠀⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭</row>
                        <row>⠀⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭</row>
                        <row>⠀⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭</row>
                        <row>⠀⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭⠭</row>
                    </_>
                </x:document>
            </x:expect>
        </x:scenario>
        
        <x:scenario label="images, image groups, captions and alt-text">
            <x:call step="nlb:dtbook-to-pef">
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                            <head/>
                            <book>
                                <bodymatter>
                                    <level1>
                                        <p>content</p>
                                        
                                        <!-- img without alt-text -->
                                        <img src="https://uu.difi.no/traller.jpg"/>
                                        
                                        <p>content</p>
                                        
                                        <!-- img with empty alt-text -->
                                        <img src="https://uu.difi.no/traller.jpg" alt=""/>
                                        
                                        <p>content</p>
                                        
                                        <!-- img with non-empty alt-text -->
                                        <img src="https://uu.difi.no/traller.jpg" alt="Tre gamle tretraller. Foto."/>
                                        
                                        <p>content</p>
                                        
                                        <!-- imggroup without caption and without alt-text -->
                                        <imggroup>
                                            <img src="https://uu.difi.no/traller.jpg"/>
                                        </imggroup>
                                        
                                        <p>content</p>
                                        
                                        <!-- imggroup without caption and with empty alt-text -->
                                        <imggroup>
                                            <img src="https://uu.difi.no/traller.jpg" alt=""/>
                                        </imggroup>
                                        
                                        <p>content</p>
                                        
                                        <!-- imggroup without caption and with non-empty alt-text -->
                                        <imggroup>
                                            <img src="https://uu.difi.no/traller.jpg" alt="Tre gamle tretraller. Foto."/>
                                        </imggroup>
                                        
                                        <p>content</p>
                                        
                                        <!-- imggroup with caption and without alt-text -->
                                        <imggroup>
                                            <img id="img1" src="https://uu.difi.no/traller.jpg"/>
                                            <caption imgref="img1">Gamle tretraller regnes av mange som antikviteter.</caption>
                                        </imggroup>
                                        
                                        <p>content</p>
                                        
                                        <!-- imggroup with caption and with empty alt-text -->
                                        <imggroup>
                                            <img id="img2" src="https://uu.difi.no/traller.jpg" alt=""/>
                                            <caption imgref="img2">Gamle tretraller regnes av mange som antikviteter.</caption>
                                        </imggroup>
                                        
                                        <p>content</p>
                                        
                                        <!-- imggroup with caption and with non-empty alt-text -->
                                        <imggroup>
                                            <img id="img3" src="https://uu.difi.no/traller.jpg" alt="Tre gamle tretraller. Foto."/>
                                            <caption imgref="img3">Gamle tretraller regnes av mange som antikviteter.</caption>
                                        </imggroup>
                                        
                                        <p>content</p>
                                    </level1>
                                </bodymatter>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="braille-standard" select="'(dots:6)(grade:0)'"/>
                <x:option name="show-braille-page-numbers" select="'false'"/>
                <x:option name="show-print-page-numbers" select="'false'"/>
                <x:option name="page-height" select="150"/>
                <x:option name="pef-output-dir" select="resolve-uri('18/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('18/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('18/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="result">
                <x:document type="file" base-uri="temp-dir" href="18/pef-output-dir/book.pef" select="(//pef:page)[last()]"/>
            </x:context>
            <x:expect label="result" type="compare">
                <x:document type="inline">
                    <page xmlns="http://www.daisy.org/ns/2008/pef">
                        <row>⠀⠀⠀⠉⠕⠝⠞⠑⠝⠞</row>
                        <row>⠀⠀⠀⠉⠕⠝⠞⠑⠝⠞</row>
                        <row>⠀⠀⠀⠉⠕⠝⠞⠑⠝⠞</row>
                        <row/>
                        <row>⠀⠀⠀⠀⠀⠠⠃⠊⠇⠙⠑⠃⠑⠎⠅⠗⠊⠧⠑⠇⠎⠑⠒⠀⠠⠞⠗⠑</row>
                        <row>⠀⠀⠀⠛⠁⠍⠇⠑⠀⠞⠗⠑⠞⠗⠁⠇⠇⠑⠗⠄⠀⠠⠋⠕⠞⠕⠄</row>
                        <row/>
                        <row>⠀⠀⠀⠉⠕⠝⠞⠑⠝⠞</row>
                        <row>⠀⠀⠀⠉⠕⠝⠞⠑⠝⠞</row>
                        <row>⠀⠀⠀⠉⠕⠝⠞⠑⠝⠞</row>
                        <row/>
                        <row>⠀⠀⠀⠀⠀⠠⠃⠊⠇⠙⠑⠃⠑⠎⠅⠗⠊⠧⠑⠇⠎⠑⠒⠀⠠⠞⠗⠑</row>
                        <row>⠀⠀⠀⠛⠁⠍⠇⠑⠀⠞⠗⠑⠞⠗⠁⠇⠇⠑⠗⠄⠀⠠⠋⠕⠞⠕⠄</row>
                        <row/>
                        <row>⠀⠀⠀⠉⠕⠝⠞⠑⠝⠞</row>
                        <row/>
                        <row>⠀⠀⠀⠀⠀⠠⠃⠊⠇⠙⠑⠞⠑⠅⠎⠞⠒⠀⠠⠛⠁⠍⠇⠑⠀⠞⠗⠑⠤</row>
                        <row>⠀⠀⠀⠞⠗⠁⠇⠇⠑⠗⠀⠗⠑⠛⠝⠑⠎⠀⠁⠧⠀⠍⠁⠝⠛⠑⠀⠎⠕⠍</row>
                        <row>⠀⠀⠀⠁⠝⠞⠊⠅⠧⠊⠞⠑⠞⠑⠗⠄</row>
                        <row/>
                        <row>⠀⠀⠀⠉⠕⠝⠞⠑⠝⠞</row>
                        <row/>
                        <row>⠀⠀⠀⠀⠀⠠⠃⠊⠇⠙⠑⠞⠑⠅⠎⠞⠒⠀⠠⠛⠁⠍⠇⠑⠀⠞⠗⠑⠤</row>
                        <row>⠀⠀⠀⠞⠗⠁⠇⠇⠑⠗⠀⠗⠑⠛⠝⠑⠎⠀⠁⠧⠀⠍⠁⠝⠛⠑⠀⠎⠕⠍</row>
                        <row>⠀⠀⠀⠁⠝⠞⠊⠅⠧⠊⠞⠑⠞⠑⠗⠄</row>
                        <row/>
                        <row>⠀⠀⠀⠉⠕⠝⠞⠑⠝⠞</row>
                        <row/>
                        <row>⠀⠀⠀⠀⠀⠠⠃⠊⠇⠙⠑⠃⠑⠎⠅⠗⠊⠧⠑⠇⠎⠑⠒⠀⠠⠞⠗⠑</row>
                        <row>⠀⠀⠀⠛⠁⠍⠇⠑⠀⠞⠗⠑⠞⠗⠁⠇⠇⠑⠗⠄⠀⠠⠋⠕⠞⠕⠄</row>
                        <row/>
                        <row>⠀⠀⠀⠀⠀⠠⠃⠊⠇⠙⠑⠞⠑⠅⠎⠞⠒⠀⠠⠛⠁⠍⠇⠑⠀⠞⠗⠑⠤</row>
                        <row>⠀⠀⠀⠞⠗⠁⠇⠇⠑⠗⠀⠗⠑⠛⠝⠑⠎⠀⠁⠧⠀⠍⠁⠝⠛⠑⠀⠎⠕⠍</row>
                        <row>⠀⠀⠀⠁⠝⠞⠊⠅⠧⠊⠞⠑⠞⠑⠗⠄</row>
                        <row/>
                        <row>⠀⠀⠀⠉⠕⠝⠞⠑⠝⠞</row>
                    </page>
                </x:document>
            </x:expect>
        </x:scenario>
        
        <x:scenario label="Include OBFL when include-obfl=true">
            <x:call>
                <x:input port="source">
                    <x:document type="file" href="../resources/DTBook/book.xml"/>
                </x:input>
                <x:option name="include-obfl" select="'true'"/>
                <x:option name="pef-output-dir" select="resolve-uri('19/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('19/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('19/temp-dir',$temp-dir)"/>
            </x:call>
            <x:context label="the output directory contents">
                <x:document type="directory" base-uri="temp-dir" href="19/pef-output-dir/"/>
            </x:context>
            <x:expect label="Exactly one OBFL file should be present in the output directory" type="xpath"
                      test="count(/*/*[ends-with(@name,'.obfl')])" equals="1"/>
        </x:scenario>
        
        <x:scenario label="Use UEB-table when force-norwegian=false">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                            <head/>
                            <book>
                                <bodymatter>
                                    <level1>
                                        <p>abc æøå</p>
                                        <p xml:lang="en">abc æøå</p>
                                    </level1>
                                </bodymatter>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="force-norwegian" select="'false'"/>
                <x:option name="pef-output-dir" select="resolve-uri('20/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('20/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('20/temp-dir',$temp-dir)"/>
            </x:call>
            <x:context label="result">
                <x:document type="file" base-uri="temp-dir" href="20/pef-output-dir/book.pef"/>
            </x:context>
            <x:expect label="The two paragraphs should not be equal" type="xpath" test="(//pef:row[contains(.,'⠁⠃⠉')])[1]/replace(.,'⠀','')" equals="(//pef:row[contains(.,'⠁⠃⠉')])[2]/replace(.,'⠀','')" xfail=""/>
        </x:scenario>
        
        <x:scenario label="Regression test for #120: UnsupportedOperationException: error in table model that cannot be fixed automatically" pending="https://github.com/nlbdev/pipeline/issues/120">
            <x:call>
                <x:input port="source">
                    <x:document type="inline">
                        <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                            <head>
                                <meta name="dtb:uid" content="123456"/>
                                <meta name="dc:Title" content="Title"/>
                                <meta name="dc:Identifier" content="123456"/>
                                <meta name="track:Guidelines" content="2015-1"/>
                                <meta name="track:Supplier" content="Supplier"/>
                                <meta name="dc:Language" content="no"/>
                                <meta name="dc:Format" content="DTBook"/>
                                <meta name="dc:Creator" content="Lastname, Firstname"/>
                                <meta name="dc:Date" content="2017-10-13"/>
                                <meta name="dc:Publisher" content="NLB"/>
                                <meta name="dc:Source" content="urn:isbn:123-45-67-89012-3"/>
                                <meta name="dcterms:modified" content="2017-10-13T16:54:30+00:00"/>
                            </head>
                            <book>
                                <frontmatter>
                                    <doctitle>doctitle</doctitle>
                                    <docauthor>docauthor</docauthor>
                                </frontmatter>
                                <bodymatter>
                                    <level1>
                                        <table>
                                            <tr>
                                                <th colspan="3"> </th>
                                                <td> </td>
                                                <td rowspan="2"> </td>
                                            </tr>
                                            <tr>
                                                <td> </td>
                                                <td> </td>
                                            </tr>
                                        </table>
                                    </level1>
                                </bodymatter>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('21/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('21/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('21/temp-dir',$temp-dir)"/>
            </x:call>
            <x:context label="the output PEF">
                <x:document type="directory" base-uri="temp-dir" href="21/pef-output-dir/book.pef"/>
            </x:context>
            <x:expect label="There should be an output PEF" type="count" min="1"/>
        </x:scenario>
        
        <x:scenario label="Headlines">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook version="2005-3" xml:lang="no" xmlns="http://www.daisy.org/z3986/2005/dtbook/">
                            <head>
                                <meta content="123456" name="dtb:uid"/>
                                <meta content="Headlines" name="dc:Title"/>
                                <meta content="123456" name="dc:Identifier"/>
                                <meta content="no" name="dc:Language"/>
                                <meta content="DTBook" name="dc:Format"/>
                                <meta content="NLB" name="dc:Publisher"/>
                                <meta content="2017-10-17" name="dc:Date"/>
                                <meta content="2017-10-17T13:34:16+00:00" name="dcterms:modified"/>
                            </head>
                            <book>
                                <frontmatter>
                                    <doctitle>Headlines</doctitle>
                                </frontmatter>
                                <bodymatter>
                                    <level1 style="page-break-before: always;">
                                        <p style="margin-bottom: 0; padding-bottom: 0;">before</p>
                                        
                                        <h1>Chapter 1</h1>
                                        
                                        <p style="margin-top: 0; padding-top: 0;">after</p>
                                        <level2 style="page-break-before: always;">
                                            <p style="margin-bottom: 0; padding-bottom: 0;">before</p>
                                            
                                            <h2>Chapter 2</h2>
                                            
                                            <p style="margin-top: 0; padding-top: 0;">after</p>
                                            <level3 style="page-break-before: always;">
                                                <p style="margin-bottom: 0; padding-bottom: 0;">before</p>
                                                
                                                <h3>Chapter 3</h3>
                                                
                                                <p style="margin-top: 0; padding-top: 0;">after</p>
                                                <level4 style="page-break-before: always;">
                                                    <p style="margin-bottom: 0; padding-bottom: 0;">before</p>
                                                    
                                                    <h4>Chapter 4</h4>
                                                    
                                                    <p style="margin-top: 0; padding-top: 0;">after</p>
                                                    <level5 style="page-break-before: always;">
                                                        <p style="margin-bottom: 0; padding-bottom: 0;">before</p>
                                                        
                                                        <h5>Chapter 5</h5>
                                                        
                                                        <p style="margin-top: 0; padding-top: 0;">after</p>
                                                        <level6 style="page-break-before: always;">
                                                            <p style="margin-bottom: 0; padding-bottom: 0;">before</p>
                                                            
                                                            <h6>Chapter 6</h6>
                                                            
                                                            <p style="margin-top: 0; padding-top: 0;">after</p>
                                                        </level6>
                                                    </level5>
                                                </level4>
                                            </level3>
                                        </level2>
                                    </level1>
                                    <level1 class="part" style="page-break-before: always;">
                                        <p style="margin-bottom: 0; padding-bottom: 0;">before</p>
                                        
                                        <h1>Part</h1>
                                        
                                        <p style="margin-top: 0; padding-top: 0;">after</p>
                                        <level2 style="page-break-before: always;">
                                            <p style="margin-bottom: 0; padding-bottom: 0;">before</p>
                                            
                                            <h2>Part chapter 1</h2>
                                            
                                            <p style="margin-top: 0; padding-top: 0;">after</p>
                                            <level3 style="page-break-before: always;">
                                                <p style="margin-bottom: 0; padding-bottom: 0;">before</p>
                                                
                                                <h3>Part chapter 2</h3>
                                                
                                                <p style="margin-top: 0; padding-top: 0;">after</p>
                                                <level4 style="page-break-before: always;">
                                                    <p style="margin-bottom: 0; padding-bottom: 0;">before</p>
                                                    
                                                    <h4>Part chapter 3</h4>
                                                    
                                                    <p style="margin-top: 0; padding-top: 0;">after</p>
                                                    <level5 style="page-break-before: always;">
                                                        <p style="margin-bottom: 0; padding-bottom: 0;">before</p>
                                                        
                                                        <h5>Part chapter 4</h5>
                                                        
                                                        <p style="margin-top: 0; padding-top: 0;">after</p>
                                                        <level6 style="page-break-before: always;">
                                                            <p style="margin-bottom: 0; padding-bottom: 0;">before</p>
                                                            
                                                            <h6>Part chapter 5</h6>
                                                            
                                                            <p style="margin-top: 0; padding-top: 0;">after</p>
                                                        </level6>
                                                    </level5>
                                                </level4>
                                            </level3>
                                        </level2>
                                    </level1>
                                </bodymatter>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
                <x:option name="pef-output-dir" select="resolve-uri('22/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('22/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('22/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="the h1 headline">
                <x:document type="file" base-uri="temp-dir" href="22/pef-output-dir/book.pef" select="//pef:page[contains(string-join(.//text(),''),'⠠⠉⠓⠁⠏⠞⠑⠗⠀⠼⠁')]/(pef:row[contains(.,'⠃⠑⠋⠕⠗⠑')]/following-sibling::* intersect pef:row[contains(.,'⠁⠋⠞⠑⠗')]/preceding-sibling::*)"/>
            </x:context>
            <x:expect label="The headline should look as expected" type="compare">
                <x:document type="inline" select="/*/*">
                    <page xmlns="http://www.daisy.org/ns/2008/pef">
                        <row/>
                        <row/>
                        <row>⠀⠀⠀⠀⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠉⠓⠁⠏⠞⠑⠗⠀⠼⠁</row>
                        <row>⠀⠀⠀⠀⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                        <row/>
                    </page>
                </x:document>
            </x:expect>
            
            <x:context label="the h2 headline">
                <x:document type="file" base-uri="temp-dir" href="22/pef-output-dir/book.pef" select="//pef:page[contains(string-join(.//text(),''),'⠠⠉⠓⠁⠏⠞⠑⠗⠀⠼⠃')]/(pef:row[contains(.,'⠃⠑⠋⠕⠗⠑')]/following-sibling::* intersect pef:row[contains(.,'⠁⠋⠞⠑⠗')]/preceding-sibling::*)"/>
            </x:context>
            <x:expect label="The headline should look as expected" type="compare">
                <x:document type="inline" select="/*/*">
                    <page xmlns="http://www.daisy.org/ns/2008/pef">
                        <row/>
                        <row/>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠉⠓⠁⠏⠞⠑⠗⠀⠼⠃</row>
                        <row/>
                    </page>
                </x:document>
            </x:expect>
            
            <x:context label="the h3 headline">
                <x:document type="file" base-uri="temp-dir" href="22/pef-output-dir/book.pef" select="//pef:page[contains(string-join(.//text(),''),'⠠⠉⠓⠁⠏⠞⠑⠗⠀⠼⠉')]/(pef:row[contains(.,'⠃⠑⠋⠕⠗⠑')]/following-sibling::* intersect pef:row[contains(.,'⠁⠋⠞⠑⠗')]/preceding-sibling::*)"/>
            </x:context>
            <x:expect label="The headline should look as expected" type="compare">
                <x:document type="inline" select="/*/*">
                    <page xmlns="http://www.daisy.org/ns/2008/pef">
                        <row/>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠉⠓⠁⠏⠞⠑⠗⠀⠼⠉</row>
                    </page>
                </x:document>
            </x:expect>
            
            <x:context label="the h4 headline">
                <x:document type="file" base-uri="temp-dir" href="22/pef-output-dir/book.pef" select="//pef:page[contains(string-join(.//text(),''),'⠠⠉⠓⠁⠏⠞⠑⠗⠀⠼⠙')]/(pef:row[contains(.,'⠃⠑⠋⠕⠗⠑')]/following-sibling::* intersect pef:row[contains(.,'⠁⠋⠞⠑⠗')]/preceding-sibling::*)"/>
            </x:context>
            <x:expect label="The headline should look as expected" type="compare">
                <x:document type="inline" select="/*/*">
                    <page xmlns="http://www.daisy.org/ns/2008/pef">
                        <row/>
                        <row>⠀⠀⠀⠠⠉⠓⠁⠏⠞⠑⠗⠀⠼⠙</row>
                    </page>
                </x:document>
            </x:expect>
            
            <x:context label="the h5 headline">
                <x:document type="file" base-uri="temp-dir" href="22/pef-output-dir/book.pef" select="//pef:page[contains(string-join(.//text(),''),'⠠⠉⠓⠁⠏⠞⠑⠗⠀⠼⠑')]/(pef:row[contains(.,'⠃⠑⠋⠕⠗⠑')]/following-sibling::* intersect pef:row[contains(.,'⠁⠋⠞⠑⠗')]/preceding-sibling::*)"/>
            </x:context>
            <x:expect label="The headline should look as expected" type="compare">
                <x:document type="inline" select="/*/*">
                    <page xmlns="http://www.daisy.org/ns/2008/pef">
                        <row/>
                        <row>⠀⠀⠀⠠⠉⠓⠁⠏⠞⠑⠗⠀⠼⠑</row>
                    </page>
                </x:document>
            </x:expect>
            
            <x:context label="the h6 headline">
                <x:document type="file" base-uri="temp-dir" href="22/pef-output-dir/book.pef" select="//pef:page[contains(string-join(.//text(),''),'⠠⠉⠓⠁⠏⠞⠑⠗⠀⠼⠋')]/(pef:row[contains(.,'⠃⠑⠋⠕⠗⠑')]/following-sibling::* intersect pef:row[contains(.,'⠁⠋⠞⠑⠗')]/preceding-sibling::*)"/>
            </x:context>
            <x:expect label="The headline should look as expected" type="compare">
                <x:document type="inline" select="/*/*">
                    <page xmlns="http://www.daisy.org/ns/2008/pef">
                        <row/>
                        <row>⠀⠀⠀⠠⠉⠓⠁⠏⠞⠑⠗⠀⠼⠋</row>
                    </page>
                </x:document>
            </x:expect>
            
            <x:context label="the part h1 headline">
                <x:document type="file" base-uri="temp-dir" href="22/pef-output-dir/book.pef" select="//pef:page[contains(string-join(.//text(),''),'⠠⠏⠁⠗⠞') and not(contains(string-join(.//text(),''),'⠉⠓⠁⠏⠞⠑⠗'))]/(pef:row[contains(.,'⠃⠑⠋⠕⠗⠑')]/following-sibling::* intersect pef:row[contains(.,'⠁⠋⠞⠑⠗')]/preceding-sibling::*)"/>
            </x:context>
            <x:expect label="The headline should look as expected" type="compare" pending="https://github.com/nlbdev/pipeline/issues/128">
                <x:document type="inline" select="/*/*">
                    <page xmlns="http://www.daisy.org/ns/2008/pef">
                        <row/>
                        <row/>
                        <row>⠀⠀⠏⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠹</row>
                        <row>⠀⠀⠇⠀⠀⠀⠀⠀⠀⠀⠀⠠⠏⠁⠗⠞⠀⠀⠀⠀⠀⠀⠀⠀⠸⠀⠀⠀⠀⠀⠀</row>
                        <row>⠀⠀⠧⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠼</row>
                        <row/>
                    </page>
                </x:document>
            </x:expect>
            
            <x:context label="the part h2 headline">
                <x:document type="file" base-uri="temp-dir" href="22/pef-output-dir/book.pef" select="//pef:page[contains(string-join(.//text(),''),'⠠⠏⠁⠗⠞⠀⠉⠓⠁⠏⠞⠑⠗⠀⠼⠁')]/(pef:row[contains(.,'⠃⠑⠋⠕⠗⠑')]/following-sibling::* intersect pef:row[contains(.,'⠁⠋⠞⠑⠗')]/preceding-sibling::*)"/>
            </x:context>
            <x:expect label="The headline should look as expected" type="compare">
                <x:document type="inline" select="/*/*">
                    <page xmlns="http://www.daisy.org/ns/2008/pef">
                        <row/>
                        <row/>
                        <row>⠀⠀⠀⠀⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠠⠏⠁⠗⠞⠀⠉⠓⠁⠏⠞⠑⠗⠀⠼⠁</row>
                        <row>⠀⠀⠀⠀⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                        <row/>
                    </page>
                </x:document>
            </x:expect>
            
            <x:context label="the part h3 headline">
                <x:document type="file" base-uri="temp-dir" href="22/pef-output-dir/book.pef" select="//pef:page[contains(string-join(.//text(),''),'⠠⠏⠁⠗⠞⠀⠉⠓⠁⠏⠞⠑⠗⠀⠼⠃')]/(pef:row[contains(.,'⠃⠑⠋⠕⠗⠑')]/following-sibling::* intersect pef:row[contains(.,'⠁⠋⠞⠑⠗')]/preceding-sibling::*)"/>
            </x:context>
            <x:expect label="The headline should look as expected" type="compare">
                <x:document type="inline" select="/*/*">
                    <page xmlns="http://www.daisy.org/ns/2008/pef">
                        <row/>
                        <row/>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠠⠏⠁⠗⠞⠀⠉⠓⠁⠏⠞⠑⠗⠀⠼⠃</row>
                        <row/>
                    </page>
                </x:document>
            </x:expect>
            
            <x:context label="the part h4 headline">
                <x:document type="file" base-uri="temp-dir" href="22/pef-output-dir/book.pef" select="//pef:page[contains(string-join(.//text(),''),'⠠⠏⠁⠗⠞⠀⠉⠓⠁⠏⠞⠑⠗⠀⠼⠉')]/(pef:row[contains(.,'⠃⠑⠋⠕⠗⠑')]/following-sibling::* intersect pef:row[contains(.,'⠁⠋⠞⠑⠗')]/preceding-sibling::*)"/>
            </x:context>
            <x:expect label="The headline should look as expected" type="compare">
                <x:document type="inline" select="/*/*">
                    <page xmlns="http://www.daisy.org/ns/2008/pef">
                        <row/>
                        <row>⠀⠀⠀⠀⠀⠀⠀⠀⠠⠏⠁⠗⠞⠀⠉⠓⠁⠏⠞⠑⠗⠀⠼⠉</row>
                    </page>
                </x:document>
            </x:expect>
            
            <x:context label="the part h5 headline">
                <x:document type="file" base-uri="temp-dir" href="22/pef-output-dir/book.pef" select="//pef:page[contains(string-join(.//text(),''),'⠠⠏⠁⠗⠞⠀⠉⠓⠁⠏⠞⠑⠗⠀⠼⠙')]/(pef:row[contains(.,'⠃⠑⠋⠕⠗⠑')]/following-sibling::* intersect pef:row[contains(.,'⠁⠋⠞⠑⠗')]/preceding-sibling::*)"/>
            </x:context>
            <x:expect label="The headline should look as expected" type="compare">
                <x:document type="inline" select="/*/*">
                    <page xmlns="http://www.daisy.org/ns/2008/pef">
                        <row/>
                        <row>⠀⠀⠀⠠⠏⠁⠗⠞⠀⠉⠓⠁⠏⠞⠑⠗⠀⠼⠙</row>
                    </page>
                </x:document>
            </x:expect>
            
            <x:context label="the part h6 headline">
                <x:document type="file" base-uri="temp-dir" href="22/pef-output-dir/book.pef" select="//pef:page[contains(string-join(.//text(),''),'⠠⠏⠁⠗⠞⠀⠉⠓⠁⠏⠞⠑⠗⠀⠼⠑')]/(pef:row[contains(.,'⠃⠑⠋⠕⠗⠑')]/following-sibling::* intersect pef:row[contains(.,'⠁⠋⠞⠑⠗')]/preceding-sibling::*)"/>
            </x:context>
            <x:expect label="The headline should look as expected" type="compare">
                <x:document type="inline" select="/*/*">
                    <page xmlns="http://www.daisy.org/ns/2008/pef">
                        <row/>
                        <row>⠀⠀⠀⠠⠏⠁⠗⠞⠀⠉⠓⠁⠏⠞⠑⠗⠀⠼⠑</row>
                    </page>
                </x:document>
            </x:expect>
        </x:scenario>
        
    </x:scenario>
</x:description>
