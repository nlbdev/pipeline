<?xml version="1.0" encoding="UTF-8"?>
<?xml-model href="http://www.daisy.org/ns/xprocspec/xprocspec.rng" type="application/xml" schematypens="http://relaxng.org/ns/structure/1.0"?>
<x:description xmlns:x="http://www.daisy.org/ns/xprocspec"
               xmlns:nlb="http://www.nlb.no/ns/pipeline/xproc"
               xmlns:pef="http://www.daisy.org/ns/2008/pef"
               script="http://www.nlb.no/pipeline/modules/braille/dtbook-to-pef.xpl">
    
    <x:scenario label="Automatic numbering of notes">
        <x:call step="nlb:dtbook-to-pef">
            <x:input port="source">
                <x:document type="inline">
                    <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                        <book>
                            <bodymatter>
                                <level1>
                                    <h1>abc</h1>
                                    <p>aa <noteref id="noteref_1" idref="#note001">*</noteref> ll</p>
                                    <p>bb <noteref id="noteref_2" idref="#note002">*</noteref> ll</p>
                                    <p>cc <noteref id="noteref_3" idref="#note003">*</noteref> ll</p>
                                </level1>
                            </bodymatter>
                            <rearmatter>
                                <level1 class="footnotes">
                                    <h1>notes</h1>
                                    <note id="note001"> <p>* aaa aaa</p> </note>
                                    <note id="note002"> <p>* rrr bbb</p> </note>
                                    <note id="note003"> <p>* lll lll</p> </note>
                                </level1>
                            </rearmatter>
                        </book>
                    </dtbook>
                </x:document>
            </x:input>
            <x:option name="toc-depth" select="0"/>
            <x:option name="pef-output-dir" select="resolve-uri('notes-numbering/pef-output-dir',$temp-dir)"/>
            <x:option name="temp-dir" select="resolve-uri('notes-numbering/temp-dir',$temp-dir)"/>
        </x:call>
        <x:context label="result">
            <x:document type="file" base-uri="temp-dir" href="notes-numbering/pef-output-dir/test_dtbook-to-pef_notes.pef"
                        select="(//pef:page)[position() &gt;= last() - 1]"/>
        </x:context>
        <x:expect label="result" type="compare">
            <x:document type="inline">
                            <page xmlns="http://www.daisy.org/ns/2008/pef">
                                <row/>
                                <row/>
                                <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠁⠃⠉</row>
                                <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row/>
                                <row>⠀⠀⠀⠀⠁⠁⠀⠠⠼⠁⠀⠇⠇</row>
                                <row>⠀⠀⠀⠀⠃⠃⠀⠠⠼⠃⠀⠇⠇</row>
                                <row>⠀⠀⠀⠀⠉⠉⠀⠠⠼⠉⠀⠇⠇</row>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                            </page>
            </x:document>
            <x:document type="inline">
                            <page xmlns="http://www.daisy.org/ns/2008/pef">
                                <row/>
                                <row/>
                                <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠋⠕⠞⠝⠕⠞⠑⠗</row>
                                <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row/>
                                <row>⠀⠀⠀⠀⠠⠼⠁⠀⠁⠁⠁⠀⠁⠁⠁</row>
                                <row>⠀⠀⠀⠀⠠⠼⠃⠀⠗⠗⠗⠀⠃⠃⠃</row>
                                <row>⠀⠀⠀⠀⠠⠼⠉⠀⠇⠇⠇⠀⠇⠇⠇</row>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠑⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                            </page>
            </x:document>
        </x:expect>
    </x:scenario>
    
    <x:scenario label="Volume notes">
        <x:call step="nlb:dtbook-to-pef">
            <x:input port="source">
                <x:document type="inline">
                    <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                        <book>
                            <bodymatter>
                                <level1>
                                    <h1>abc</h1>
                                    <span style="display:block; volume-break-before:always"/>
                                    <p>aa <noteref id="noteref_1" idref="#note001">*</noteref> ll</p>
                                    <p>bb <noteref id="noteref_2" idref="#note002">*</noteref> ll</p>
                                    <span style="display:block; volume-break-before:always"/>
                                    <p>cc <noteref id="noteref_3" idref="#note003">*</noteref> ll</p>
                                </level1>
                            </bodymatter>
                            <rearmatter>
                                <level1 class="footnotes">
                                    <h1>notes</h1>
                                    <note id="note001"> <p>* aaa aaa</p> </note>
                                    <note id="note002"> <p>* rrr bbb</p> </note>
                                    <note id="note003"> <p>* lll lll</p> </note>
                                </level1>
                            </rearmatter>
                        </book>
                    </dtbook>
                </x:document>
            </x:input>
            <x:option name="toc-depth" select="0"/>
            <x:option name="pef-output-dir" select="resolve-uri('volume-notes/pef-output-dir',$temp-dir)"/>
            <x:option name="temp-dir" select="resolve-uri('volume-notes/temp-dir',$temp-dir)"/>
        </x:call>
        
        <x:context label="pef">
            <x:document type="file" base-uri="temp-dir" href="volume-notes/pef-output-dir/test_dtbook-to-pef_notes.pef"/>
        </x:context>
        <x:expect label="There should be 3 volumes" type="xpath" test="count(//pef:volume)" equals="3"/>
        
        <x:context label="First volume">
            <x:document type="file" base-uri="temp-dir" href="volume-notes/pef-output-dir/test_dtbook-to-pef_notes.pef"
                        select="(//pef:volume)[1]//pef:section[last()]"/>
        </x:context>
        <x:expect label="result - first volume" type="compare">
            <x:document type="inline">
                        <section xmlns="http://www.daisy.org/ns/2008/pef">
                            <page>
                                <row/>
                                <row/>
                                <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠁⠃⠉</row>
                                <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                            </page>
                        </section>
            </x:document>
        </x:expect>
        
        <x:context label="Second volume">
            <x:document type="file" base-uri="temp-dir" href="volume-notes/pef-output-dir/test_dtbook-to-pef_notes.pef"
                select="(//pef:volume)[2]//pef:section[position() &gt; 1]"/>
        </x:context>
        <x:expect label="result - second volume" type="compare">
            <x:document type="inline">
                        <section xmlns="http://www.daisy.org/ns/2008/pef">
                            <page>
                                <row>⠀⠀⠀⠀⠁⠁⠀⠠⠼⠁⠀⠇⠇</row>
                                <row>⠀⠀⠀⠀⠃⠃⠀⠠⠼⠃⠀⠇⠇</row>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠛⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                            </page>
                        </section>
            </x:document>
            <x:document type="inline">
                        <section xmlns="http://www.daisy.org/ns/2008/pef">
                            <page>
                                <row/>
                                <row/>
                                <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠋⠕⠞⠝⠕⠞⠑⠗</row>
                                <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row/>
                                <row>⠀⠀⠀⠀⠠⠼⠁⠀⠁⠁⠁⠀⠁⠁⠁</row>
                                <row>⠀⠀⠀⠀⠠⠼⠃⠀⠗⠗⠗⠀⠃⠃⠃</row>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠊⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                            </page>
                        </section>
            </x:document>
        </x:expect>
        
        <x:context label="Third volume">
            <x:document type="file" base-uri="temp-dir" href="volume-notes/pef-output-dir/test_dtbook-to-pef_notes.pef"
                select="(//pef:volume)[3]//pef:section[position() &gt; 1]"/>
        </x:context>
        <x:expect label="result - third volume" type="compare">
            <x:document type="inline">
                        <section xmlns="http://www.daisy.org/ns/2008/pef">
                            <page>
                                <row>⠀⠀⠀⠀⠉⠉⠀⠠⠼⠉⠀⠇⠇</row>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠁⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                            </page>
                        </section>
            </x:document>
            <x:document type="inline">
                        <section xmlns="http://www.daisy.org/ns/2008/pef">
                            <page>
                                <row/>
                                <row/>
                                <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠋⠕⠞⠝⠕⠞⠑⠗</row>
                                <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row/>
                                <row>⠀⠀⠀⠀⠠⠼⠉⠀⠇⠇⠇⠀⠇⠇⠇</row>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠁⠑⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                            </page>
                        </section>
            </x:document>
        </x:expect>
    </x:scenario>
    
    <x:scenario label="Footnotes">
        <x:call step="nlb:dtbook-to-pef">
            <x:input port="source">
                <x:document type="inline">
                    <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                        <book>
                            <bodymatter>
                                <level1>
                                    <h1>abc</h1>
                                    <p>aa <noteref id="noteref_1" idref="#note001">*</noteref> ll</p>
                                    <p>bb <noteref id="noteref_2" idref="#note002">*</noteref> ll</p>
                                    <span style="display:block; page-break-before:always"/>
                                    <p>cc <noteref id="noteref_3" idref="#note003">*</noteref> ll</p>
                                </level1>
                            </bodymatter>
                            <rearmatter>
                                <level1 class="footnotes">
                                    <h1>notes</h1>
                                    <note id="note001"> <p>* aaa aaa</p> </note>
                                    <note id="note002"> <p>* rrr bbb</p> </note>
                                    <note id="note003"> <p>* lll lll</p> </note>
                                </level1>
                            </rearmatter>
                        </book>
                    </dtbook>
                </x:document>
            </x:input>
            <x:option name="toc-depth" select="0"/>
            <x:option name="notes-placement" select="'bottom-of-page'"/>
            <x:option name="pef-output-dir" select="resolve-uri('footnotes/pef-output-dir',$temp-dir)"/>
            <x:option name="temp-dir" select="resolve-uri('footnotes/temp-dir',$temp-dir)"/>
        </x:call>
        
        <x:context label="result">
            <x:document type="file" base-uri="temp-dir" href="footnotes/pef-output-dir/test_dtbook-to-pef_notes.pef"
                        select="(//pef:section)[last()]"/>
        </x:context>
        <x:expect label="result - second volume" type="compare">
            <x:document type="inline">
                        <section xmlns="http://www.daisy.org/ns/2008/pef">
                            <page>
                                <row/>
                                <row/>
                                <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠁⠃⠉</row>
                                <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row/>
                                <row>⠀⠀⠀⠀⠁⠁⠀⠠⠼⠁⠀⠇⠇</row>
                                <row>⠀⠀⠀⠀⠃⠃⠀⠠⠼⠃⠀⠇⠇</row>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row>⠀⠀⠠⠼⠁⠀⠁⠁⠁⠀⠁⠁⠁</row>
                                <row>⠀⠀⠠⠼⠃⠀⠗⠗⠗⠀⠃⠃⠃</row>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                            </page>
                            <page>
                                <row>⠀⠀⠀⠀⠉⠉⠀⠠⠼⠉⠀⠇⠇</row>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row>⠀⠀⠠⠼⠉⠀⠇⠇⠇⠀⠇⠇⠇</row>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠙⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                            </page>
                        </section>
            </x:document>
        </x:expect>
    </x:scenario>
    
    <x:scenario label="Notes at end of book">
        <x:call step="nlb:dtbook-to-pef">
            <x:input port="source">
                <x:document type="inline">
                    <dtbook xmlns="http://www.daisy.org/z3986/2005/dtbook/" xml:lang="no" version="2005-3">
                        <book>
                            <bodymatter>
                                <level1>
                                    <h1>abc</h1>
                                    <p>aa <noteref id="noteref_1" idref="#note001">*</noteref> ll</p>
                                    <p>bb <noteref id="noteref_2" idref="#note002">*</noteref> ll</p>
                                    <span style="display:block; volume-break-before:always"/>
                                    <p>cc <noteref id="noteref_3" idref="#note003">*</noteref> ll</p>
                                </level1>
                            </bodymatter>
                            <rearmatter>
                                <level1 class="footnotes">
                                    <h1>notes</h1>
                                    <note id="note001"> <p>* aaa aaa</p> </note>
                                    <note id="note002"> <p>* rrr bbb</p> </note>
                                    <note id="note003"> <p>* lll lll</p> </note>
                                </level1>
                            </rearmatter>
                        </book>
                    </dtbook>
                </x:document>
            </x:input>
            <x:option name="toc-depth" select="0"/>
            <x:option name="notes-placement" select="'end-of-book'"/>
            <x:option name="pef-output-dir" select="resolve-uri('end-of-book-notes/pef-output-dir',$temp-dir)"/>
            <x:option name="temp-dir" select="resolve-uri('end-of-book-notes/temp-dir',$temp-dir)"/>
        </x:call>
        
        <x:context label="pef">
            <x:document type="file" base-uri="temp-dir" href="end-of-book-notes/pef-output-dir/test_dtbook-to-pef_notes.pef"/>
        </x:context>
        <x:expect label="There should be 2 volumes" type="xpath" test="count(//pef:volume)" equals="2"/>
        
        <x:context label="First volume">
            <x:document type="file" base-uri="temp-dir" href="end-of-book-notes/pef-output-dir/test_dtbook-to-pef_notes.pef"
                        select="(//pef:volume)[1]//pef:section[last()]"/>
        </x:context>
        <x:expect label="result - first volume" type="compare">
            <x:document type="inline">
                        <section xmlns="http://www.daisy.org/ns/2008/pef">
                            <page>
                                <row/>
                                <row/>
                                <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠁⠃⠉</row>
                                <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row/>
                                <row>⠀⠀⠀⠀⠁⠁⠀⠠⠼⠁⠀⠇⠇</row>
                                <row>⠀⠀⠀⠀⠃⠃⠀⠠⠼⠃⠀⠇⠇</row>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                            </page>
                        </section>
            </x:document>
        </x:expect>
        
        <x:context label="Second volume">
            <x:document type="file" base-uri="temp-dir" href="end-of-book-notes/pef-output-dir/test_dtbook-to-pef_notes.pef"
                        select="(//pef:volume)[2]//pef:section[position() &gt; 1]"/>
        </x:context>
            
            <x:expect label="result - second volume" type="compare">
                <x:document type="inline" select="/*/*">
                    <_ xmlns="http://www.daisy.org/ns/2008/pef">
                        <section>
                            <page>
                                <row>⠀⠀⠀⠀⠉⠉⠀⠠⠼⠉⠀⠇⠇</row>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠛⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                            </page>
                        </section>
                        <section>
                            <page>
                                <row/>
                                <row/>
                                <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠋⠕⠞⠝⠕⠞⠑⠗</row>
                                <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row/>
                                <row>⠀⠀⠀⠀⠠⠼⠁⠀⠁⠁⠁⠀⠁⠁⠁</row>
                                <row>⠀⠀⠀⠀⠠⠼⠃⠀⠗⠗⠗⠀⠃⠃⠃</row>
                                <row>⠀⠀⠀⠀⠠⠼⠉⠀⠇⠇⠇⠀⠇⠇⠇</row>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠊⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                            </page>
                        </section>
                    </_>
            </x:document>
        </x:expect>
    </x:scenario>
    
    <x:scenario label="test for text describing placement of notes in generated content ('om boka')">
        <x:call step="nlb:dtbook-to-pef"/>
        
        <x:scenario label="small notes">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook version="2005-3" xml:lang="no" xmlns="http://www.daisy.org/z3986/2005/dtbook/">
                            <head>
                                <meta name="dtb:uid" content="123456"/>
                                <meta name="dc:Title" content="dc:Title"/>
                                <meta name="dc:Creator" content="dc:Creator"/>
                            </head>
                            <book>
                                <frontmatter>
                                    <doctitle>doctitle</doctitle>
                                    <docauthor>docauthor</docauthor>
                                </frontmatter>
                                <bodymatter>
                                    <level1>
                                        <h1>h1</h1>
                                        <p>NLB<noteref idref="#smallnote">1</noteref> cooperates both nationally and internationally with other producers of adapted literature.</p>
                                        <note id="smallnote">
                                            <span>NLB is a state library under the Ministry of culture. The library offers a free, nation-wide service.</span>
                                        </note>
                                    </level1>
                                </bodymatter>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
            </x:call>
            
            <x:scenario label="with notes-placement=bottom-of-page">
                <x:call>
                    <x:option name="notes-placement" select="'bottom-of-page'"/>
                    <x:option name="pef-output-dir" select="resolve-uri('8/pef-output-dir',$temp-dir)"/>
                    <x:option name="preview-output-dir" select="resolve-uri('8/preview-output-dir',$temp-dir)"/>
                    <x:option name="temp-dir" select="resolve-uri('8/temp-dir',$temp-dir)"/>
                </x:call>
                
                <x:context label="the page containing 'om boka'">
                    <x:document type="file" base-uri="temp-dir" href="8/pef-output-dir/book.pef"  select="//pef:page[.//text()[contains(.,'⠕⠍⠀⠃⠕⠅⠁')]]"/>
                </x:context>
                <x:expect label="the page should contain 'Noter er plassert nederst på hver side.'" type="xpath" test="contains(replace(string-join(.//text(),'⠀'),'[⠀\s]+','⠀'), '⠠⠝⠕⠞⠑⠗⠀⠑⠗⠀⠏⠇⠁⠎⠎⠑⠗⠞⠀⠝⠑⠙⠑⠗⠎⠞⠀⠏⠡⠀⠓⠧⠑⠗⠀⠎⠊⠙⠑⠄')"/>
            </x:scenario>
            
            <x:scenario label="with notes-placement=end-of-volume">
                <x:call>
                    <x:option name="notes-placement" select="'end-of-volume'"/>
                    <x:option name="pef-output-dir" select="resolve-uri('9/pef-output-dir',$temp-dir)"/>
                    <x:option name="preview-output-dir" select="resolve-uri('9/preview-output-dir',$temp-dir)"/>
                    <x:option name="temp-dir" select="resolve-uri('9/temp-dir',$temp-dir)"/>
                </x:call>
                
                <x:context label="the page containing 'om boka'">
                    <x:document type="file" base-uri="temp-dir" href="9/pef-output-dir/book.pef"  select="//pef:page[.//text()[contains(.,'⠕⠍⠀⠃⠕⠅⠁')]]"/>
                </x:context>
                <x:expect label="the page should contain 'Noter er plassert i slutten av hvert hefte.'" type="xpath" test="contains(replace(string-join(.//text(),'⠀'),'[⠀\s]+','⠀'), '⠠⠝⠕⠞⠑⠗⠀⠑⠗⠀⠏⠇⠁⠎⠎⠑⠗⠞⠀⠊⠀⠎⠇⠥⠞⠞⠑⠝⠀⠁⠧⠀⠓⠧⠑⠗⠞⠀⠓⠑⠋⠞⠑⠄')"/>
            </x:scenario>
            
            <x:scenario label="with notes-placement=end-of-book">
                <x:call>
                    <x:option name="notes-placement" select="'end-of-book'"/>
                    <x:option name="pef-output-dir" select="resolve-uri('10/pef-output-dir',$temp-dir)"/>
                    <x:option name="preview-output-dir" select="resolve-uri('10/preview-output-dir',$temp-dir)"/>
                    <x:option name="temp-dir" select="resolve-uri('10/temp-dir',$temp-dir)"/>
                </x:call>
                
                <x:context label="the page containing 'om boka'">
                    <x:document type="file" base-uri="temp-dir" href="10/pef-output-dir/book.pef"  select="//pef:page[.//text()[contains(.,'⠕⠍⠀⠃⠕⠅⠁')]]"/>
                </x:context>
                <x:expect label="the page should contain 'Noter er plassert bakerst i boken.'" type="xpath" test="contains(replace(string-join(.//text(),'⠀'),'[⠀\s]+','⠀'), '⠠⠝⠕⠞⠑⠗⠀⠑⠗⠀⠏⠇⠁⠎⠎⠑⠗⠞⠀⠃⠁⠅⠑⠗⠎⠞⠀⠊⠀⠃⠕⠅⠑⠝⠄')"/>
            </x:scenario>
        </x:scenario>
        
        <x:scenario label="big notes">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <dtbook version="2005-3" xml:lang="no" xmlns="http://www.daisy.org/z3986/2005/dtbook/">
                            <head>
                                <meta name="dtb:uid" content="123456"/>
                                <meta name="dc:Title" content="dc:Title"/>
                                <meta name="dc:Creator" content="dc:Creator"/>
                            </head>
                            <book>
                                <frontmatter>
                                    <doctitle>doctitle</doctitle>
                                    <docauthor>docauthor</docauthor>
                                </frontmatter>
                                <bodymatter>
                                    <level1>
                                        <h1>h1</h1>
                                        <p>NLB<noteref idref="#bignote">1</noteref> cooperates both nationally and internationally with other producers of adapted literature.</p>
                                        <note id="bignote">
                                            <span>The Norwegian Library of Talking Books and Braille (NLB) produces and lends out talking books and braille books. We have books for children as well as adults.</span>
                                            <span>NLB works to ensure that everyone has equal access to literature and information. Our main task is to enable persons with print disabilities  to participate in society on an equal footing with others.</span>
                                            <span>NLB is a state library under the Ministry of culture. The library offers a free, nation-wide service.</span>
                                        </note>
                                    </level1>
                                </bodymatter>
                            </book>
                        </dtbook>
                    </x:document>
                </x:input>
            </x:call>
            
            <x:scenario label="with notes-placement=bottom-of-page">
                <x:call>
                    <x:option name="notes-placement" select="'bottom-of-page'"/>
                    <x:option name="pef-output-dir" select="resolve-uri('11/pef-output-dir',$temp-dir)"/>
                    <x:option name="preview-output-dir" select="resolve-uri('11/preview-output-dir',$temp-dir)"/>
                    <x:option name="temp-dir" select="resolve-uri('11/temp-dir',$temp-dir)"/>
                </x:call>
                
                <x:context label="the page containing 'om boka'">
                    <x:document type="file" base-uri="temp-dir" href="11/pef-output-dir/book.pef"  select="//pef:page[.//text()[contains(.,'⠕⠍⠀⠃⠕⠅⠁')]]"/>
                </x:context>
                <x:expect label="the page should not contain 'Noter er plassert nederst på hver side.'" type="xpath" test="not(contains(replace(string-join(.//text(),'⠀'),'[⠀\s]+','⠀'), '⠠⠝⠕⠞⠑⠗⠀⠑⠗⠀⠏⠇⠁⠎⠎⠑⠗⠞⠀⠝⠑⠙⠑⠗⠎⠞⠀⠏⠡⠀⠓⠧⠑⠗⠀⠎⠊⠙⠑⠄'))"/>
                <x:expect label="the page should contain 'Noter er plassert i slutten av hvert hefte.'" type="xpath" test="contains(replace(string-join(.//text(),'⠀'),'[⠀\s]+','⠀'), '⠠⠝⠕⠞⠑⠗⠀⠑⠗⠀⠏⠇⠁⠎⠎⠑⠗⠞⠀⠊⠀⠎⠇⠥⠞⠞⠑⠝⠀⠁⠧⠀⠓⠧⠑⠗⠞⠀⠓⠑⠋⠞⠑⠄')"/>
            </x:scenario>
            
            <x:scenario label="with notes-placement=end-of-volume">
                <x:call>
                    <x:option name="notes-placement" select="'end-of-volume'"/>
                    <x:option name="pef-output-dir" select="resolve-uri('12/pef-output-dir',$temp-dir)"/>
                    <x:option name="preview-output-dir" select="resolve-uri('12/preview-output-dir',$temp-dir)"/>
                    <x:option name="temp-dir" select="resolve-uri('12/temp-dir',$temp-dir)"/>
                </x:call>
                
                <x:context label="the page containing 'om boka'">
                    <x:document type="file" base-uri="temp-dir" href="12/pef-output-dir/book.pef"  select="//pef:page[.//text()[contains(.,'⠕⠍⠀⠃⠕⠅⠁')]]"/>
                </x:context>
                <x:expect label="the page should contain 'Noter er plassert i slutten av hvert hefte.'" type="xpath" test="contains(replace(string-join(.//text(),'⠀'),'[⠀\s]+','⠀'), '⠠⠝⠕⠞⠑⠗⠀⠑⠗⠀⠏⠇⠁⠎⠎⠑⠗⠞⠀⠊⠀⠎⠇⠥⠞⠞⠑⠝⠀⠁⠧⠀⠓⠧⠑⠗⠞⠀⠓⠑⠋⠞⠑⠄')"/>
            </x:scenario>
            
            <x:scenario label="with notes-placement=end-of-book">
                <x:call>
                    <x:option name="notes-placement" select="'end-of-book'"/>
                    <x:option name="pef-output-dir" select="resolve-uri('13/pef-output-dir',$temp-dir)"/>
                    <x:option name="preview-output-dir" select="resolve-uri('13/preview-output-dir',$temp-dir)"/>
                    <x:option name="temp-dir" select="resolve-uri('13/temp-dir',$temp-dir)"/>
                </x:call>
                
                <x:context label="the page containing 'om boka'">
                    <x:document type="file" base-uri="temp-dir" href="13/pef-output-dir/book.pef"  select="//pef:page[.//text()[contains(.,'⠕⠍⠀⠃⠕⠅⠁')]]"/>
                </x:context>
                <x:expect label="the page should contain 'Noter er plassert bakerst i boken.'" type="xpath" test="contains(replace(string-join(.//text(),'⠀'),'[⠀\s]+','⠀'), '⠠⠝⠕⠞⠑⠗⠀⠑⠗⠀⠏⠇⠁⠎⠎⠑⠗⠞⠀⠃⠁⠅⠑⠗⠎⠞⠀⠊⠀⠃⠕⠅⠑⠝⠄')"/>
            </x:scenario>
        </x:scenario>
    </x:scenario>
    
</x:description>
