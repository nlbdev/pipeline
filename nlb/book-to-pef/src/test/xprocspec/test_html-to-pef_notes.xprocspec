<?xml version="1.0" encoding="UTF-8"?>
<?xml-model href="http://www.daisy.org/ns/xprocspec/xprocspec.rng" type="application/xml" schematypens="http://relaxng.org/ns/structure/1.0"?>
<x:description xmlns:x="http://www.daisy.org/ns/xprocspec"
               xmlns:nlb="http://www.nlb.no/ns/pipeline/xproc"
               xmlns:pef="http://www.daisy.org/ns/2008/pef"
               xmlns:epub="http://www.idpf.org/2007/ops"
               script="http://www.nlb.no/pipeline/modules/braille/html-to-pef.xpl">
    
    <x:scenario label="Automatic numbering of notes">
        <x:call step="nlb:html-to-pef">
            <x:input port="source">
                <x:document type="inline" xml:base="file:///tmp/book.xhtml">
                    <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="no" lang="no">
                        <body>
                            <section epub:type="bodymatter">
                                <h1>abc</h1>
                                <p>aa <a epub:type="noteref" class="noteref" id="noteref_1" href="#note001">*</a> ll</p>
                                <p>bb <a epub:type="noteref" class="noteref" id="noteref_2" href="#note002">*</a> ll</p>
                                <p>cc <a epub:type="noteref" class="noteref" id="noteref_3" href="#note003">*</a> ll</p>
                            </section>
                            
                            <section epub:type="backmatter" class="footnotes">
                                <h1>notes</h1>
                                <aside epub:type="note" class="notebody" id="note001"> <p>* aaa aaa</p> </aside>
                                <aside epub:type="note" class="notebody" id="note002"> <p>* rrr bbb</p> </aside>
                                <aside epub:type="note" class="notebody" id="note003"> <p>* lll lll</p> </aside>
                            </section>
                            
                        </body>
                    </html>
                </x:document>
            </x:input>
            <x:option name="toc-depth" select="0"/>
            <x:option name="hyphenation" select="'false'"/>
            <x:option name="pef-output-dir" select="resolve-uri('notes-numbering/pef-output-dir',$temp-dir)"/>
            <x:option name="preview-output-dir" select="resolve-uri('notes-numbering/preview-output-dir',$temp-dir)"/>
            <x:option name="temp-dir" select="resolve-uri('notes-numbering/temp-dir',$temp-dir)"/>
        </x:call>
        <x:context label="result">
            <x:document type="file" base-uri="temp-dir" href="notes-numbering/pef-output-dir/book.pef" select="(//pef:page)[position() &gt;= last() - 1]"/>
        </x:context>
        <x:expect label="result" type="compare">
            <x:document type="inline">
                            <page xmlns="http://www.daisy.org/ns/2008/pef">
                                <row/>
                                <row/>
                                <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠁⠃⠉</row>
                                <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row/>
                                <row>⠀⠀⠀⠀⠁⠁⠀⠠⠼⠁⠀⠇⠇</row>
                                <row>⠀⠀⠀⠀⠃⠃⠀⠠⠼⠃⠀⠇⠇</row>
                                <row>⠀⠀⠀⠀⠉⠉⠀⠠⠼⠉⠀⠇⠇</row>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                            </page>
            </x:document>
            <x:document type="inline">
                            <page xmlns="http://www.daisy.org/ns/2008/pef">
                                <row/>
                                <row/>
                                <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠋⠕⠞⠝⠕⠞⠑⠗</row>
                                <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row/>
                                <row>⠀⠀⠠⠼⠁⠀⠁⠁⠁⠀⠁⠁⠁</row>
                                <row>⠀⠀⠠⠼⠃⠀⠗⠗⠗⠀⠃⠃⠃</row>
                                <row>⠀⠀⠠⠼⠉⠀⠇⠇⠇⠀⠇⠇⠇</row>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠑⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                            </page>
            </x:document>
        </x:expect>
    </x:scenario>
    
    <x:scenario label="Volume notes">
        <x:call step="nlb:html-to-pef">
            <x:input port="source">
                <x:document type="inline">
                    <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="no" lang="no">
                        <body>
                            <section epub:type="bodymatter">
                                <h1>abc</h1>
                                <span style="display:block; volume-break-before:always"/>
                                <p>aa <a epub:type="noteref" class="noteref" id="noteref_1" href="#note001">*</a> ll</p>
                                <p>bb <a epub:type="noteref" class="noteref" id="noteref_2" href="#note002">*</a> ll</p>
                                <span style="display:block; volume-break-before:always"/>
                                <p>cc <a epub:type="noteref" class="noteref" id="noteref_3" href="#note003">*</a> ll</p>
                            </section>
                            
                            <section epub:type="backmatter" class="footnotes">
                                <h1>notes</h1>
                                <aside epub:type="note" class="notebody" id="note001"> <p>* aaa aaa</p> </aside>
                                <aside epub:type="note" class="notebody" id="note002"> <p>* rrr bbb</p> </aside>
                                <aside epub:type="note" class="notebody" id="note003"> <p>* lll lll</p> </aside>
                            </section>
                            
                        </body>
                    </html>
                </x:document>
            </x:input>
            <x:option name="toc-depth" select="0"/>
            <x:option name="hyphenation" select="'false'"/>
            <x:option name="pef-output-dir" select="resolve-uri('volume-notes/pef-output-dir',$temp-dir)"/>
            <x:option name="preview-output-dir" select="resolve-uri('volume-notes/preview-output-dir',$temp-dir)"/>
            <x:option name="temp-dir" select="resolve-uri('volume-notes/temp-dir',$temp-dir)"/>
        </x:call>
        
        <x:context label="pef">
            <x:document type="file" base-uri="temp-dir" href="volume-notes/pef-output-dir/test_html-to-pef_notes.pef"/>
        </x:context>
        <x:expect label="There should be 3 volumes" type="xpath" test="count(//pef:volume)" equals="3"/>
        
        <x:context label="First volume">
            <x:document type="file" base-uri="temp-dir" href="volume-notes/pef-output-dir/test_html-to-pef_notes.pef" select="(//pef:volume)[1]//pef:section[last()]"/>
        </x:context>
        <x:expect label="result - first volume" type="compare">
            <x:document type="inline">
                        <section xmlns="http://www.daisy.org/ns/2008/pef">
                            <page>
                                <row/>
                                <row/>
                                <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠁⠃⠉</row>
                                <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                            </page>
                        </section>
            </x:document>
        </x:expect>
        
        <x:context label="Second volume">
            <x:document type="file" base-uri="temp-dir" href="volume-notes/pef-output-dir/test_html-to-pef_notes.pef" select="(//pef:volume)[2]//pef:section[position() &gt; 1]"/>
        </x:context>
        <x:expect label="result - second volume" type="compare">
            <x:document type="inline">
                        <section xmlns="http://www.daisy.org/ns/2008/pef">
                            <page>
                                <row>⠀⠀⠀⠀⠁⠁⠀⠠⠼⠁⠀⠇⠇</row>
                                <row>⠀⠀⠀⠀⠃⠃⠀⠠⠼⠃⠀⠇⠇</row>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠛⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                            </page>
                        </section>
            </x:document>
            <x:document type="inline">
                        <section xmlns="http://www.daisy.org/ns/2008/pef">
                            <page>
                                <row/>
                                <row/>
                                <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠋⠕⠞⠝⠕⠞⠑⠗</row>
                                <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row/>
                                <row>⠀⠀⠠⠼⠁⠀⠁⠁⠁⠀⠁⠁⠁</row>
                                <row>⠀⠀⠠⠼⠃⠀⠗⠗⠗⠀⠃⠃⠃</row>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠊⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                            </page>
                        </section>
            </x:document>
        </x:expect>
        
        <x:context label="Third volume">
            <x:document type="file" base-uri="temp-dir" href="volume-notes/pef-output-dir/test_html-to-pef_notes.pef" select="(//pef:volume)[3]//pef:section[position() &gt; 1]"/>
        </x:context>
        <x:expect label="result - third volume" type="compare">
            <x:document type="inline">
                        <section xmlns="http://www.daisy.org/ns/2008/pef">
                            <page>
                                <row>⠀⠀⠀⠀⠉⠉⠀⠠⠼⠉⠀⠇⠇</row>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠁⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                            </page>
                        </section>
            </x:document>
            <x:document type="inline">
                        <section xmlns="http://www.daisy.org/ns/2008/pef">
                            <page>
                                <row/>
                                <row/>
                                <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠋⠕⠞⠝⠕⠞⠑⠗</row>
                                <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row/>
                                <row>⠀⠀⠠⠼⠉⠀⠇⠇⠇⠀⠇⠇⠇</row>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠁⠑⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                            </page>
                        </section>
            </x:document>
        </x:expect>
    </x:scenario>
    
    <x:scenario label="Footnotes">
        <x:call step="nlb:html-to-pef">
            <x:input port="source">
                <x:document type="inline">
                    <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="no" lang="no">
                        <body>
                            <section epub:type="bodymatter">
                                <h1>abc</h1>
                                <p>aa <a epub:type="noteref" id="noteref_1" href="#note001">*</a> ll</p>
                                <p>bb <a epub:type="noteref" id="noteref_2" href="#note002">*</a> ll</p>
                                <span style="display:block; page-break-before:always"/>
                                <p>cc <a epub:type="noteref" id="noteref_3" href="#note003">*</a> ll</p>
                            </section>
                            
                            <section epub:type="backmatter footnotes">
                                <h1>Footnotes</h1>
                                <aside epub:type="footnote" id="note001">
                                    <p>* xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx</p>
                                </aside>
                                <aside epub:type="footnote" id="note002">* yyy yyy yyy yyy yyy yyy yyy yyy yyy yyy yyy yyy yyy</aside>
                                <aside epub:type="footnote" id="note003">
                                    <p>* zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz</p>
                                    <p>zzz zzz zzz</p>
                                </aside>
                            </section>
                            
                        </body>
                    </html>
                </x:document>
            </x:input>
            <x:option name="toc-depth" select="0"/>
            <x:option name="hyphenation" select="'false'"/>
            <x:option name="notes-placement" select="'bottom-of-page'"/>
            <x:option name="pef-output-dir" select="resolve-uri('footnotes/pef-output-dir',$temp-dir)"/>
            <x:option name="preview-output-dir" select="resolve-uri('footnotes/preview-output-dir',$temp-dir)"/>
            <x:option name="temp-dir" select="resolve-uri('footnotes/temp-dir',$temp-dir)"/>
        </x:call>
        
        <x:context label="result">
            <x:document type="file" base-uri="temp-dir" href="footnotes/pef-output-dir/test_html-to-pef_notes.pef" select="(//pef:section)[last()]"/>
        </x:context>
        <x:expect label="result - second volume" type="compare">
            <x:document type="inline">
                        <section xmlns="http://www.daisy.org/ns/2008/pef">
                            <page>
                                <row/>
                                <row/>
                                <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠁⠃⠉</row>
                                <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row/>
                                <row>⠀⠀⠀⠀⠁⠁⠀⠠⠼⠁⠀⠇⠇</row>
                                <row>⠀⠀⠀⠀⠃⠃⠀⠠⠼⠃⠀⠇⠇</row>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                                <row>⠀⠀⠠⠼⠁⠀⠭⠭⠭⠭⠭⠭⠀⠭⠭⠭⠭⠭⠭⠀⠭⠭⠭⠭⠭⠭</row>
                                <row>⠀⠀⠀⠀⠭⠭⠭⠭⠭⠭⠀⠭⠭⠭⠭⠭⠭⠀⠭⠭⠭⠭⠭⠭⠀⠭⠭⠭⠭⠭⠭</row>
                                <row>⠀⠀⠀⠀⠭⠭⠭⠭⠭⠭⠀⠭⠭⠭⠭⠭⠭⠀⠭⠭⠭⠭⠭⠭⠀⠭⠭⠭⠭⠭⠭</row>
                                <row>⠀⠀⠠⠼⠃⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽</row>
                                <row>⠀⠀⠀⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽</row>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                            </page>
                            <page>
                                <row>⠀⠀⠀⠀⠉⠉⠀⠠⠼⠉⠀⠇⠇</row>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                                <row>⠀⠀⠠⠼⠉⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵</row>
                                <row>⠀⠀⠀⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵</row>
                                <row>⠀⠀⠀⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵</row>
                                <row>⠀⠀⠀⠀⠀⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵</row>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠙⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                            </page>
                        </section>
            </x:document>
        </x:expect>
    </x:scenario>
    
    <x:scenario label="Notes at end of book">
        <x:scenario label="aside notes">
            <x:call step="nlb:html-to-pef">
                <x:input port="source">
                    <x:document type="inline">
                        <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="no" lang="no">
                            <body>
                                <section epub:type="bodymatter chapter">
                                    <h1>Chapter 1</h1>
                                    <p>First <a epub:type="noteref" class="noteref" id="noteref_1" href="#note001">*</a> paragraph.</p>
                                    <p>Second <a epub:type="noteref" class="noteref" id="noteref_2" href="#note002">*</a> paragraph.</p>
                                    <span style="display:block; volume-break-before:always"/>
                                    <p>Third <a epub:type="noteref" class="noteref" id="noteref_3" href="#note003">*</a> paragraph.</p>
                                </section>
                                
                                <section epub:type="backmatter endnotes">
                                    <h1>Endnotes</h1>
                                    <aside epub:type="endnote" id="note001">
                                        <p>* xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx</p>
                                    </aside>
                                    <aside epub:type="endnote" id="note002">* yyy yyy yyy yyy yyy yyy yyy yyy yyy yyy yyy yyy yyy yyy yyy yyy yyy yyy yyy yyy</aside>
                                    <aside epub:type="endnote" id="note003">
                                        <p>* zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz</p>
                                        <p>zzz zzz zzz</p>
                                        <p>zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz</p>
                                    </aside>
                                </section>
                            </body>
                        </html>
                    </x:document>
                </x:input>
                <x:option name="toc-depth" select="0"/>
                <x:option name="hyphenation" select="'false'"/>
                <x:option name="notes-placement" select="'end-of-book'"/>
                <x:option name="pef-output-dir" select="resolve-uri('end-of-book-notes_aside/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('end-of-book-notes_aside/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('end-of-book-notes_aside/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="pef">
                <x:document type="file" base-uri="temp-dir" href="end-of-book-notes_aside/pef-output-dir/test_html-to-pef_notes.pef"/>
            </x:context>
            <x:expect label="There should be 2 volumes" type="xpath" test="count(//pef:volume)" equals="2"/>
            
            <x:context label="First volume">
                <x:document type="file" base-uri="temp-dir" href="end-of-book-notes_aside/pef-output-dir/test_html-to-pef_notes.pef" select="(//pef:volume)[1]//pef:section[last()]"/>
            </x:context>
            <x:expect label="result - first volume" type="compare">
                <x:document type="inline">
                            <section xmlns="http://www.daisy.org/ns/2008/pef">
                                <page>
                                    <row/>
                                    <row/>
                                    <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                    <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠉⠓⠁⠏⠞⠑⠗⠀⠼⠁</row>
                                    <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                    <row/>
                                    <row>⠀⠀⠀⠀⠠⠋⠊⠗⠎⠞⠀⠠⠼⠁⠀⠏⠁⠗⠁⠛⠗⠁⠏⠓⠄</row>
                                    <row>⠀⠀⠀⠀⠠⠎⠑⠉⠕⠝⠙⠀⠠⠼⠃⠀⠏⠁⠗⠁⠛⠗⠁⠏⠓⠄</row>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                                </page>
                            </section>
                </x:document>
            </x:expect>
            
            <x:context label="Second volume">
                <x:document type="file" base-uri="temp-dir" href="end-of-book-notes_aside/pef-output-dir/test_html-to-pef_notes.pef" select="(//pef:volume)[2]//pef:section[position() &gt; 1]"/>
            </x:context>
                
                <x:expect label="result - second volume" type="compare">
                    <x:document type="inline" select="/*/*">
                        <_ xmlns="http://www.daisy.org/ns/2008/pef">
                            <section>
                                <page>
                                    <row>⠀⠀⠀⠀⠠⠞⠓⠊⠗⠙⠀⠠⠼⠉⠀⠏⠁⠗⠁⠛⠗⠁⠏⠓⠄</row>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠛⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                                </page>
                            </section>
                            <section>
                                <page>
                                    <row/>
                                    <row/>
                                    <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                    <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠋⠕⠞⠝⠕⠞⠑⠗</row>
                                    <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                    <row/>
                                    <row>⠀⠀⠠⠼⠁⠀⠭⠭⠭⠭⠭⠭⠀⠭⠭⠭⠭⠭⠭⠀⠭⠭⠭⠭⠭⠭</row>
                                    <row>⠀⠀⠀⠀⠭⠭⠭⠭⠭⠭⠀⠭⠭⠭⠭⠭⠭⠀⠭⠭⠭⠭⠭⠭⠀⠭⠭⠭⠭⠭⠭</row>
                                    <row>⠀⠀⠀⠀⠭⠭⠭⠭⠭⠭⠀⠭⠭⠭⠭⠭⠭⠀⠭⠭⠭⠭⠭⠭⠀⠭⠭⠭⠭⠭⠭</row>
                                    <row>⠀⠀⠀⠀⠭⠭⠭⠭⠭⠭⠀⠭⠭⠭⠭⠭⠭⠀⠭⠭⠭⠭⠭⠭⠀⠭⠭⠭⠭⠭⠭</row>
                                    <row>⠀⠀⠀⠀⠭⠭⠭⠭⠭⠭</row>
                                    <row>⠀⠀⠠⠼⠃⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽</row>
                                    <row>⠀⠀⠀⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽</row>
                                    <row>⠀⠀⠀⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽</row>
                                    <row>⠀⠀⠠⠼⠉⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵</row>
                                    <row>⠀⠀⠀⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵</row>
                                    <row>⠀⠀⠀⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵</row>
                                    <row>⠀⠀⠀⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵</row>
                                    <row>⠀⠀⠀⠀⠀⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵</row>
                                    <row>⠀⠀⠀⠀⠀⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵</row>
                                    <row>⠀⠀⠀⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵</row>
                                    <row>⠀⠀⠀⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵</row>
                                    <row>⠀⠀⠀⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵</row>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row/>
                                    <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠊⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                                </page>
                            </section>
                        </_>
                </x:document>
            </x:expect>
        </x:scenario>
        
        <x:scenario label="list notes">
            <x:call step="nlb:html-to-pef">
                <x:input port="source">
                    <x:document type="inline">
                        <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="no" lang="no">
                            <body>
                                <section epub:type="bodymatter chapter">
                                    <h1>Chapter 1</h1>
                                    <p>First <a epub:type="noteref" class="noteref" id="noteref_1" href="#note001">*</a> paragraph.</p>
                                    <p>Second <a epub:type="noteref" class="noteref" id="noteref_2" href="#note002">*</a> paragraph.</p>
                                    <span style="display:block; volume-break-before:always"/>
                                    <p>Third <a epub:type="noteref" class="noteref" id="noteref_3" href="#note003">*</a> paragraph.</p>
                                </section>
                                
                                <section epub:type="backmatter endnotes">
                                    <h1>Endnotes</h1>
                                    <ol>
                                       <li epub:type="endnote" id="note001">
                                           <p>* xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx</p>
                                       </li>
                                       <li epub:type="endnote" id="note002">* yyy yyy yyy yyy yyy yyy yyy yyy yyy yyy yyy yyy yyy yyy yyy yyy yyy yyy yyy yyy</li>
                                       <li epub:type="endnote" id="note003">
                                           <p>* zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz</p>
                                           <p>zzz zzz zzz</p>
                                           <p>zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz zzz</p>
                                       </li>
                                    </ol>
                                </section>
                            </body>
                        </html>
                    </x:document>
                </x:input>
                <x:option name="toc-depth" select="0"/>
                <x:option name="hyphenation" select="'false'"/>
                <x:option name="notes-placement" select="'end-of-book'"/>
                <x:option name="pef-output-dir" select="resolve-uri('end-of-book-notes_list/pef-output-dir',$temp-dir)"/>
                <x:option name="preview-output-dir" select="resolve-uri('end-of-book-notes_list/preview-output-dir',$temp-dir)"/>
                <x:option name="temp-dir" select="resolve-uri('end-of-book-notes_list/temp-dir',$temp-dir)"/>
            </x:call>
            
            <x:context label="pef">
                <x:document type="file" base-uri="temp-dir" href="end-of-book-notes_list/pef-output-dir/test_html-to-pef_notes.pef"/>
            </x:context>
            <x:expect label="There should be 2 volumes" type="xpath" test="count(//pef:volume)" equals="2"/>
            
            <x:context label="First volume">
                <x:document type="file" base-uri="temp-dir" href="end-of-book-notes_list/pef-output-dir/test_html-to-pef_notes.pef" select="(//pef:volume)[1]//pef:section[last()]"/>
            </x:context>
            <x:expect label="result - first volume" type="compare">
                <x:document type="inline">
                    <section xmlns="http://www.daisy.org/ns/2008/pef">
                        <page>
                            <row/>
                            <row/>
                            <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                            <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠉⠓⠁⠏⠞⠑⠗⠀⠼⠁</row>
                            <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                            <row/>
                            <row>⠀⠀⠀⠀⠠⠋⠊⠗⠎⠞⠀⠠⠼⠁⠀⠏⠁⠗⠁⠛⠗⠁⠏⠓⠄</row>
                            <row>⠀⠀⠀⠀⠠⠎⠑⠉⠕⠝⠙⠀⠠⠼⠃⠀⠏⠁⠗⠁⠛⠗⠁⠏⠓⠄</row>
                            <row/>
                            <row/>
                            <row/>
                            <row/>
                            <row/>
                            <row/>
                            <row/>
                            <row/>
                            <row/>
                            <row/>
                            <row/>
                            <row/>
                            <row/>
                            <row/>
                            <row/>
                            <row/>
                            <row/>
                            <row/>
                            <row/>
                            <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                        </page>
                    </section>
                </x:document>
            </x:expect>
            
            <x:context label="Second volume">
                <x:document type="file" base-uri="temp-dir" href="end-of-book-notes_list/pef-output-dir/test_html-to-pef_notes.pef" select="(//pef:volume)[2]//pef:section[position() &gt; 1]"/>
            </x:context>
            
            <x:expect label="result - second volume" type="compare">
                <x:document type="inline" select="/*/*">
                    <_ xmlns="http://www.daisy.org/ns/2008/pef">
                        <section>
                            <page>
                                <row>⠀⠀⠀⠀⠠⠞⠓⠊⠗⠙⠀⠠⠼⠉⠀⠏⠁⠗⠁⠛⠗⠁⠏⠓⠄</row>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠛⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                            </page>
                        </section>
                        <section>
                            <page>
                                <row/>
                                <row/>
                                <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠋⠕⠞⠝⠕⠞⠑⠗</row>
                                <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                                <row/>
                                <row>⠀⠀⠠⠼⠁⠀⠭⠭⠭⠭⠭⠭⠀⠭⠭⠭⠭⠭⠭⠀⠭⠭⠭⠭⠭⠭</row>
                                <row>⠀⠀⠀⠀⠭⠭⠭⠭⠭⠭⠀⠭⠭⠭⠭⠭⠭⠀⠭⠭⠭⠭⠭⠭⠀⠭⠭⠭⠭⠭⠭</row>
                                <row>⠀⠀⠀⠀⠭⠭⠭⠭⠭⠭⠀⠭⠭⠭⠭⠭⠭⠀⠭⠭⠭⠭⠭⠭⠀⠭⠭⠭⠭⠭⠭</row>
                                <row>⠀⠀⠀⠀⠭⠭⠭⠭⠭⠭⠀⠭⠭⠭⠭⠭⠭⠀⠭⠭⠭⠭⠭⠭⠀⠭⠭⠭⠭⠭⠭</row>
                                <row>⠀⠀⠀⠀⠭⠭⠭⠭⠭⠭</row>
                                <row>⠀⠀⠠⠼⠃⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽</row>
                                <row>⠀⠀⠀⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽</row>
                                <row>⠀⠀⠀⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽⠀⠽⠽⠽</row>
                                <row>⠀⠀⠠⠼⠉⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵</row>
                                <row>⠀⠀⠀⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵</row>
                                <row>⠀⠀⠀⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵</row>
                                <row>⠀⠀⠀⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵</row>
                                <row>⠀⠀⠀⠀⠀⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵</row>
                                <row>⠀⠀⠀⠀⠀⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵</row>
                                <row>⠀⠀⠀⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵</row>
                                <row>⠀⠀⠀⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵</row>
                                <row>⠀⠀⠀⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵⠀⠵⠵⠵</row>
                                <row/>
                                <row/>
                                <row/>
                                <row/>
                                <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠊⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                            </page>
                        </section>
                    </_>
                </x:document>
            </x:expect>
        </x:scenario>
    </x:scenario>
    
    <x:scenario label="Notes fallback mechanism">
        <x:call step="nlb:html-to-pef">
            <x:input port="source">
                <x:document type="inline">
                    <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="no" lang="no">
                        <body>
                            <section epub:type="bodymatter">
                                <h1>abc</h1>
                                <p>aa <a epub:type="noteref" class="noteref" id="noteref_1" href="#note001">*</a> ll</p>
                                <p>bb <a epub:type="noteref" class="noteref" id="noteref_2" href="#note002">*</a> ll</p>
                                <p>cc <a epub:type="noteref" class="noteref" id="noteref_3" href="#note003">*</a> ll</p>
                            </section>
                            
                            <section epub:type="backmatter" class="footnotes">
                                <h1>notes</h1>
                                <aside epub:type="note" class="notebody" id="note001"> <p>* aaa aaa</p> </aside>
                                <aside epub:type="note" class="notebody" id="note002"> <p>* rrr bbb</p> </aside>
                                <aside epub:type="note" class="notebody" id="note003">
                                    <p>* lll lll lll lll lll lll lll lll lll lll lll lll
                                        lll lll lll lll lll lll lll lll lll lll lll lll lll
                                        lll lll lll lll lll lll lll lll lll lll lll lll lll
                                        lll lll lll lll lll lll lll lll lll lll lll lll lll
                                        lll lll lll lll lll lll lll lll lll lll lll lll lll
                                        lll lll lll lll lll lll lll lll lll lll lll lll lll
                                        lll lll lll lll lll lll lll lll lll lll lll lll lll</p>
                                </aside>
                            </section>
                            
                        </body>
                    </html>
                </x:document>
            </x:input>
            <x:option name="toc-depth" select="0"/>
            <x:option name="hyphenation" select="'false'"/>
            <x:option name="notes-placement" select="'bottom-of-page'"/>
            <x:option name="pef-output-dir" select="resolve-uri('notes-fallback/pef-output-dir',$temp-dir)"/>
            <x:option name="preview-output-dir" select="resolve-uri('notes-fallback/preview-output-dir',$temp-dir)"/>
            <x:option name="temp-dir" select="resolve-uri('notes-fallback/temp-dir',$temp-dir)"/>
        </x:call>
        <x:context label="result">
            <x:document type="file" base-uri="temp-dir" href="notes-fallback/pef-output-dir/test_html-to-pef_notes.pef" select="//pef:section[position() &gt; 1]"/>
        </x:context>
        <x:expect label="result" type="compare">
           <x:document type="inline" select="/*/*">
              <_ xmlns="http://www.daisy.org/ns/2008/pef">
                 <section>
                    <page>
                       <row/>
                       <row/>
                       <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                       <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠁⠃⠉</row>
                       <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                       <row/>
                       <row>⠀⠀⠀⠀⠁⠁⠀⠠⠼⠁⠀⠇⠇</row>
                       <row>⠀⠀⠀⠀⠃⠃⠀⠠⠼⠃⠀⠇⠇</row>
                       <row>⠀⠀⠀⠀⠉⠉⠀⠠⠼⠉⠀⠇⠇</row>
                       <row/>
                       <row/>
                       <row/>
                       <row/>
                       <row/>
                       <row/>
                       <row/>
                       <row/>
                       <row/>
                       <row/>
                       <row/>
                       <row/>
                       <row/>
                       <row/>
                       <row/>
                       <row/>
                       <row/>
                       <row/>
                       <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                    </page>
                 </section>
                 <section>
                    <page>
                       <row/>
                       <row/>
                       <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                       <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠋⠕⠞⠝⠕⠞⠑⠗</row>
                       <row>⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉</row>
                       <row/>
                       <row>⠀⠀⠠⠼⠁⠀⠁⠁⠁⠀⠁⠁⠁</row>
                       <row>⠀⠀⠠⠼⠃⠀⠗⠗⠗⠀⠃⠃⠃</row>
                       <row>⠀⠀⠠⠼⠉⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇</row>
                       <row>⠀⠀⠀⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇</row>
                       <row>⠀⠀⠀⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇</row>
                       <row>⠀⠀⠀⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇</row>
                       <row>⠀⠀⠀⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇</row>
                       <row>⠀⠀⠀⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇</row>
                       <row>⠀⠀⠀⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇</row>
                       <row>⠀⠀⠀⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇</row>
                       <row>⠀⠀⠀⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇</row>
                       <row>⠀⠀⠀⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇</row>
                       <row>⠀⠀⠀⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇</row>
                       <row>⠀⠀⠀⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇</row>
                       <row>⠀⠀⠀⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇⠀⠇⠇⠇</row>
                       <row/>
                       <row/>
                       <row/>
                       <row/>
                       <row/>
                       <row/>
                       <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠑⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                    </page>
                 </section>
              </_>
           </x:document>
        </x:expect>
     </x:scenario>
    
    <x:scenario label="test for text describing placement of notes in generated content ('om boka')">
        <x:call step="nlb:html-to-pef">
            <x:option name="hyphenation" select="'false'"/>
        </x:call>
        
        <x:scenario label="small notes">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="no" lang="no">
                            <head>
                                <meta name="dtb:uid" content="123456"/>
                                <meta name="dc:Title" content="dc:Title"/>
                                <meta name="dc:Creator" content="dc:Creator"/>
                            </head>
                            <body>
                                
                                <section epub:type="frontmatter titlepage">
                                    <h1 epub:type="fulltitle" class="title">doctitle</h1>
                                    <p epub:type="z3998:author" class="docauthor">docauthor</p>
                                </section>
                                <section epub:type="bodymatter">
                                    <h1>h1</h1>
                                    <p>NLB<a epub:type="noteref" class="noteref" href="#smallnote">1</a> cooperates both nationally and internationally with other producers of adapted literature.</p>
                                    <aside epub:type="note" class="notebody" id="smallnote">
                                        <span>NLB is a state library under the Ministry of culture. The library offers a free, nation-wide service.</span>
                                    </aside>
                                </section>
                            </body>
                        </html>
                    </x:document>
                </x:input>
            </x:call>
            
            <x:scenario label="with notes-placement=bottom-of-page">
                <x:call>
                    <x:option name="notes-placement" select="'bottom-of-page'"/>
                    <x:option name="pef-output-dir" select="resolve-uri('8/pef-output-dir',$temp-dir)"/>
                    <x:option name="preview-output-dir" select="resolve-uri('8/preview-output-dir',$temp-dir)"/>
                    <x:option name="temp-dir" select="resolve-uri('8/temp-dir',$temp-dir)"/>
                </x:call>
                
                <x:context label="the page containing 'om boka'">
                    <x:document type="file" base-uri="temp-dir" href="8/pef-output-dir/book.pef" select="//pef:page[.//text()[contains(.,'⠕⠍⠀⠃⠕⠅⠁')]]"/>
                </x:context>
                <x:expect label="the page should contain 'Noter er plassert nederst på hver side.'" type="xpath" test="contains(replace(string-join(.//text(),'⠀'),'[⠀\s]+','⠀'), '⠠⠝⠕⠞⠑⠗⠀⠑⠗⠀⠏⠇⠁⠎⠎⠑⠗⠞⠀⠝⠑⠙⠑⠗⠎⠞⠀⠏⠡⠀⠓⠧⠑⠗⠀⠎⠊⠙⠑⠄')"/>
            </x:scenario>
            
            <x:scenario label="with notes-placement=end-of-volume">
                <x:call>
                    <x:option name="notes-placement" select="'end-of-volume'"/>
                    <x:option name="pef-output-dir" select="resolve-uri('9/pef-output-dir',$temp-dir)"/>
                    <x:option name="preview-output-dir" select="resolve-uri('9/preview-output-dir',$temp-dir)"/>
                    <x:option name="temp-dir" select="resolve-uri('9/temp-dir',$temp-dir)"/>
                </x:call>
                
                <x:context label="the page containing 'om boka'">
                    <x:document type="file" base-uri="temp-dir" href="9/pef-output-dir/book.pef" select="//pef:page[.//text()[contains(.,'⠕⠍⠀⠃⠕⠅⠁')]]"/>
                </x:context>
                <x:expect label="the page should contain 'Noter er plassert i slutten av hvert hefte.'" type="xpath" test="contains(replace(string-join(.//text(),'⠀'),'[⠀\s]+','⠀'), '⠠⠝⠕⠞⠑⠗⠀⠑⠗⠀⠏⠇⠁⠎⠎⠑⠗⠞⠀⠊⠀⠎⠇⠥⠞⠞⠑⠝⠀⠁⠧⠀⠓⠧⠑⠗⠞⠀⠓⠑⠋⠞⠑⠄')"/>
            </x:scenario>
            
            <x:scenario label="with notes-placement=end-of-book">
                <x:call>
                    <x:option name="notes-placement" select="'end-of-book'"/>
                    <x:option name="pef-output-dir" select="resolve-uri('10/pef-output-dir',$temp-dir)"/>
                    <x:option name="preview-output-dir" select="resolve-uri('10/preview-output-dir',$temp-dir)"/>
                    <x:option name="temp-dir" select="resolve-uri('10/temp-dir',$temp-dir)"/>
                </x:call>
                
                <x:context label="the page containing 'om boka'">
                    <x:document type="file" base-uri="temp-dir" href="10/pef-output-dir/book.pef" select="//pef:page[.//text()[contains(.,'⠕⠍⠀⠃⠕⠅⠁')]]"/>
                </x:context>
                <x:expect label="the page should contain 'Noter er plassert bakerst i boken.'" type="xpath" test="contains(replace(string-join(.//text(),'⠀'),'[⠀\s]+','⠀'), '⠠⠝⠕⠞⠑⠗⠀⠑⠗⠀⠏⠇⠁⠎⠎⠑⠗⠞⠀⠃⠁⠅⠑⠗⠎⠞⠀⠊⠀⠃⠕⠅⠑⠝⠄')"/>
            </x:scenario>
        </x:scenario>
        
        <x:scenario label="big notes">
            <x:call>
                <x:input port="source">
                    <x:document type="inline" xml:base="file:/tmp/book.xml">
                        <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="no" lang="no">
                            <head>
                                <meta name="dtb:uid" content="123456"/>
                                <meta name="dc:Title" content="dc:Title"/>
                                <meta name="dc:Creator" content="dc:Creator"/>
                            </head>
                            <body>
                                
                                <section epub:type="frontmatter titlepage">
                                    <h1 epub:type="fulltitle" class="title">doctitle</h1>
                                    <p epub:type="z3998:author" class="docauthor">docauthor</p>
                                </section>
                                <section epub:type="bodymatter">
                                    <h1>h1</h1>
                                    <p>NLB<a epub:type="noteref" class="noteref" href="#bignote">1</a> cooperates both nationally and internationally with other producers of adapted literature.</p>
                                    <aside epub:type="note" class="notebody" id="bignote">
                                        <span>The Norwegian Library of Talking Books and Braille (NLB) produces and lends out talking books and braille books. We have books for children as well as adults.</span>
                                        <span>NLB works to ensure that everyone has equal access to literature and information. Our main task is to enable persons with print disabilities  to participate in society on an equal footing with others.</span>
                                        <span>NLB is a state library under the Ministry of culture. The library offers a free, nation-wide service.</span>
                                    </aside>
                                </section>
                            </body>
                        </html>
                    </x:document>
                </x:input>
            </x:call>
            
            <x:scenario label="with notes-placement=bottom-of-page">
                <x:call>
                    <x:option name="notes-placement" select="'bottom-of-page'"/>
                    <x:option name="pef-output-dir" select="resolve-uri('11/pef-output-dir',$temp-dir)"/>
                    <x:option name="preview-output-dir" select="resolve-uri('11/preview-output-dir',$temp-dir)"/>
                    <x:option name="temp-dir" select="resolve-uri('11/temp-dir',$temp-dir)"/>
                </x:call>
                
                <x:context label="the page containing 'om boka'">
                    <x:document type="file" base-uri="temp-dir" href="11/pef-output-dir/book.pef" select="//pef:page[.//text()[contains(.,'⠕⠍⠀⠃⠕⠅⠁')]]"/>
                </x:context>
                <x:expect label="the page should not contain 'Noter er plassert nederst på hver side.'" type="xpath" test="not(contains(replace(string-join(.//text(),'⠀'),'[⠀\s]+','⠀'), '⠠⠝⠕⠞⠑⠗⠀⠑⠗⠀⠏⠇⠁⠎⠎⠑⠗⠞⠀⠝⠑⠙⠑⠗⠎⠞⠀⠏⠡⠀⠓⠧⠑⠗⠀⠎⠊⠙⠑⠄'))"/>
                <x:expect label="the page should contain 'Noter er plassert i slutten av hvert hefte.'" type="xpath" test="contains(replace(string-join(.//text(),'⠀'),'[⠀\s]+','⠀'), '⠠⠝⠕⠞⠑⠗⠀⠑⠗⠀⠏⠇⠁⠎⠎⠑⠗⠞⠀⠊⠀⠎⠇⠥⠞⠞⠑⠝⠀⠁⠧⠀⠓⠧⠑⠗⠞⠀⠓⠑⠋⠞⠑⠄')"/>
            </x:scenario>
            
            <x:scenario label="with notes-placement=end-of-volume">
                <x:call>
                    <x:option name="notes-placement" select="'end-of-volume'"/>
                    <x:option name="pef-output-dir" select="resolve-uri('12/pef-output-dir',$temp-dir)"/>
                    <x:option name="preview-output-dir" select="resolve-uri('12/preview-output-dir',$temp-dir)"/>
                    <x:option name="temp-dir" select="resolve-uri('12/temp-dir',$temp-dir)"/>
                </x:call>
                
                <x:context label="the page containing 'om boka'">
                    <x:document type="file" base-uri="temp-dir" href="12/pef-output-dir/book.pef" select="//pef:page[.//text()[contains(.,'⠕⠍⠀⠃⠕⠅⠁')]]"/>
                </x:context>
                <x:expect label="the page should contain 'Noter er plassert i slutten av hvert hefte.'" type="xpath" test="contains(replace(string-join(.//text(),'⠀'),'[⠀\s]+','⠀'), '⠠⠝⠕⠞⠑⠗⠀⠑⠗⠀⠏⠇⠁⠎⠎⠑⠗⠞⠀⠊⠀⠎⠇⠥⠞⠞⠑⠝⠀⠁⠧⠀⠓⠧⠑⠗⠞⠀⠓⠑⠋⠞⠑⠄')"/>
            </x:scenario>
            
            <x:scenario label="with notes-placement=end-of-book">
                <x:call>
                    <x:option name="notes-placement" select="'end-of-book'"/>
                    <x:option name="pef-output-dir" select="resolve-uri('13/pef-output-dir',$temp-dir)"/>
                    <x:option name="preview-output-dir" select="resolve-uri('13/preview-output-dir',$temp-dir)"/>
                    <x:option name="temp-dir" select="resolve-uri('13/temp-dir',$temp-dir)"/>
                </x:call>
                
                <x:context label="the page containing 'om boka'">
                    <x:document type="file" base-uri="temp-dir" href="13/pef-output-dir/book.pef" select="//pef:page[.//text()[contains(.,'⠕⠍⠀⠃⠕⠅⠁')]]"/>
                </x:context>
                <x:expect label="the page should contain 'Noter er plassert bakerst i boken.'" type="xpath" test="contains(replace(string-join(.//text(),'⠀'),'[⠀\s]+','⠀'), '⠠⠝⠕⠞⠑⠗⠀⠑⠗⠀⠏⠇⠁⠎⠎⠑⠗⠞⠀⠃⠁⠅⠑⠗⠎⠞⠀⠊⠀⠃⠕⠅⠑⠝⠄')"/>
            </x:scenario>
        </x:scenario>
    </x:scenario>
    
</x:description>
